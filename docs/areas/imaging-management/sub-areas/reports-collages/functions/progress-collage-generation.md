# Progress Collage Generation

> **Sub-Area**: [Reports & Collages](../) | **Status**: ðŸ“‹ Planned | **Priority**: Critical

---

## Overview

Progress Collage Generation automatically creates treatment progress collages from milestone images. The system provides template-based generation with AI-powered image selection, milestone-to-image mapping, batch generation for multiple patients, and scheduled auto-generation for ongoing documentation.

---

## Core Requirements

- [ ] Automatically select images from treatment timeline
- [ ] Generate collages from predefined templates
- [ ] Map milestones to appropriate images
- [ ] Support batch generation for multiple patients
- [ ] Implement AI-powered "best image" selection
- [ ] Filter images by quality score threshold
- [ ] Enable date range selection for progress periods
- [ ] Group images by treatment phase
- [ ] Provide one-click generation workflow
- [ ] Schedule automatic generation (monthly, quarterly)

---

## API Endpoints

| Method | Path | Permission | Description |
|--------|------|------------|-------------|
| POST | `/api/imaging/collages/auto-generate` | `imaging:export` | AI-powered auto-generation |
| POST | `/api/imaging/collages/batch-generate` | `imaging:admin` | Batch generate for patients |
| GET | `/api/imaging/collages/:patientId` | `imaging:view` | List patient collages |
| GET | `/api/imaging/collages/:id` | `imaging:view` | Get collage details |
| POST | `/api/imaging/collages` | `imaging:export` | Create collage manually |
| PUT | `/api/imaging/collages/:id` | `imaging:export` | Update collage |
| POST | `/api/imaging/collages/:id/generate` | `imaging:export` | Render collage image |
| GET | `/api/imaging/collages/:id/pdf` | `imaging:export` | Download PDF |
| GET | `/api/imaging/collages/schedule` | `imaging:admin` | Get generation schedule |
| PUT | `/api/imaging/collages/schedule` | `imaging:admin` | Update generation schedule |

---

## Data Model

```prisma
model Collage {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId      String   @db.ObjectId
  patientId     String   @db.ObjectId
  templateId    String?  @db.ObjectId
  name          String
  type          CollageType @default(PROGRESS)
  status        CollageStatus @default(DRAFT)

  // Content - resolved elements with actual image IDs
  elements      Json

  // Generated outputs
  renderedUrl   String?          // Generated collage image URL
  pdfUrl        String?          // PDF version URL

  // Dimensions
  width         Int
  height        Int
  orientation   Orientation @default(PORTRAIT)

  // Date range (for progress collages)
  dateFrom      DateTime?
  dateTo        DateTime?

  // Linked treatment
  treatmentId   String?  @db.ObjectId

  // Sharing
  isShared      Boolean @default(false)
  shareToken    String? @unique
  shareExpiresAt DateTime?
  sharedWithPatient Boolean @default(false)

  // Generation metadata
  autoGenerated Boolean @default(false)
  aiImageSelection Boolean @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  generatedAt   DateTime?
  createdBy     String   @db.ObjectId

  clinic        Clinic   @relation(fields: [clinicId], references: [id])
  patient       Patient  @relation(fields: [patientId], references: [id])
  template      CollageTemplate? @relation(fields: [templateId], references: [id])
  @@index([clinicId])
  @@index([patientId])
  @@index([treatmentId])
  @@index([status])
}

enum CollageType {
  PROGRESS
  BEFORE_AFTER
  RECORDS
  REFERRAL
  CUSTOM
}

enum CollageStatus {
  DRAFT
  GENERATED
  EXPORTED
  SHARED
}

enum Orientation {
  PORTRAIT
  LANDSCAPE
}

model CollageSchedule {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId      String   @db.ObjectId
  name          String
  templateId    String   @db.ObjectId
  frequency     ScheduleFrequency
  dayOfMonth    Int?             // For monthly
  dayOfWeek     Int?             // For weekly
  isActive      Boolean @default(true)
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  targetCriteria Json             // Which patients to include
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic        Clinic   @relation(fields: [clinicId], references: [id])
  @@index([clinicId])
}

enum ScheduleFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
}
```

---

## Business Rules

- Auto-generation uses treatment timeline for image selection
- AI selects sharpest, best-lit image per category
- Quality threshold filters out images below score (default: 70)
- Missing required images shows placeholder with warning
- Batch generation queued as background job
- Generated collages cached; re-generation clears cache
- Scheduled generation targets active treatment patients only

---

## Dependencies

**Depends On:**
- Auth & Authorization (export permissions)
- Collage Template Builder (templates)
- Treatment Phase Linking (milestone images)
- Image Categorization (image type matching)

**Required By:**
- Patient portal (patient-visible collages)
- Treatment documentation workflows
- Patient Communication

---

## Notes

- AI image selection criteria: sharpness, exposure, composition, face detection
- Consider parallel rendering for batch generation performance
- PDF generation via Puppeteer or similar headless browser
- Progressive JPEG for web-optimized collage images

---

**Status Legend:**
- ðŸ“‹ Planned - Documented, not started
- ðŸ”„ In Progress - Currently being implemented
- âœ… Completed - Fully implemented and tested
