generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// =============================================================================
// AUTH AREA - Core authentication and authorization models
// =============================================================================

/// Clinic - Multi-tenant isolation unit
model Clinic {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String   @unique
  address   String?
  phone     String?
  email     String?
  timezone  String   @default("America/Toronto")
  settings  Json?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  patients        Patient[]
  roleAssignments RoleAssignment[]
  transfersFrom   InventoryTransfer[] @relation("TransfersFrom")
  transfersTo     InventoryTransfer[] @relation("TransfersTo")

  // Booking relations
  appointmentTypes AppointmentType[]
  appointments     Appointment[]

  // Waitlist & Recovery relations
  waitlistEntries            WaitlistEntry[]
  appointmentCancellations   AppointmentCancellation[]
  patientRiskScores          PatientRiskScore[]

  // Emergency & Reminders relations
  emergencyAppointments      EmergencyAppointment[]
  onCallSchedules            OnCallSchedule[]
  onCallSwapRequests         OnCallSwapRequest[]
  reminderTemplates          ReminderTemplate[]
  reminderSequences          ReminderSequence[]
  appointmentReminders       AppointmentReminder[]
  afterHoursMessages         AfterHoursMessage[]
  afterHoursSettings         AfterHoursSettings?
  emergencyProtocols         EmergencyProtocol[]
  emergencyFAQs              EmergencyFAQ[]

  // Advanced Scheduling relations
  providerSchedules          ProviderSchedule[]
  scheduleBlocks             ScheduleBlock[]
  bookingTemplates           BookingTemplate[]
  templateApplications       TemplateApplication[]
  recurringAppointments      RecurringAppointment[]
  recurringOccurrences       RecurringOccurrence[]
  openingNotifications       OpeningNotification[]
  reEngagementCampaigns      ReEngagementCampaign[]
  campaignPatients           CampaignPatient[]
  campaigns                  Campaign[]
  campaignSends              CampaignSend[]

  // Practice Orchestration relations
  patientFlowStates          PatientFlowState[]
  resourceOccupancy          ResourceOccupancy[]
  staffAssignments           StaffAssignment[]
  operationsTasks            OperationsTask[]
  dailyMetrics               DailyMetrics[]
  floorPlanConfig            FloorPlanConfig?

  // Patient Communications relations
  messageTemplates           MessageTemplate[]
  messages                   Message[]
  notificationPreferences    NotificationPreference[]
  contentArticles            ContentArticle[]
  contentDeliveries          ContentDelivery[]
  contentCategories          ContentCategory[]
  faqItems                   FAQItem[]

  // Survey relations
  surveys                    Survey[]
  surveyResponses            SurveyResponse[]

  // Patient Portal relations
  portalAccounts             PortalAccount[]

  // Treatment Management relations
  treatmentPlans             TreatmentPlan[]
  treatmentPhases            TreatmentPhase[]
  treatmentMilestones        TreatmentMilestone[]
  treatmentPhotos            TreatmentPhoto[]
  treatmentOptions           TreatmentOption[]
  casePresentations          CasePresentation[]
  caseAcceptances            CaseAcceptance[]
  planModifications          PlanModification[]

  // Clinical Documentation relations
  progressNotes              ProgressNote[]
  procedureRecords           ProcedureRecord[]
  clinicalFindings           ClinicalFinding[]
  clinicalMeasurements       ClinicalMeasurement[]
  noteTemplates              NoteTemplate[]
  visitRecords               VisitRecord[]

  // Appliance Management relations
  applianceRecords           ApplianceRecord[]
  wireRecords                WireRecord[]
  alignerRecords             AlignerRecord[]
  alignerDeliveries          AlignerDelivery[]
  retainerRecords            RetainerRecord[]
  elasticPrescriptions       ElasticPrescription[]
  applianceActivations       ApplianceActivation[]

  // CRM & Patient Onboarding relations
  leads                      Lead[]
  formTemplates              FormTemplate[]
  formSubmissions            FormSubmission[]
  referringProviders         ReferringProvider[]
  referralLetters            ReferralLetter[]
  recordsRequests            RecordsRequest[]
  intakeTokens               IntakeToken[]

  // Imaging Management relations
  patientImages              PatientImage[]
  photoProtocols             PhotoProtocol[]
  imageTags                  ImageTag[]
  imageMeasurements          ImageMeasurement[]
  collageTemplates           CollageTemplate[]
  imageCollages              ImageCollage[]
  progressReports            ProgressReport[]
  cephAnalyses               CephAnalysis[]
  imageRetentionPolicies     ImageRetentionPolicy[]
  imageArchiveRecords        ImageArchiveRecord[]

  // Treatment Tracking relations
  treatmentProgress          TreatmentProgress[]
  debondReadiness            DebondReadiness[]
  retentionProtocols         RetentionProtocol[]
  retentionChecks            RetentionCheck[]
  treatmentOutcomes          TreatmentOutcome[]

  // Lab Work Management relations
  labVendors                 LabVendor[]
  labProducts                LabProduct[]
  labFeeSchedules            LabFeeSchedule[]
  labContracts               LabContract[]
  labPreferenceRules         LabPreferenceRule[]
  labVendorMetrics           LabVendorMetrics[]
  labMessages                LabMessage[]
  labOrders                  LabOrder[]
  labOrderTemplates          LabOrderTemplate[]
  labInspections             LabInspection[]
  remakeRequests             RemakeRequest[]
  labWarranties              LabWarranty[]
  qualityIssues              QualityIssue[]
  labFeedback                LabFeedback[]
  patientPickupItems         PatientPickupItem[]
  reorderReminders           ReorderReminder[]
  orderDueDateAlerts         OrderDueDateAlert[]
  labIntegrations            LabIntegration[]
  autoclaveIntegrations      AutoclaveIntegration[]

  @@map("clinics")
}

/// User - System user account
model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  email          String    @unique
  emailVerified  DateTime?
  passwordHash   String?
  firstName      String
  lastName       String
  avatar         String?
  phone          String?
  role           UserRole  @default(clinical_staff)
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? // Soft delete

  // Multi-clinic support
  clinicId  String   @db.ObjectId   // Primary/current clinic
  clinicIds String[] @db.ObjectId   // All assigned clinics (for multi-clinic users)
  clinic    Clinic   @relation(fields: [clinicId], references: [id])

  // NextAuth.js relations
  accounts Account[]
  sessions Session[]

  // Role assignments (for fine-grained permissions)
  roleAssignments RoleAssignment[]

  // Audit trail
  createdBy String? @db.ObjectId
  updatedBy String? @db.ObjectId

  @@index([clinicId])
  @@map("users")
}

/// Account - OAuth provider accounts (NextAuth.js)
model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

/// Session - User sessions (NextAuth.js)
model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

/// VerificationToken - Email verification tokens (NextAuth.js)
model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Role - System and custom roles with permissions
model Role {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // Display name (e.g., "Clinic Administrator")
  code        String   @unique // System code (e.g., "clinic_admin")
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  permissions String[] // Array of permission codes (e.g., ["patients:read", "patients:write"])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Hierarchy fields
  level        Int      @default(0)    // 0 = base, higher = more senior (e.g., 10=staff, 20=manager, 30=admin)
  parentRoleId String?  @db.ObjectId   // Parent role for inheritance
  parentRole   Role?    @relation("RoleHierarchy", fields: [parentRoleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childRoles   Role[]   @relation("RoleHierarchy")

  // Relations
  assignments  RoleAssignment[]
  changeHistory RoleChangeHistory[]

  @@index([level])
  @@index([parentRoleId])
  @@map("roles")
}

/// RoleChangeHistory - Track changes to roles for audit and compliance
model RoleChangeHistory {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  roleId       String   @db.ObjectId

  // Change details
  changeType   String   // CREATE, UPDATE, DELETE, PERMISSIONS_ADDED, PERMISSIONS_REMOVED
  changeData   Json     // Stores before/after state or specific changes
  description  String?  // Human-readable description of the change

  // Who made the change
  changedById  String   @db.ObjectId
  changedByName String?

  // Timestamps
  changedAt    DateTime @default(now())

  // Relations
  role         Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([roleId])
  @@index([changedAt])
  @@index([changeType])
  @@map("role_change_history")
}

/// RoleAssignment - Links users to roles within specific clinics
model RoleAssignment {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  userId     String    @db.ObjectId
  roleId     String    @db.ObjectId
  clinicId   String    @db.ObjectId // Role applies to this clinic
  assignedBy String    @db.ObjectId
  assignedAt DateTime  @default(now())
  expiresAt  DateTime? // Optional expiration

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id])
  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([userId, roleId, clinicId])
  @@index([userId])
  @@index([clinicId])
  @@map("role_assignments")
}

/// AuditLog - Security and compliance audit trail
model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String?  @db.ObjectId
  userName   String?  // Denormalized for log readability
  userRole   String?  // Denormalized for log readability
  clinicId   String?  @db.ObjectId
  action     String   // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity     String   // Patient, Appointment, Invoice, etc.
  entityId   String?
  details    Json?    // Action-specific details
  ipAddress  String?
  userAgent  String?
  occurredAt DateTime @default(now())

  @@index([clinicId])
  @@index([userId])
  @@index([entity, entityId])
  @@index([occurredAt])
  @@index([action])
  @@map("audit_logs")
}

// =============================================================================
// PATIENT AREA - Patient records (placeholder for future implementation)
// =============================================================================

/// Patient - Patient records
model Patient {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  firstName   String
  lastName    String
  email       String?
  phone       String?
  dateOfBirth DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete for HIPAA compliance

  // Multi-clinic isolation
  clinicId String @db.ObjectId
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Audit trail
  createdBy String? @db.ObjectId
  updatedBy String? @db.ObjectId

  // Booking relations
  appointments Appointment[]

  // Waitlist & Recovery relations
  waitlistEntries            WaitlistEntry[]
  appointmentCancellations   AppointmentCancellation[]
  patientRiskScores          PatientRiskScore[]

  // Emergency & Reminders relations
  emergencyAppointments      EmergencyAppointment[]
  appointmentReminders       AppointmentReminder[]
  afterHoursMessages         AfterHoursMessage[]

  // Advanced Scheduling relations
  recurringAppointments      RecurringAppointment[]
  openingNotifications       OpeningNotification[]
  campaignPatients           CampaignPatient[]
  campaignSends              CampaignSend[]

  // Practice Orchestration relations
  patientFlowStates          PatientFlowState[]
  resourceOccupancy          ResourceOccupancy[]

  // Patient Communications relations
  messages                   Message[]
  notificationPreference     NotificationPreference?
  contentDeliveries          ContentDelivery[]

  // Survey relations
  surveyResponses            SurveyResponse[]

  // Patient Portal relations
  portalAccount              PortalAccount?

  // Treatment Management relations
  treatmentPlans             TreatmentPlan[]
  treatmentPhotos            TreatmentPhoto[]
  casePresentations          CasePresentation[]
  caseAcceptances            CaseAcceptance[]
  planModificationAcknowledgments PlanModification[] @relation("PlanModificationAcknowledgedBy")

  // Clinical Documentation relations
  progressNotes              ProgressNote[]
  clinicalMeasurements       ClinicalMeasurement[]
  visitRecords               VisitRecord[]

  // Appliance Management relations
  applianceRecords           ApplianceRecord[]
  alignerRecords             AlignerRecord[]
  retainerRecords            RetainerRecord[]
  elasticPrescriptions       ElasticPrescription[]

  // CRM & Patient Onboarding relations
  formSubmissions            FormSubmission[]
  referralLetters            ReferralLetter[]
  recordsRequests            RecordsRequest[]
  intakeTokens               IntakeToken[]

  // Imaging Management relations
  patientImages              PatientImage[]
  imageCollages              ImageCollage[]
  progressReports            ProgressReport[]
  cephAnalyses               CephAnalysis[]

  // Treatment Tracking relations
  treatmentProgress          TreatmentProgress[]
  debondReadiness            DebondReadiness[]
  retentionProtocols         RetentionProtocol[]
  retentionChecks            RetentionCheck[]
  treatmentOutcomes          TreatmentOutcome[]

  // Lab Work Management relations
  labOrders                  LabOrder[]
  patientPickupItems         PatientPickupItem[]
  reorderReminders           ReorderReminder[]

  @@index([clinicId])
  @@index([lastName, firstName])
  @@map("patients")
}

// =============================================================================
// STAFF MANAGEMENT AREA - Staff profiles, credentials, certifications
// =============================================================================

/// StaffProfile - Extended profile for clinic staff members
model StaffProfile {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  userId           String?         @unique @db.ObjectId // Links to User account (optional - staff can exist before user account)
  employeeNumber   String          // Unique within clinic

  // Personal Information
  firstName        String
  lastName         String
  middleName       String?
  preferredName    String?
  email            String
  phone            String?
  mobilePhone      String?
  dateOfBirth      DateTime?
  address          String?
  city             String?
  state            String?
  postalCode       String?
  country          String          @default("CA")

  // Employment Information
  employmentType   EmploymentType  @default(FULL_TIME)
  status           StaffStatus     @default(ACTIVE)
  hireDate         DateTime
  terminationDate  DateTime?
  department       String?
  title            String?

  // Provider-Specific Fields (for clinical staff)
  isProvider       Boolean         @default(false)
  providerType     ProviderType?
  npiNumber        String?         // National Provider Identifier (10 digits)
  deaNumber        String?         // DEA registration number
  stateLicenseNumber String?

  // Work Preferences
  defaultClinicId  String?         @db.ObjectId
  clinicIds        String[]        @db.ObjectId // Assigned clinics
  notes            String?

  // Default Schedule Template
  defaultScheduleTemplateId String?           @db.ObjectId
  defaultScheduleTemplate   ScheduleTemplate? @relation("DefaultScheduleTemplate", fields: [defaultScheduleTemplateId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Timestamps and Audit
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?       // Soft delete
  createdBy        String?         @db.ObjectId
  updatedBy        String?         @db.ObjectId

  // Multi-clinic isolation (primary clinic for data isolation)
  clinicId         String          @db.ObjectId

  // Supervisor relationship
  supervisorId     String?         @db.ObjectId
  supervisor       StaffProfile?   @relation("SupervisorRelation", fields: [supervisorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  directReports    StaffProfile[]  @relation("SupervisorRelation")

  // Relations
  credentials      Credential[]
  certifications   Certification[]
  emergencyContacts EmergencyContact[]
  employmentRecords EmploymentRecord[]
  documents        StaffDocument[]
  shifts           StaffShift[]
  timeOffRequests  TimeOffRequest[]
  availability     StaffAvailability[]
  overtimeLogs     OvertimeLog[]
  ptoUsage         PTOUsage[]

  // Performance & Training Relations
  goals            StaffGoal[]
  performanceReviews PerformanceReview[]
  trainingRecords  TrainingRecord[]
  ceCredits        CECredit[]
  recognitions     Recognition[]
  performanceMetrics PerformanceMetric[]

  // Booking relations (when staff is a provider)
  appointmentsAsProvider Appointment[] @relation("AppointmentProvider")
  waitlistPreferences    WaitlistEntry[] @relation("WaitlistPreferredProvider")

  // Advanced Scheduling relations
  providerSchedules      ProviderSchedule[] @relation("ProviderSchedules")
  scheduleBlocks         ScheduleBlock[] @relation("ScheduleBlocks")
  bookingTemplates       BookingTemplate[] @relation("BookingTemplates")
  templateApplications   TemplateApplication[] @relation("TemplateApplications")
  recurringAppointments  RecurringAppointment[] @relation("RecurringAppointments")

  // Practice Orchestration relations
  patientFlowStates      PatientFlowState[] @relation("FlowProvider")
  staffAssignments       StaffAssignment[]
  assignedTasks          OperationsTask[]   @relation("TaskAssignee")
  ownedTasks             OperationsTask[]   @relation("TaskOwner")
  chairAssignments       ResourceOccupancy[] @relation("ChairAssignedStaff")

  // CRM & Patient Onboarding relations
  assignedLeads          Lead[]             @relation("LeadAssignee")
  leadActivities         LeadActivity[]     @relation("LeadActivityPerformer")
  assignedLeadTasks      LeadTask[]         @relation("LeadTaskAssignee")
  completedLeadTasks     LeadTask[]         @relation("LeadTaskCompleter")
  reviewedFormSubmissions FormSubmission[]  @relation("FormReviewer")
  createdReferralLetters ReferralLetter[]   @relation("ReferralLetterCreator")
  createdRecordsRequests RecordsRequest[]   @relation("RecordsRequestCreator")
  createdIntakeTokens    IntakeToken[]      @relation("IntakeTokenCreator")

  // Imaging Management relations
  createdImages          PatientImage[]     @relation("ImageCreator")
  capturedImages         PatientImage[]     @relation("ImageCapturer")
  createdAnnotations     ImageAnnotation[]  @relation("AnnotationCreator")
  createdMeasurements    ImageMeasurement[] @relation("MeasurementCreator")
  createdCollageTemplates CollageTemplate[] @relation("CollageTemplateCreator")
  createdCollages        ImageCollage[]     @relation("CollageCreator")
  createdProgressReports ProgressReport[]   @relation("ReportCreator")
  createdCephAnalyses    CephAnalysis[]     @relation("CephAnalysisCreator")
  createdRetentionPolicies ImageRetentionPolicy[] @relation("RetentionPolicyCreator")
  imageLegalHoldsSet     PatientImage[]     @relation("ImageLegalHoldSetter")
  imageArchiveActions    ImageArchiveRecord[] @relation("ArchiveRecordPerformer")

  // Clinical Documentation relations
  progressNotesAsProvider    ProgressNote[]       @relation("ProgressNoteProvider")
  progressNotesSupervising   ProgressNote[]       @relation("ProgressNoteSupervisor")
  progressNotesSigned        ProgressNote[]       @relation("ProgressNoteSigner")
  progressNotesCoSigned      ProgressNote[]       @relation("ProgressNoteCoSigner")
  proceduresPerformed        ProcedureRecord[]    @relation("ProcedurePerformer")
  proceduresAssisted         ProcedureRecord[]    @relation("ProcedureAssistant")
  measurementsRecorded       ClinicalMeasurement[] @relation("MeasurementRecorder")
  noteTemplatesOwned         NoteTemplate[]       @relation("NoteTemplateOwner")
  visitRecordsPrimary        VisitRecord[]        @relation("VisitPrimaryProvider")
  visitRecordsCompleted      VisitRecord[]        @relation("VisitCompletedBy")

  // Treatment Plan Provider relations
  treatmentPlansPrimary      TreatmentPlan[]      @relation("TreatmentPlanPrimaryProvider")
  treatmentPlansSupervising  TreatmentPlan[]      @relation("TreatmentPlanSupervisingProvider")
  casePresentationsPresented CasePresentation[]   @relation("CasePresentationPresenter")
  caseAcceptancesWitnessed   CaseAcceptance[]     @relation("CaseAcceptanceWitness")
  planModificationsCreated   PlanModification[]   @relation("PlanModificationModifiedBy")

  // Appliance Management relations
  appliancesPlaced           ApplianceRecord[]    @relation("AppliancePlacedBy")
  appliancesRemoved          ApplianceRecord[]    @relation("ApplianceRemovedBy")
  wiresPlaced                WireRecord[]         @relation("WirePlacedBy")
  wiresRemoved               WireRecord[]         @relation("WireRemovedBy")
  alignerDeliveries          AlignerDelivery[]    @relation("AlignerDeliveredBy")
  retainersDelivered         RetainerRecord[]     @relation("RetainerDeliveredBy")
  elasticPrescriptions       ElasticPrescription[]
  applianceActivations       ApplianceActivation[]

  // Treatment Tracking relations
  treatmentProgressAssessments TreatmentProgress[]  @relation("TreatmentProgressAssessor")
  debondReadinessAssessments   DebondReadiness[]    @relation("DebondReadinessAssessor")
  debondReadinessApprovals     DebondReadiness[]    @relation("DebondReadinessApprover")
  retentionProtocolsManaged    RetentionProtocol[]  @relation("RetentionProtocolProvider")
  retentionChecksPerformed     RetentionCheck[]     @relation("RetentionCheckPerformer")
  treatmentOutcomeAssessments  TreatmentOutcome[]   @relation("TreatmentOutcomeAssessor")

  @@unique([clinicId, employeeNumber])
  @@index([clinicId])
  @@index([status])
  @@index([lastName, firstName])
  @@map("staff_profiles")
}

/// Credential - Provider licenses, registrations, and credentials
model Credential {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String           @db.ObjectId

  type             CredentialType
  name             String           // e.g., "State Dental License", "DEA Registration"
  number           String           // License/registration number
  issuingAuthority String           // e.g., "Ontario Dental Association"
  issuingState     String?          // State/province if applicable

  issueDate        DateTime
  expirationDate   DateTime?
  status           CredentialStatus @default(ACTIVE)

  // Verification
  verifiedAt       DateTime?
  verifiedBy       String?          @db.ObjectId
  verificationNotes String?

  // Document attachment
  documentUrl      String?

  // Timestamps
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdBy        String?          @db.ObjectId
  updatedBy        String?          @db.ObjectId

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  // Relations
  staffProfile     StaffProfile     @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([expirationDate])
  @@index([status])
  @@map("credentials")
}

/// Certification - Clinical certifications and training completions
model Certification {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String              @db.ObjectId

  type             CertificationType
  name             String              // e.g., "CPR/BLS Certification", "Invisalign Certified"
  issuingOrganization String           // e.g., "American Heart Association"

  issueDate        DateTime
  expirationDate   DateTime?
  status           CertificationStatus @default(ACTIVE)

  // Achievement details
  level            String?             // e.g., "Gold", "Platinum", "Level 2"
  score            String?             // If applicable

  // Document attachment
  certificateUrl   String?

  // Timestamps
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  createdBy        String?             @db.ObjectId
  updatedBy        String?             @db.ObjectId

  // Multi-clinic isolation
  clinicId         String              @db.ObjectId

  // Relations
  staffProfile     StaffProfile        @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([expirationDate])
  @@index([status])
  @@map("certifications")
}

/// EmergencyContact - Staff emergency contacts
model EmergencyContact {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId

  name             String
  relationship     String       // e.g., "Spouse", "Parent", "Sibling"
  phone            String
  alternatePhone   String?
  email            String?
  isPrimary        Boolean      @default(false)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  // Relations
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@map("emergency_contacts")
}

/// EmploymentRecord - Employment history and changes
model EmploymentRecord {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String         @db.ObjectId

  recordType       String         // HIRE, PROMOTION, TRANSFER, TERMINATION, STATUS_CHANGE, etc.
  effectiveDate    DateTime
  endDate          DateTime?

  // Position details
  previousTitle    String?
  newTitle         String?
  previousDepartment String?
  newDepartment    String?
  previousEmploymentType EmploymentType?
  newEmploymentType EmploymentType?
  previousStatus   StaffStatus?
  newStatus        StaffStatus?

  // Compensation (restricted - requires staff:compensation permission)
  previousSalary     Float?
  newSalary          Float?
  previousHourlyRate Float?
  newHourlyRate      Float?

  // Supervisor tracking
  supervisorId     String?        @db.ObjectId

  // Document attachments (links to StaffDocument)
  documentIds      String[]       @db.ObjectId

  // Additional details
  reason           String?        // Reason for change
  notes            String?
  approvedBy       String?        @db.ObjectId

  // Timestamps
  createdAt        DateTime       @default(now())
  createdBy        String?        @db.ObjectId

  // Multi-clinic isolation
  clinicId         String         @db.ObjectId

  // Relations
  staffProfile     StaffProfile   @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([effectiveDate])
  @@map("employment_records")
}

/// StaffDocument - HR documents and files
model StaffDocument {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String              @db.ObjectId

  name             String              // Document name
  description      String?
  category         DocumentCategory    // CONTRACT, ID, TAX, MEDICAL, etc.
  fileUrl          String              // Storage URL
  fileName         String              // Original filename
  fileSize         Int?                // Size in bytes
  mimeType         String?

  accessLevel      DocumentAccessLevel @default(HR_ONLY)

  // Expiration tracking
  expirationDate   DateTime?           @db.Date
  expirationStatus DocumentExpirationStatus @default(ACTIVE)
  effectiveDate    DateTime?           @db.Date

  // Version history
  version          Int                 @default(1)
  previousVersionId String?            @db.ObjectId
  isCurrentVersion Boolean             @default(true)

  // Timestamps
  uploadedAt       DateTime            @default(now())
  uploadedBy       String?             @db.ObjectId

  // Multi-clinic isolation
  clinicId         String              @db.ObjectId

  // Relations
  staffProfile     StaffProfile        @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([category])
  @@index([expirationDate])
  @@index([expirationStatus])
  @@index([isCurrentVersion])
  @@map("staff_documents")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  super_admin
  clinic_admin
  doctor
  clinical_staff
  front_desk
  billing
  read_only
}

// Staff Management Enums
enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  PRN          // Pro re nata (as needed)
  TEMP
}

enum StaffStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  SUSPENDED
  PENDING      // Pending start
}

enum ProviderType {
  ORTHODONTIST
  GENERAL_DENTIST
  ORAL_SURGEON
  PERIODONTIST
  ENDODONTIST
  HYGIENIST
  DENTAL_ASSISTANT
  EFDA          // Expanded Function Dental Auxiliary
  OTHER
}

enum CredentialType {
  STATE_LICENSE
  DEA_REGISTRATION
  NPI
  BOARD_CERTIFICATION
  SPECIALTY_CERTIFICATION
  RADIOLOGY_LICENSE
  SEDATION_PERMIT
  CONTROLLED_SUBSTANCE
  OTHER
}

enum CredentialStatus {
  ACTIVE
  EXPIRED
  PENDING
  SUSPENDED
  REVOKED
  RENEWAL_PENDING
}

enum CertificationType {
  CPR_BLS
  ACLS
  PALS
  RADIOLOGY
  NITROUS_OXIDE
  LASER_CERTIFICATION
  INVISALIGN
  SURESMILE
  INCOGNITO
  DAMON
  INFECTION_CONTROL
  HIPAA
  OSHA
  OTHER
}

enum CertificationStatus {
  ACTIVE
  EXPIRED
  PENDING
  REVOKED
}

enum DocumentAccessLevel {
  PUBLIC
  STAFF_ONLY
  HR_ONLY
  MANAGEMENT
  CONFIDENTIAL
}

enum DocumentCategory {
  CONTRACT
  ID
  TAX
  MEDICAL
  BACKGROUND
  CERTIFICATION
  PERFORMANCE
  DISCIPLINARY
  OTHER
  // HR-specific document types
  NDA
  I9
  W4
  DIRECT_DEPOSIT
  HANDBOOK_ACKNOWLEDGMENT
  EMERGENCY_CONTACT_FORM
  BENEFITS_ENROLLMENT
  PIP
  WRITTEN_WARNING
  COMMENDATION
}

enum DocumentExpirationStatus {
  ACTIVE           // No expiration or not yet approaching
  EXPIRING_SOON    // Within 30 days of expiration
  EXPIRED          // Past expiration date
}

enum BlackoutType {
  BLOCKED          // Completely blocked - no requests allowed
  RESTRICTED       // Requires approval from higher authority
  WARNING          // Allowed but shows warning
}

// =============================================================================
// STAFF SCHEDULING & TIME MANAGEMENT
// =============================================================================

/// StaffShift - Individual work shifts for staff members
model StaffShift {
  id               String      @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String      @db.ObjectId

  // Shift Details
  shiftDate        DateTime    @db.Date
  startTime        DateTime    // Full datetime for the shift start
  endTime          DateTime    // Full datetime for the shift end
  breakMinutes     Int         @default(0)
  scheduledHours   Float       // Calculated hours (endTime - startTime - break)

  // Location
  locationId       String      @db.ObjectId  // Which clinic/location

  // Shift Type & Status
  shiftType        ShiftType   @default(REGULAR)
  status           ShiftStatus @default(SCHEDULED)

  // Actual Times (for time tracking / clock in-out)
  clockIn          DateTime?
  clockOut         DateTime?
  actualBreakMinutes Int?
  actualHours      Float?

  // Notes and metadata
  notes            String?
  color            String?     // For UI display

  // Template reference (if created from template)
  templateId       String?     @db.ObjectId

  // Timestamps and Audit
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  createdBy        String?     @db.ObjectId
  updatedBy        String?     @db.ObjectId

  // Multi-clinic isolation
  clinicId         String      @db.ObjectId

  // Relations
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([shiftDate])
  @@index([locationId])
  @@index([status])
  @@index([shiftType])
  @@map("staff_shifts")
}

/// TimeOffRequest - Staff time-off/leave requests
model TimeOffRequest {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String         @db.ObjectId

  // Request Details
  requestType      TimeOffType
  startDate        DateTime       @db.Date
  endDate          DateTime       @db.Date
  totalDays        Float          // Can be fractional for partial days
  totalHours       Float?

  // Partial Day Options
  isPartialDay     Boolean        @default(false)
  partialStartTime DateTime?
  partialEndTime   DateTime?

  // Status
  status           TimeOffStatus  @default(PENDING)

  // Reason and notes
  reason           String?
  notes            String?

  // Approval tracking
  reviewedBy       String?        @db.ObjectId
  reviewedAt       DateTime?
  approvalNotes    String?
  rejectionReason  String?

  // Coverage
  coverageRequired Boolean        @default(true)
  coverageStaffId  String?        @db.ObjectId
  coverageNotes    String?

  // Timestamps
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Multi-clinic isolation
  clinicId         String         @db.ObjectId

  // Relations
  staffProfile     StaffProfile   @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@index([requestType])
  @@map("time_off_requests")
}

/// ScheduleTemplate - Reusable schedule templates
model ScheduleTemplate {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId

  // Template Details
  name             String
  description      String?
  templateType     TemplateType     @default(STANDARD)
  periodType       TemplatePeriod   @default(WEEKLY)

  // Employment Type Association (for filtering templates by staff employment type)
  employmentType   EmploymentType?  // null = applies to any employment type

  // Scope (optional filters for when template applies)
  locationId       String?          @db.ObjectId  // null = all locations
  department       String?

  // Status
  isActive         Boolean          @default(true)
  isDefault        Boolean          @default(false)

  // Effective dates
  effectiveFrom    DateTime?
  effectiveUntil   DateTime?

  // Template Data - stored as JSON array of shift definitions
  shifts           Json             // Array of TemplateShiftData

  // Timestamps and Audit
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdBy        String?          @db.ObjectId
  updatedBy        String?          @db.ObjectId

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  // Relations
  staffWithDefault StaffProfile[]   @relation("DefaultScheduleTemplate")

  @@index([clinicId])
  @@index([templateType])
  @@index([isActive])
  @@index([employmentType])
  @@map("schedule_templates")
}

/// StaffAvailability - Staff availability preferences and blocks
model StaffAvailability {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String           @db.ObjectId

  // Availability Type
  availabilityType AvailabilityType
  isRecurring      Boolean          @default(false)

  // For Recurring availability (weekly pattern)
  dayOfWeek        Int?             // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime        String?          // "HH:mm" format
  endTime          String?          // "HH:mm" format

  // For Specific Date availability
  specificDate     DateTime?        @db.Date
  allDay           Boolean          @default(false)

  // Location Preference (optional)
  locationId       String?          @db.ObjectId

  // Effective Period (for recurring)
  effectiveFrom    DateTime?
  effectiveUntil   DateTime?

  // Notes
  reason           String?
  notes            String?

  // Status
  isActive         Boolean          @default(true)

  // Timestamps
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  // Relations
  staffProfile     StaffProfile     @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([dayOfWeek])
  @@index([specificDate])
  @@index([availabilityType])
  @@map("staff_availability")
}

/// CoverageRequirement - Minimum staffing requirements
model CoverageRequirement {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Requirement Details
  name             String
  description      String?

  // Location this applies to
  locationId       String       @db.ObjectId

  // Role/Department filter (optional)
  department       String?
  providerType     ProviderType?

  // Staffing Levels
  minimumStaff     Int
  optimalStaff     Int?
  maximumStaff     Int?

  // Time Period (when this requirement applies)
  dayOfWeek        Int?         // null = all days
  startTime        String?      // "HH:mm" - null = all hours
  endTime          String?      // "HH:mm"

  // Priority and importance
  priority         Int          @default(1)  // Higher = more important
  isCritical       Boolean      @default(false)

  // Status
  isActive         Boolean      @default(true)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([locationId])
  @@index([isActive])
  @@map("coverage_requirements")
}

/// ShiftSwapRequest - Shift swap/trade requests between staff
model ShiftSwapRequest {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Original Shift being swapped
  originalShiftId  String       @db.ObjectId
  requesterId      String       @db.ObjectId  // Staff requesting the swap

  // Swap Type
  swapType         SwapType

  // Target (for SWAP type - exchanging shifts)
  targetShiftId    String?      @db.ObjectId
  targetStaffId    String?      @db.ObjectId

  // Status
  status           SwapStatus   @default(PENDING)

  // Approval tracking
  targetAcceptedAt DateTime?    // When target staff accepted
  approvedBy       String?      @db.ObjectId
  approvedAt       DateTime?

  // Notes
  reason           String?
  notes            String?

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([originalShiftId])
  @@index([requesterId])
  @@index([status])
  @@map("shift_swap_requests")
}

/// OvertimeLog - Weekly overtime tracking
model OvertimeLog {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String         @db.ObjectId

  // Period
  weekStartDate    DateTime       @db.Date  // Monday of the week
  weekEndDate      DateTime       @db.Date  // Sunday of the week

  // Hours breakdown
  regularHours     Float
  overtimeHours    Float
  totalHours       Float

  // Status
  status           OvertimeStatus @default(PENDING)
  preApproved      Boolean        @default(false)

  // Approval tracking
  approvedBy       String?        @db.ObjectId
  approvedAt       DateTime?

  // Notes
  reason           String?
  notes            String?

  // Timestamps
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Multi-clinic isolation
  clinicId         String         @db.ObjectId

  // Relations
  staffProfile     StaffProfile   @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@unique([staffProfileId, weekStartDate])
  @@index([clinicId])
  @@index([staffProfileId])
  @@index([weekStartDate])
  @@index([status])
  @@map("overtime_logs")
}

// =============================================================================
// SCHEDULING ENUMS
// =============================================================================

enum ShiftType {
  REGULAR
  OVERTIME
  ON_CALL
  TRAINING
  MEETING
  COVERAGE     // Filling in for someone
  FLOAT        // Floating/flexible assignment
}

enum ShiftStatus {
  SCHEDULED    // Scheduled but not yet confirmed
  CONFIRMED    // Staff confirmed attendance
  IN_PROGRESS  // Currently working
  COMPLETED    // Shift completed
  CANCELLED    // Shift cancelled
  NO_SHOW      // Staff didn't show
  SWAP_PENDING // Pending swap approval
}

enum TimeOffType {
  VACATION
  SICK
  PERSONAL
  BEREAVEMENT
  JURY_DUTY
  MILITARY
  MATERNITY
  PATERNITY
  FMLA
  UNPAID
  CONTINUING_EDUCATION
  HOLIDAY
  OTHER
}

enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  WITHDRAWN
}

enum TemplateType {
  STANDARD       // Regular operating hours
  EXTENDED_HOURS // Extended/overtime coverage
  HOLIDAY        // Holiday schedule
  SEASONAL       // Seasonal variation
  CUSTOM         // Custom template
}

enum TemplatePeriod {
  DAILY
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum AvailabilityType {
  AVAILABLE      // Can work
  UNAVAILABLE    // Cannot work
  PREFERRED      // Prefers to work
  IF_NEEDED      // Available if needed
  BLOCKED        // System-blocked (leave, etc.)
}

enum SwapType {
  SWAP           // Exchange shifts with another staff
  GIVEAWAY       // Give shift to another staff
  PICKUP         // Pick up an open shift
}

enum SwapStatus {
  PENDING        // Awaiting target/approval
  ACCEPTED       // Target accepted, awaiting manager
  APPROVED       // Manager approved
  REJECTED       // Rejected
  CANCELLED      // Cancelled by requester
  COMPLETED      // Swap completed
}

enum OvertimeStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

// =============================================================================
// BLACKOUT DATES & PTO TRACKING
// =============================================================================

/// BlackoutDate - Dates when time-off requests are blocked/restricted
model BlackoutDate {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Blackout Details
  name             String       // e.g., "Holiday Season", "Staff Training Week"
  description      String?
  startDate        DateTime     @db.Date
  endDate          DateTime     @db.Date

  // Scope
  restrictionType  BlackoutType @default(BLOCKED)
  affectedRoles    String[]     // Empty = all roles, otherwise specific roles
  department       String?      // Optional department filter

  // Recurrence (for annual holidays)
  isRecurring      Boolean      @default(false)
  recurrencePattern String?     // e.g., "YEARLY" for annual holidays

  // Status
  isActive         Boolean      @default(true)

  // Timestamps and Audit
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createdBy        String?      @db.ObjectId
  updatedBy        String?      @db.ObjectId

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("blackout_dates")
}

/// PTOUsage - Track PTO usage per staff member per type per year (simple tracking, no limits)
model PTOUsage {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId

  // Period tracking
  year             Int          // Calendar year

  // Usage by type (in hours for flexibility)
  usageByType      Json         // { "VACATION": 40, "SICK": 8, ... }

  // Summary
  totalHoursUsed   Float        @default(0)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  // Relations
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@unique([staffProfileId, year])
  @@index([clinicId])
  @@index([staffProfileId])
  @@index([year])
  @@map("pto_usage")
}

// =============================================================================
// ROLE TEMPLATES - Industry-standard role templates
// =============================================================================

/// RoleTemplate - Predefined role templates for common healthcare roles
model RoleTemplate {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Template Details
  name             String       // e.g., "Front Desk Staff", "Clinical Assistant"
  code             String       @unique // e.g., "template_front_desk"
  description      String?
  category         String       // e.g., "Administrative", "Clinical", "Management"

  // Permissions
  permissions      String[]     // Default permissions for this template

  // Industry standard indicator
  isIndustryStandard Boolean    @default(false) // True for Orca-provided templates
  sourceVersion    String?      // Version of Orca that provided this template

  // Usage tracking
  usageCount       Int          @default(0) // How many times this template was used

  // Status
  isActive         Boolean      @default(true)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("role_templates")
}

// =============================================================================
// PERFORMANCE & TRAINING - Staff performance and training tracking
// =============================================================================

/// PerformanceMetric - Track staff performance metrics
model PerformanceMetric {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Metric Details
  metricType       String       // e.g., "patient_satisfaction", "productivity", "attendance"
  metricName       String
  value            Float
  unit             String?      // e.g., "percent", "count", "rating"

  // Period
  periodStart      DateTime     @db.Date
  periodEnd        DateTime     @db.Date

  // Target (optional)
  targetValue      Float?
  targetMet        Boolean?

  // Notes
  notes            String?
  calculatedBy     String?      // "manual", "system", "integration"

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createdBy        String?      @db.ObjectId

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([metricType])
  @@index([periodStart])
  @@map("performance_metrics")
}

/// StaffGoal - Goal setting and tracking for staff
model StaffGoal {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Goal Details
  title            String
  description      String?
  category         String?      // e.g., "professional_development", "performance", "certification"

  // Timeline
  startDate        DateTime     @db.Date
  targetDate       DateTime     @db.Date
  completedDate    DateTime?    @db.Date

  // Status and Progress
  status           GoalStatus   @default(NOT_STARTED)
  progress         Int          @default(0) // 0-100 percent
  priority         Int          @default(2) // 1=low, 2=medium, 3=high

  // Milestones (stored as JSON)
  milestones       Json?        // Array of milestone objects

  // Notes
  notes            String?
  reviewNotes      String?

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createdBy        String?      @db.ObjectId

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([status])
  @@index([targetDate])
  @@map("staff_goals")
}

/// PerformanceReview - Performance review cycles
model PerformanceReview {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String        @db.ObjectId
  staffProfile     StaffProfile  @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Review Details
  reviewType       ReviewType
  reviewPeriodStart DateTime     @db.Date
  reviewPeriodEnd  DateTime      @db.Date
  reviewDate       DateTime?     @db.Date

  // Status
  status           ReviewStatus  @default(SCHEDULED)

  // Reviewer
  reviewerId       String?       @db.ObjectId
  reviewerName     String?

  // Ratings (stored as JSON for flexibility)
  ratings          Json?         // e.g., { "quality": 4, "teamwork": 5, ... }
  overallRating    Float?        // 1-5 scale

  // Feedback
  strengthsNotes   String?
  improvementNotes String?
  employeeComments String?

  // Goals from this review
  newGoals         Json?         // Goals set during review

  // Timestamps
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  completedAt      DateTime?

  // Multi-clinic isolation
  clinicId         String        @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([status])
  @@index([reviewDate])
  @@map("performance_reviews")
}

/// TrainingRecord - Track staff training and courses
model TrainingRecord {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String          @db.ObjectId
  staffProfile     StaffProfile    @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Training Details
  name             String
  description      String?
  category         String          // e.g., "compliance", "clinical", "software", "safety"
  provider         String?         // Training provider/vendor

  // Duration
  durationHours    Float?
  credits          Float?          // CE credits if applicable

  // Timeline
  assignedDate     DateTime?       @db.Date
  dueDate          DateTime?       @db.Date
  startedDate      DateTime?       @db.Date
  completedDate    DateTime?       @db.Date
  expirationDate   DateTime?       @db.Date

  // Status
  status           TrainingStatus  @default(ASSIGNED)
  score            Float?          // Test score if applicable
  passed           Boolean?

  // Certificate/Documentation
  certificateUrl   String?

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  createdBy        String?         @db.ObjectId

  // Multi-clinic isolation
  clinicId         String          @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([status])
  @@index([dueDate])
  @@index([expirationDate])
  @@map("training_records")
}

/// CECredit - Continuing Education credit tracking
model CECredit {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Credit Details
  courseName       String
  provider         String
  category         String       // e.g., "general", "specialty", "ethics"
  credits          Float
  creditType       String?      // e.g., "hours", "units"

  // Dates
  completionDate   DateTime     @db.Date
  reportingPeriodStart DateTime? @db.Date
  reportingPeriodEnd   DateTime? @db.Date

  // Verification
  certificateUrl   String?
  verificationCode String?
  isVerified       Boolean      @default(false)
  verifiedAt       DateTime?
  verifiedBy       String?      @db.ObjectId

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([completionDate])
  @@index([category])
  @@map("ce_credits")
}

/// Recognition - Staff recognition and awards
model Recognition {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String           @db.ObjectId
  staffProfile     StaffProfile     @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Recognition Details
  type             RecognitionType
  title            String
  description      String?

  // Who gave the recognition
  givenById        String?          @db.ObjectId
  givenByName      String?
  isAnonymous      Boolean          @default(false)

  // Award details (if applicable)
  awardValue       Float?           // Monetary value if applicable
  awardDescription String?

  // Date
  recognitionDate  DateTime         @default(now())

  // Visibility
  isPublic         Boolean          @default(true) // Show on profile

  // Timestamps
  createdAt        DateTime         @default(now())

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([type])
  @@index([recognitionDate])
  @@map("recognitions")
}

// =============================================================================
// PERFORMANCE & TRAINING ENUMS
// =============================================================================

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ReviewType {
  ANNUAL
  SEMI_ANNUAL
  QUARTERLY
  PROBATIONARY
  PERFORMANCE_IMPROVEMENT
  PROMOTION
  SPECIAL
}

enum ReviewStatus {
  SCHEDULED
  IN_PROGRESS
  PENDING_APPROVAL
  COMPLETED
  CANCELLED
}

enum TrainingStatus {
  ASSIGNED
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  OVERDUE
  WAIVED
}

enum RecognitionType {
  KUDOS
  EMPLOYEE_OF_MONTH
  YEARS_OF_SERVICE
  ACHIEVEMENT
  PEER_RECOGNITION
  PATIENT_COMPLIMENT
  OTHER
}

// =============================================================================
// RESOURCES MANAGEMENT AREA - Equipment, Rooms, Inventory, Sterilization
// =============================================================================

// -----------------------------------------------------------------------------
// Supplier - Shared model for equipment vendors and inventory suppliers
// -----------------------------------------------------------------------------

/// Supplier - Vendor/supplier for equipment and inventory
model Supplier {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Identification
  name            String
  code            String         // Unique supplier code within clinic
  accountNumber   String?        // Account number with supplier

  // Contact Information
  contactName     String?
  email           String?
  phone           String?
  fax             String?
  website         String?

  // Address
  address         String?
  city            String?
  state           String?
  postalCode      String?
  country         String?

  // Order Settings
  minimumOrder    Float?         // Minimum order amount
  freeShippingThreshold Float?   // Order amount for free shipping
  defaultLeadTimeDays Int        @default(7)
  orderMethod     SupplierOrderMethod @default(EMAIL)

  // Payment
  paymentTerms    String?        // e.g., "Net 30", "Due on Receipt"
  taxExempt       Boolean        @default(false)

  // Performance Tracking
  rating          Int?           // 1-5 stars
  onTimeDeliveryRate Float?      // Percentage of on-time deliveries

  // Status
  status          SupplierStatus @default(ACTIVE)
  isPreferred     Boolean        @default(false)

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment[]
  maintenanceRecords MaintenanceRecord[]
  repairRecords   RepairRecord[]
  inventoryItems  InventoryItem[]
  purchaseOrders  PurchaseOrder[]

  @@unique([clinicId, code])
  @@index([clinicId])
  @@index([status])
  @@index([name])
  @@map("suppliers")
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  ON_HOLD
  BLOCKED
}

enum SupplierOrderMethod {
  EMAIL
  PORTAL
  PHONE
  FAX
  EDI
}

// -----------------------------------------------------------------------------
// Equipment Management - Equipment catalog, types, maintenance, repairs
// -----------------------------------------------------------------------------

/// EquipmentType - Categories and types of equipment with default settings
model EquipmentType {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String?        @db.ObjectId  // null for system-wide types

  // Type Information
  name            String         // e.g., "Intraoral Scanner", "CBCT Machine"
  code            String         // e.g., "INTRAORAL_SCANNER", unique per clinic
  category        EquipmentCategory
  description     String?

  // Default Maintenance Settings
  defaultMaintenanceIntervalDays Int?
  maintenanceChecklist String[]  // Default checklist items

  // Default Depreciation Settings
  defaultUsefulLifeMonths Int?
  defaultDepreciationMethod DepreciationMethod?

  // Status
  isSystem        Boolean        @default(false) // System types cannot be deleted
  isActive        Boolean        @default(true)

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment[]

  @@unique([clinicId, code])
  @@index([clinicId])
  @@index([category])
  @@index([isActive])
  @@map("equipment_types")
}

/// Equipment - Main equipment records
model Equipment {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Identification
  name            String         // e.g., "iTero Element 5D Scanner"
  equipmentNumber String         // Unique equipment ID (e.g., "EQ-2024-001")
  serialNumber    String?        // Manufacturer serial number
  modelNumber     String?        // Model number
  barcode         String?        // Barcode/QR code value

  // Classification
  typeId          String         @db.ObjectId
  category        EquipmentCategory
  manufacturer    String?

  // Location
  roomId          String?        @db.ObjectId  // Assigned room (optional)
  locationNotes   String?        // Additional location details

  // Status
  status          EquipmentStatus @default(ACTIVE)
  condition       EquipmentCondition @default(GOOD)

  // Purchase Information
  purchaseDate    DateTime?
  purchasePrice   Float?
  vendorId        String?        @db.ObjectId
  purchaseOrderNumber String?

  // Warranty Information
  warrantyStartDate DateTime?
  warrantyExpiry  DateTime?
  warrantyTerms   String?        // Coverage description
  warrantyNotes   String?
  hasExtendedWarranty Boolean    @default(false)
  extendedWarrantyExpiry DateTime?

  // Depreciation Settings
  usefulLifeMonths Int?
  salvageValue    Float?
  depreciationMethod DepreciationMethod @default(STRAIGHT_LINE)
  accumulatedDepreciation Float  @default(0)
  currentBookValue Float?
  monthlyDepreciation Float?
  isFullyDepreciated Boolean     @default(false)
  fullyDepreciatedDate DateTime?

  // Maintenance Settings
  maintenanceIntervalDays Int?
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?

  // Documents & Media
  manualUrl       String?        // Link to equipment manual
  photos          String[]       // Photo URLs
  specifications  Json?          // Technical specifications

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  type            EquipmentType  @relation(fields: [typeId], references: [id])
  vendor          Supplier?      @relation(fields: [vendorId], references: [id])
  maintenanceRecords MaintenanceRecord[]
  repairRecords   RepairRecord[]
  autoclaveIntegrations AutoclaveIntegration[]

  @@unique([clinicId, equipmentNumber])
  @@index([clinicId])
  @@index([typeId])
  @@index([category])
  @@index([status])
  @@index([roomId])
  @@index([serialNumber])
  @@index([barcode])
  @@index([nextMaintenanceDate])
  @@map("equipment")
}

enum EquipmentCategory {
  DIAGNOSTIC      // Scanners, X-ray, CBCT
  TREATMENT       // Curing lights, bracket tools
  DIGITAL         // 3D printers, milling machines
  CHAIR           // Dental chairs, delivery units
  STERILIZATION   // Autoclaves, cleaners
  SAFETY          // AEDs, fire extinguishers
  OTHER
}

enum EquipmentStatus {
  ACTIVE          // In normal operation
  IN_REPAIR       // Currently being repaired
  OUT_OF_SERVICE  // Temporarily unavailable
  RETIRED         // No longer in use but retained
  DISPOSED        // Removed from inventory
}

enum EquipmentCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum DepreciationMethod {
  STRAIGHT_LINE      // (Cost - Salvage) / Useful Life
  DECLINING_BALANCE  // Double declining balance
  NONE               // No depreciation (minor items)
}

// -----------------------------------------------------------------------------
// Maintenance Records - Scheduled and completed maintenance activities
// -----------------------------------------------------------------------------

/// MaintenanceRecord - Maintenance activities for equipment
model MaintenanceRecord {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  equipmentId     String         @db.ObjectId

  // Maintenance Details
  maintenanceType MaintenanceType
  scheduledDate   DateTime?      // When maintenance was/is scheduled
  completedDate   DateTime?      // When actually completed
  status          MaintenanceStatus @default(SCHEDULED)

  // Work Performed
  description     String?        // Description of work to be done/done
  checklist       Json?          // Completed checklist items with status
  notes           String?        // Additional notes

  // Performer Information
  performedBy     String?        // Internal staff name or "Vendor"
  performedById   String?        @db.ObjectId  // Staff ID if internal
  vendorId        String?        @db.ObjectId  // Vendor if external
  technicianName  String?        // Technician name (for vendor service)

  // Costs
  laborCost       Float?
  partsCost       Float?
  totalCost       Float?

  // Next Maintenance
  nextMaintenanceDate DateTime?

  // Documents
  attachments     String[]       // URLs to attached documents

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment      @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  vendor          Supplier?      @relation(fields: [vendorId], references: [id])

  @@index([clinicId])
  @@index([equipmentId])
  @@index([status])
  @@index([scheduledDate])
  @@index([maintenanceType])
  @@map("maintenance_records")
}

enum MaintenanceType {
  PREVENTIVE      // Routine preventive maintenance
  CALIBRATION     // Equipment calibration
  INSPECTION      // Safety/compliance inspection
  CLEANING        // Deep cleaning
  CERTIFICATION   // Annual certification/validation
  OTHER
}

enum MaintenanceStatus {
  SCHEDULED       // Scheduled but not started
  IN_PROGRESS     // Currently being performed
  COMPLETED       // Successfully completed
  CANCELLED       // Cancelled
  OVERDUE         // Past scheduled date, not completed
}

// -----------------------------------------------------------------------------
// Repair Records - Equipment repairs and service calls
// -----------------------------------------------------------------------------

/// RepairRecord - Repair and service history for equipment
model RepairRecord {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  equipmentId     String         @db.ObjectId

  // Issue Details
  reportedDate    DateTime       @default(now())
  reportedById    String         @db.ObjectId  // Staff who reported
  issueDescription String        // Description of the problem
  severity        RepairSeverity @default(MEDIUM)

  // Status Tracking
  status          RepairStatus   @default(REPORTED)
  scheduledDate   DateTime?      // When repair is scheduled
  completedDate   DateTime?      // When repair was completed

  // Diagnosis & Resolution
  diagnosis       String?        // What was found to be wrong
  workPerformed   String?        // Description of repair work
  partsReplaced   String[]       // List of parts replaced
  resolutionNotes String?        // Additional resolution notes

  // Vendor/Service Information
  vendorId        String?        @db.ObjectId
  technicianName  String?
  serviceTicketNumber String?    // Vendor's ticket/case number

  // Costs
  laborCost       Float?
  partsCost       Float?
  travelCost      Float?
  totalCost       Float?

  // Warranty Coverage
  coveredByWarranty Boolean      @default(false)
  warrantyClaimNumber String?

  // Downtime Tracking
  equipmentDownStart DateTime?   // When equipment became unavailable
  equipmentDownEnd DateTime?     // When equipment returned to service

  // Documents
  attachments     String[]       // URLs to attached documents/photos

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment      @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  vendor          Supplier?      @relation(fields: [vendorId], references: [id])

  @@index([clinicId])
  @@index([equipmentId])
  @@index([status])
  @@index([reportedDate])
  @@index([severity])
  @@map("repair_records")
}

enum RepairSeverity {
  LOW             // Minor issue, can wait
  MEDIUM          // Should be addressed soon
  HIGH            // Urgent, affects operations
  CRITICAL        // Equipment unusable, immediate action
}

enum RepairStatus {
  REPORTED        // Issue reported, not yet reviewed
  DIAGNOSED       // Problem identified
  AWAITING_PARTS  // Waiting for replacement parts
  SCHEDULED       // Repair scheduled
  IN_PROGRESS     // Repair underway
  COMPLETED       // Repair finished
  CANNOT_REPAIR   // Equipment cannot be repaired
  CANCELLED       // Repair cancelled
}

// -----------------------------------------------------------------------------
// Room/Chair Management - Operatories, treatment chairs, and equipment assignments
// -----------------------------------------------------------------------------

/// Room - Treatment rooms/operatories in the clinic
model Room {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Identification
  name            String         // e.g., "Operatory 1", "Consultation Room A"
  roomNumber      String         // Unique within clinic (e.g., "OP-1", "CONSULT-A")

  // Classification
  roomType        RoomType

  // Physical details
  floor           String?        // e.g., "1st Floor", "Basement"
  wing            String?        // e.g., "East Wing", "Main"
  squareFeet      Int?
  capacity        Int            @default(1) // Max patients/occupants

  // Status
  status          RoomStatus     @default(ACTIVE)
  isAvailable     Boolean        @default(true)

  // Capabilities - what procedures can be performed here
  capabilities    String[]       // e.g., ["ORTHO", "X_RAY", "SCANNING", "CONSULTATION"]

  // Configuration notes
  setupNotes      String?        // Setup instructions for this room
  notes           String?        // General notes

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  chairs          TreatmentChair[]
  roomEquipment   RoomEquipment[]

  // Booking relations
  appointments    Appointment[]

  // Practice Orchestration relations
  resourceOccupancy ResourceOccupancy[]

  @@unique([clinicId, roomNumber])
  @@index([clinicId])
  @@index([roomType])
  @@index([status])
  @@map("rooms")
}

enum RoomType {
  OPERATORY       // Treatment operatory with chair
  CONSULTATION    // Consultation/exam room
  X_RAY           // X-ray/imaging room
  STERILIZATION   // Sterilization area
  LAB             // In-house lab
  STORAGE         // Storage room
  RECEPTION       // Reception/waiting area
  OFFICE          // Office/admin space
}

enum RoomStatus {
  ACTIVE          // In normal operation
  MAINTENANCE     // Under maintenance
  CLOSED          // Temporarily closed
  RENOVATION      // Under renovation
}

/// TreatmentChair - Dental/treatment chairs within rooms
model TreatmentChair {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  roomId          String         @db.ObjectId

  // Identification
  name            String         // e.g., "Chair 1", "Primary Chair"
  chairNumber     String         // Unique within clinic (e.g., "CH-001")

  // Equipment details
  manufacturer    String?
  modelNumber     String?
  serialNumber    String?

  // Status
  status          ChairStatus    @default(ACTIVE)
  condition       EquipmentCondition @default(GOOD)

  // Features and capabilities
  features        String[]       // e.g., ["PROGRAMMABLE", "HEATED", "MASSAGE"]
  hasDeliveryUnit Boolean        @default(true)
  hasSuction      Boolean        @default(true)
  hasLight        Boolean        @default(true)

  // Purchase/warranty info
  purchaseDate    DateTime?
  warrantyExpiry  DateTime?

  // Maintenance
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  room            Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Booking relations
  appointments    Appointment[]

  // Practice Orchestration relations
  patientFlowStates PatientFlowState[]
  resourceOccupancy ResourceOccupancy[]

  @@unique([clinicId, chairNumber])
  @@index([clinicId])
  @@index([roomId])
  @@index([status])
  @@map("treatment_chairs")
}

enum ChairStatus {
  ACTIVE          // In normal operation
  IN_REPAIR       // Currently being repaired
  OUT_OF_SERVICE  // Temporarily unavailable
  RETIRED         // No longer in use
}

/// RoomEquipment - Equipment assigned to rooms (many-to-many with history)
model RoomEquipment {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  roomId          String         @db.ObjectId
  equipmentId     String         @db.ObjectId

  // Assignment details
  assignedDate    DateTime       @default(now())
  unassignedDate  DateTime?      // null = currently assigned
  isPermanent     Boolean        @default(true)  // Permanent vs temporary assignment

  // Position/location within room
  position        String?        // e.g., "Left wall", "Near window"

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId

  // Relations
  room            Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([roomId])
  @@index([equipmentId])
  @@index([unassignedDate])
  @@map("room_equipment")
}

// -----------------------------------------------------------------------------
// Sterilization & Compliance - Cycle tracking, indicators, compliance logs
// -----------------------------------------------------------------------------

/// SterilizationCycle - Individual autoclave/sterilizer run records
model SterilizationCycle {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Equipment - link to sterilization equipment (autoclave, etc.)
  equipmentId     String               @db.ObjectId

  // Cycle identification
  cycleNumber     String               // Unique cycle number (e.g., "CYC-2024-001")

  // Cycle details
  cycleType       SterilizationCycleType
  startTime       DateTime
  endTime         DateTime?

  // Process parameters
  temperature     Float?               // Temperature in Celsius
  pressure        Float?               // Pressure in PSI
  exposureTime    Int?                 // Exposure time in minutes
  dryingTime      Int?                 // Drying time in minutes

  // Results
  status          CycleStatus          @default(IN_PROGRESS)
  mechanicalPass  Boolean?             // Mechanical indicator result
  chemicalPass    Boolean?             // Chemical indicator result
  biologicalPass  Boolean?             // Biological indicator result (spore test)

  // Operator info
  operatorId      String               @db.ObjectId
  verifiedById    String?              @db.ObjectId
  verifiedAt      DateTime?

  // Notes
  notes           String?
  failureReason   String?              // If cycle failed

  // Autoclave import data (populated when imported from autoclave API)
  autoclaveId          String?              @db.ObjectId  // Which AutoclaveIntegration this came from
  externalCycleNumber  Int?                 // Original autoclave cycle number (e.g., 1755)
  digitalSignature     String?              // Autoclave's digital signature for compliance
  rawLog               String?              // Full log text from autoclave
  importedAt           DateTime?            // When imported from autoclave
  tempProfile          String?              // Temperature readings (space-separated floats)
  pressureProfile      String?              // Pressure readings (space-separated floats)
  isNew                Boolean              @default(true)  // Flag for newly imported cycles (until viewed)
  viewedAt             DateTime?            // When the cycle detail was first viewed

  // Timestamps & Audit
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  createdBy       String?              @db.ObjectId
  updatedBy       String?              @db.ObjectId

  // Relations
  loads           SterilizationLoad[]
  biologicalIndicators BiologicalIndicator[]
  chemicalIndicators   ChemicalIndicator[]
  packages        InstrumentPackage[]
  autoclave       AutoclaveIntegration? @relation("AutoclaveCycles", fields: [autoclaveId], references: [id])

  @@unique([clinicId, cycleNumber])
  @@index([clinicId])
  @@index([equipmentId])
  @@index([status])
  @@index([startTime])
  @@index([operatorId])
  @@index([autoclaveId])
  @@index([externalCycleNumber])
  @@map("sterilization_cycles")
}

enum SterilizationCycleType {
  STEAM_GRAVITY    // Gravity steam sterilization (standard)
  STEAM_PREVACUUM  // Pre-vacuum steam sterilization
  STEAM_FLASH      // Flash/immediate use sterilization
  CHEMICAL         // Chemical sterilization (e.g., ethylene oxide)
  DRY_HEAT         // Dry heat sterilization
  VALIDATION       // Validation/test cycle
}

enum CycleStatus {
  IN_PROGRESS      // Cycle currently running
  COMPLETED        // Cycle completed successfully
  FAILED           // Cycle failed (parameters not met)
  ABORTED          // Cycle aborted by operator
  VOID             // Cycle voided (record-keeping error)
}

/// SterilizationLoad - Items processed in each cycle
model SterilizationLoad {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId
  cycleId         String               @db.ObjectId

  // Load identification
  loadNumber      Int                  // Position/number in load (1, 2, 3, etc.)

  // Item details
  itemType        LoadItemType
  itemDescription String               // Description of item(s)
  quantity        Int                  @default(1)

  // Instrument pack/set tracking (if applicable)
  instrumentSetId String?              @db.ObjectId
  packBarcode     String?              // Pack/pouch barcode

  // Position in sterilizer
  position        String?              // e.g., "Top rack", "Middle shelf"

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  cycle           SterilizationCycle   @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([cycleId])
  @@index([instrumentSetId])
  @@index([packBarcode])
  @@map("sterilization_loads")
}

enum LoadItemType {
  INSTRUMENT_PACK  // Wrapped instrument set/pack
  INSTRUMENT_SET   // Unwrapped instrument set
  HANDPIECE        // Dental handpiece
  BUR_BLOCK        // Bur block/holder
  IMPLANT_KIT      // Implant surgical kit
  ORTHODONTIC_TRAY // Orthodontic instrument tray
  LOOSE_ITEMS      // Individual loose instruments
  OTHER
}

/// BiologicalIndicator - Spore test results for cycle validation
model BiologicalIndicator {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId
  cycleId         String?              @db.ObjectId  // Can be independent test

  // Indicator identification
  lotNumber       String               // Manufacturer lot number
  brand           String?              // e.g., "3M Attest", "Mesa Labs"

  // Testing info
  testDate        DateTime             // When test was started
  readDate        DateTime?            // When result was read
  incubationHours Int?                 // Hours incubated

  // Results
  result          BiologicalTestResult @default(PENDING)
  controlPassed   Boolean?             // Control vial passed (grew)

  // Reader info (if using rapid reader)
  readerType      String?              // e.g., "3M Attest 490", "Manual incubator"
  readerId        String?              // Reader serial/ID

  // Performed by
  performedById   String               @db.ObjectId
  readById        String?              @db.ObjectId

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  cycle           SterilizationCycle?  @relation(fields: [cycleId], references: [id], onDelete: SetNull)

  @@index([clinicId])
  @@index([cycleId])
  @@index([testDate])
  @@index([result])
  @@index([lotNumber])
  @@map("biological_indicators")
}

enum BiologicalTestResult {
  PENDING          // Incubating, awaiting results
  PASSED           // Negative (no growth) - sterilization effective
  FAILED           // Positive (growth) - sterilization NOT effective
  INCONCLUSIVE     // Control failed or invalid result
}

/// ChemicalIndicator - Chemical indicator strip/tape results
model ChemicalIndicator {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId
  cycleId         String               @db.ObjectId

  // Indicator type
  indicatorClass  ChemicalIndicatorClass
  indicatorType   String?              // Brand/type description

  // Location in load
  loadPosition    String?              // Where indicator was placed

  // Results
  result          ChemicalIndicatorResult
  colorChange     String?              // Description of color change

  // Performed by
  performedById   String               @db.ObjectId

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  cycle           SterilizationCycle   @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([cycleId])
  @@index([result])
  @@map("chemical_indicators")
}

enum ChemicalIndicatorClass {
  CLASS_1          // Process indicators (autoclave tape) - exposure only
  CLASS_2          // Bowie-Dick test indicators (air removal)
  CLASS_3          // Single-parameter indicators
  CLASS_4          // Multi-parameter indicators
  CLASS_5          // Integrating indicators (simulate BI)
  CLASS_6          // Emulating indicators (specific cycle)
}

enum ChemicalIndicatorResult {
  PASSED           // Color change complete/acceptable
  FAILED           // Color change incomplete/unacceptable
  INCONCLUSIVE     // Unable to determine
}

/// InstrumentSet - Reusable instrument packs/sets for tracking
model InstrumentSet {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Identification
  name            String               // e.g., "Ortho Bonding Set A"
  setNumber       String               // Unique set ID (e.g., "SET-001")
  barcode         String?              // Barcode for scanning

  // Contents
  description     String?              // Contents description
  instrumentCount Int                  // Number of instruments in set

  // Category
  category        InstrumentSetCategory

  // Status
  status          InstrumentSetStatus  @default(AVAILABLE)
  currentLocation String?              // Current location/room

  // Tracking
  lastSterilizedAt DateTime?
  lastUsedAt      DateTime?
  useCount        Int                  @default(0)
  sterilizationCount Int               @default(0)

  // Lifecycle
  assemblyDate    DateTime?            // When set was assembled
  expirationDays  Int?                 // How many days after sterilization set expires
  maxUses         Int?                 // Maximum uses before replacement

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?            // Soft delete
  createdBy       String?              @db.ObjectId
  updatedBy       String?              @db.ObjectId

  @@unique([clinicId, setNumber])
  @@index([clinicId])
  @@index([status])
  @@index([category])
  @@index([barcode])
  @@map("instrument_sets")
}

enum InstrumentSetCategory {
  ORTHODONTIC      // Ortho-specific instruments
  BONDING          // Bracket bonding instruments
  DEBONDING        // Bracket removal instruments
  ADJUSTMENT       // Wire adjustment tools
  IMPRESSION       // Impression instruments
  SURGICAL         // Minor surgical instruments
  GENERAL          // General dental instruments
  HYGIENE          // Hygiene instruments
  OTHER
}

enum InstrumentSetStatus {
  AVAILABLE        // Sterile and ready for use
  IN_USE           // Currently being used
  DIRTY            // Used, awaiting sterilization
  PROCESSING       // In sterilization process
  QUARANTINE       // Awaiting biological indicator results
  MAINTENANCE      // Under repair/inspection
  RETIRED          // No longer in service
}

/// ComplianceLog - Regulatory compliance documentation
model ComplianceLog {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Log identification
  logType         ComplianceLogType
  logDate         DateTime             @default(now())

  // Reference (what this log is about)
  referenceType   String?              // e.g., "SterilizationCycle", "BiologicalIndicator"
  referenceId     String?              @db.ObjectId

  // Details
  title           String
  description     String?
  action          String?              // What action was taken
  outcome         String?              // Result/outcome

  // Compliance status
  isCompliant     Boolean              @default(true)
  deficiencyFound Boolean              @default(false)
  correctiveAction String?             // Corrective action taken

  // Performed by
  performedById   String               @db.ObjectId
  reviewedById    String?              @db.ObjectId
  reviewedAt      DateTime?

  // Attachments
  attachments     String[]             // URLs to attached documents

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([clinicId])
  @@index([logType])
  @@index([logDate])
  @@index([isCompliant])
  @@map("compliance_logs")
}

enum ComplianceLogType {
  WEEKLY_BI_TEST   // Weekly biological indicator test
  MONTHLY_AUDIT    // Monthly sterilization audit
  EQUIPMENT_VALIDATION // Sterilizer validation/certification
  INCIDENT_REPORT  // Sterilization failure or incident
  CORRECTIVE_ACTION // Corrective action documentation
  TRAINING_RECORD  // Staff training documentation
  INSPECTION       // External inspection record
  POLICY_REVIEW    // Policy/procedure review
  OTHER
}

// ============================================================================
// INSTRUMENT PACKAGE & PATIENT LINKING
// ============================================================================

/// InstrumentPackage - Sterilized packages with QR codes for patient tracking
model InstrumentPackage {
  id                String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String               @db.ObjectId

  // Package Identification
  packageNumber     String               // Unique identifier (e.g., "PKG-2024-001234")
  qrCode            String               // QR code content (ORCA-STERIL-...)

  // Package Type
  packageType       PackageType

  // Sterilization Link
  cycleId           String               @db.ObjectId
  sterilizedDate    DateTime             // Date package was sterilized
  expirationDate    DateTime             // Calculated expiration date

  // Contents
  instrumentSetId   String?              @db.ObjectId  // Link to InstrumentSet if applicable
  instrumentNames   String[]             // Names of instruments in package
  itemCount         Int                  @default(1)   // Number of items in package
  cassetteName      String?              // If using cassette system

  // Status
  status            PackageStatus        @default(STERILE)

  // Prepared by
  preparedById      String               @db.ObjectId
  preparedAt        DateTime             @default(now())

  // Notes
  notes             String?

  // Timestamps & Audit
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  createdBy         String?              @db.ObjectId
  updatedBy         String?              @db.ObjectId

  // Relations
  cycle             SterilizationCycle   @relation(fields: [cycleId], references: [id])
  usages            PackageUsage[]

  @@unique([clinicId, packageNumber])
  @@unique([qrCode])
  @@index([clinicId])
  @@index([cycleId])
  @@index([status])
  @@index([expirationDate])
  @@index([instrumentSetId])
  @@map("instrument_packages")
}

enum PackageType {
  CASSETTE_FULL    // Full-size cassette
  CASSETTE_EXAM    // Exam cassette
  POUCH            // Sterilization pouch
  WRAPPED          // Wrapped instruments
  INDIVIDUAL       // Individual instrument
}

enum PackageStatus {
  STERILE          // Sterile and ready for use
  USED             // Has been used with a patient
  EXPIRED          // Past expiration date
  COMPROMISED      // Packaging integrity compromised
  RECALLED         // Recalled due to sterilization failure
}

/// PackageUsage - Records when a sterilized package is used with a patient
model PackageUsage {
  id                String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String               @db.ObjectId

  // Package Link
  packageId         String               @db.ObjectId

  // Patient Link
  patientId         String               @db.ObjectId
  appointmentId     String?              @db.ObjectId

  // Usage Details
  usedAt            DateTime             @default(now())
  usedById          String               @db.ObjectId  // Staff member who used/recorded
  procedureType     String?              // Type of procedure performed
  procedureNotes    String?              // Notes about the procedure

  // Verification
  verifiedPackage   Boolean              @default(true)  // Package was verified as sterile
  verificationNotes String?              // Notes if there were any concerns

  // Notes
  notes             String?

  // Timestamps
  createdAt         DateTime             @default(now())

  // Relations
  package           InstrumentPackage    @relation(fields: [packageId], references: [id])

  @@index([clinicId])
  @@index([packageId])
  @@index([patientId])
  @@index([appointmentId])
  @@index([usedAt])
  @@map("package_usages")
}

// -----------------------------------------------------------------------------
// Sterilizer Validation - Equipment validation and qualification tracking
// -----------------------------------------------------------------------------

/// SterilizerValidation - Validation records for sterilization equipment
model SterilizerValidation {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String           @db.ObjectId
  equipmentId       String           @db.ObjectId

  // Validation type
  validationType    ValidationType

  // Dates
  validationDate    DateTime
  nextValidationDue DateTime?

  // Results
  result            ValidationResult
  parameters        Json?            // Test parameters and measurements

  // Documentation
  performedBy       String           // Can be vendor or staff name
  performedById     String?          @db.ObjectId  // If internal staff
  vendorName        String?
  technicianName    String?

  // Certificates
  certificateNumber String?
  certificateUrl    String?
  certificateExpiry DateTime?

  // For failures
  failureDetails    String?
  correctiveAction  String?
  retestDate        DateTime?
  retestResult      ValidationResult?

  // Related maintenance
  maintenanceRecordId String?        @db.ObjectId

  // Notes
  notes             String?

  // Timestamps & Audit
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  createdBy         String           @db.ObjectId

  @@index([clinicId])
  @@index([equipmentId])
  @@index([validationDate])
  @@index([validationType])
  @@index([nextValidationDue])
  @@index([result])
  @@map("sterilizer_validations")
}

/// ValidationSchedule - Recurring validation schedules for sterilization equipment
model ValidationSchedule {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String           @db.ObjectId
  equipmentId       String           @db.ObjectId

  // Schedule details
  validationType    ValidationType
  frequencyDays     Int              // How often (365 for annual, 1 for daily)
  isActive          Boolean          @default(true)

  // Last/Next
  lastPerformed     DateTime?
  nextDue           DateTime?

  // Reminders
  reminderDays      Int              @default(30)  // Days before to remind
  reminderSent      Boolean          @default(false)

  // Notes
  notes             String?

  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  createdBy         String?          @db.ObjectId

  @@unique([equipmentId, validationType])
  @@index([clinicId])
  @@index([equipmentId])
  @@index([nextDue])
  @@index([isActive])
  @@map("validation_schedules")
}

enum ValidationType {
  INSTALLATION_QUALIFICATION   // Initial installation verification (IQ)
  OPERATIONAL_QUALIFICATION    // Functionality verification (OQ)
  PERFORMANCE_QUALIFICATION    // Performance verification (PQ)
  BOWIE_DICK_TEST              // Steam penetration test (daily for prevac)
  LEAK_RATE_TEST               // Vacuum leak test
  CALIBRATION                  // Temperature/pressure calibration
  PREVENTIVE_MAINTENANCE       // Scheduled PM
  REPAIR_VERIFICATION          // Post-repair testing
  ANNUAL_VALIDATION            // Comprehensive annual validation
}

enum ValidationResult {
  PASS          // All criteria met
  FAIL          // Failed one or more criteria
  CONDITIONAL   // Pass with conditions/notes
}

// -----------------------------------------------------------------------------
// Compliance Reporting - Generated reports and compliance status tracking
// -----------------------------------------------------------------------------

/// ComplianceReport - Generated compliance reports for sterilization
model ComplianceReport {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Report details
  reportType      ComplianceReportType
  reportName      String
  dateRangeStart  DateTime
  dateRangeEnd    DateTime

  // Generation
  generatedAt     DateTime             @default(now())
  generatedBy     String               @db.ObjectId
  format          ReportFormat

  // Content
  reportData      Json?                // Report data snapshot
  fileUrl         String?              // Generated file URL

  // Status
  status          ReportStatus         @default(GENERATING)

  // Metadata
  parameters      Json?                // Report parameters used

  // Timestamps
  createdAt       DateTime             @default(now())

  @@index([clinicId])
  @@index([reportType])
  @@index([generatedAt])
  @@index([status])
  @@map("compliance_reports")
}

/// ComplianceStatus - Real-time compliance status snapshot for clinics
model ComplianceStatus {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Status date
  statusDate      DateTime             @default(now())

  // Biological Testing Metrics
  biologicalTestingCompliant Boolean
  lastBiologicalTest        DateTime?
  daysSinceLastTest         Int?

  // Cycle Documentation Metrics
  cycleDocumentationComplete Boolean
  cyclesThisPeriod          Int
  cyclesWithIssues          Int

  // Instrument Tracking Metrics
  instrumentTrackingCurrent Boolean
  setsInService             Int
  setsInQuarantine          Int

  // Equipment Validation Metrics
  equipmentValidationCurrent Boolean
  equipmentDueValidation    Int

  // Overall
  overallCompliant          Boolean
  complianceScore           Float?       // Percentage 0-100

  // Issues
  openIssues                Json?        // List of compliance issues

  // Timestamps
  calculatedAt              DateTime     @default(now())

  @@index([clinicId])
  @@index([statusDate])
  @@index([overallCompliant])
  @@map("compliance_statuses")
}

enum ComplianceReportType {
  DAILY_STERILIZATION_LOG
  WEEKLY_BIOLOGICAL_SUMMARY
  MONTHLY_COMPLIANCE_SUMMARY
  INSTRUMENT_SET_INVENTORY
  EQUIPMENT_VALIDATION
  FAILURE_INVESTIGATION
  AUDIT_TRAIL
  CUSTOM
}

enum ReportFormat {
  PDF
  CSV
  EXCEL
  HTML
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
}

// =============================================================================
// INVENTORY MANAGEMENT - Supplies, Stock, Purchase Orders, Transfers
// =============================================================================

// -----------------------------------------------------------------------------
// Inventory Item - Product catalog for orthodontic supplies and consumables
// -----------------------------------------------------------------------------

/// InventoryItem - Catalog of orthodontic supplies and consumables
model InventoryItem {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Identification
  name            String         // e.g., "3M Clarity Ceramic Brackets"
  sku             String         // Unique SKU within clinic
  barcode         String?        // Barcode/UPC for scanning
  upc             String?        // Universal Product Code

  // Classification
  category        InventoryCategory
  subcategory     String?        // e.g., "Self-Ligating" for brackets
  brand           String?        // e.g., "3M", "Ormco"
  manufacturer    String?

  // Specifications
  description     String?
  specifications  Json?          // Flexible specs (size, color, material, etc.)
  size            String?        // e.g., "Small", "0.014", "MBT"
  color           String?        // e.g., "Clear", "Silver", "Red"
  material        String?        // e.g., "Ceramic", "Stainless Steel", "NiTi"

  // Supplier Info
  supplierId      String?        @db.ObjectId
  supplierSku     String?        // Supplier's product code
  alternateSupplierIds String[]  @db.ObjectId  // Backup suppliers

  // Pricing
  unitCost        Float          // Standard unit cost
  lastCost        Float?         // Most recent purchase cost
  averageCost     Float?         // Weighted average cost
  unitOfMeasure   String         @default("EACH")  // EACH, BOX, PACK, ROLL
  unitsPerPackage Int            @default(1)
  packageDescription String?     // e.g., "Box of 20 brackets"

  // Stock Levels
  currentStock    Int            @default(0)
  reservedStock   Int            @default(0)      // Reserved for scheduled procedures
  availableStock  Int            @default(0)      // currentStock - reservedStock

  // Reorder Settings
  reorderPoint    Int            @default(10)     // Alert when stock falls below
  reorderQuantity Int            @default(20)     // Standard order quantity
  safetyStock     Int            @default(5)      // Minimum buffer stock
  maxStock        Int?                            // Maximum stock limit
  leadTimeDays    Int            @default(7)      // Expected delivery time

  // Tracking Options
  trackLots       Boolean        @default(false)  // Enable lot/batch tracking
  trackExpiry     Boolean        @default(true)   // Track expiration dates
  trackSerial     Boolean        @default(false)  // Serial number tracking

  // Storage
  storageLocation String?        // e.g., "Cabinet A, Shelf 2"
  storageRequirements String?    // e.g., "Refrigerate", "Keep dry"

  // Status
  status          InventoryItemStatus @default(ACTIVE)
  isOrderable     Boolean        @default(true)

  // Documents
  msdsUrl         String?        // Material Safety Data Sheet
  imageUrl        String?        // Product image
  documents       String[]       // Additional document URLs

  // Usage Stats (cached/calculated)
  averageDailyUsage Float?
  lastUsedAt      DateTime?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  supplier        Supplier?      @relation(fields: [supplierId], references: [id])
  lots            InventoryLot[]
  stockMovements  StockMovement[]
  purchaseOrderItems PurchaseOrderItem[]
  reorderAlerts   ReorderAlert[]
  transferItems   TransferItem[]

  @@unique([clinicId, sku])
  @@index([clinicId])
  @@index([category])
  @@index([supplierId])
  @@index([status])
  @@index([currentStock])
  @@index([barcode])
  @@index([name])
  @@map("inventory_items")
}

enum InventoryCategory {
  BRACKETS        // Metal, ceramic, self-ligating, lingual
  WIRES           // NiTi, stainless steel, TMA, copper NiTi
  ELASTICS        // Power chains, ligatures, separators
  BANDS           // Molar bands, pre-welded
  BONDING         // Adhesives, primers, etchants
  IMPRESSION      // Alginate, PVS, bite registration
  RETAINERS       // Clear retainer material, Hawley
  INSTRUMENTS     // Disposable instruments
  DISPOSABLES     // Single-use clinical items
  PPE             // Personal protective equipment
  OFFICE_SUPPLIES // Non-clinical supplies
  CLEANING        // Sterilization and cleaning supplies
  OTHER
}

enum InventoryItemStatus {
  ACTIVE          // Currently in use
  DISCONTINUED    // No longer available from supplier
  BACKORDERED     // Temporarily unavailable
  INACTIVE        // Not currently ordering
  PENDING_APPROVAL // Awaiting approval to add
}

// -----------------------------------------------------------------------------
// Inventory Lot - Lot/batch tracking for traceability
// -----------------------------------------------------------------------------

/// InventoryLot - Lot/batch tracking for supplies with expiration dates
model InventoryLot {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  itemId          String         @db.ObjectId

  // Lot Identification
  lotNumber       String         // Manufacturer lot/batch number
  serialNumbers   String[]       // Serial numbers if tracking enabled

  // Quantities
  initialQuantity Int            // Quantity received
  currentQuantity Int            // Current remaining quantity
  reservedQuantity Int           @default(0)

  // Dates
  receivedDate    DateTime       // Date received into inventory
  manufacturingDate DateTime?    // Manufacturing date if known
  expirationDate  DateTime?      // Expiration date

  // Source
  purchaseOrderId String?        @db.ObjectId
  supplierId      String?        @db.ObjectId

  // Cost
  unitCost        Float?         // Cost per unit for this lot

  // Location
  storageLocation String?        // Where this lot is stored

  // Status
  status          LotStatus      @default(AVAILABLE)
  quarantineReason String?       // Reason if quarantined

  // Expiration Alerts
  expirationAlertSent Boolean    @default(false)
  expirationAlertDates Json?     // Track which alerts sent

  // Extension Documentation (if expiration extended)
  originalExpirationDate DateTime?
  extensionReason String?
  extensionApprovedBy String?    @db.ObjectId
  extensionDocument String?      // URL to documentation

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  item            InventoryItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  stockMovements  StockMovement[]
  expirationAlerts ExpirationAlert[]
  transferItems   TransferItem[]

  @@unique([clinicId, itemId, lotNumber])
  @@index([clinicId])
  @@index([itemId])
  @@index([expirationDate])
  @@index([status])
  @@index([lotNumber])
  @@map("inventory_lots")
}

enum LotStatus {
  AVAILABLE       // Ready for use
  RESERVED        // Reserved for specific use
  DEPLETED        // Fully consumed
  EXPIRED         // Past expiration date
  RECALLED        // Manufacturer recall
  QUARANTINE      // Held for investigation
  DAMAGED         // Cannot be used
}

// -----------------------------------------------------------------------------
// Stock Movement - Audit trail for all inventory changes
// -----------------------------------------------------------------------------

/// StockMovement - Record of all inventory changes
model StockMovement {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  itemId          String         @db.ObjectId
  lotId           String?        @db.ObjectId

  // Movement Details
  movementType    StockMovementType
  quantity        Int            // Positive for additions, negative for removals
  unitCost        Float?         // Cost at time of movement

  // Reference
  referenceType   MovementReferenceType?
  referenceId     String?        @db.ObjectId

  // Usage Context (when applicable)
  patientId       String?        @db.ObjectId
  appointmentId   String?        @db.ObjectId
  procedureId     String?        @db.ObjectId
  providerId      String?        @db.ObjectId

  // Transfer Context
  fromLocationId  String?        @db.ObjectId
  toLocationId    String?        @db.ObjectId
  transferId      String?        @db.ObjectId

  // Stock Snapshot
  previousStock   Int            // Stock before this movement
  newStock        Int            // Stock after this movement

  // Notes
  reason          String?        // Required for adjustments
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  createdBy       String         @db.ObjectId

  // Relations
  item            InventoryItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  lot             InventoryLot?  @relation(fields: [lotId], references: [id])
  transfer        InventoryTransfer? @relation(fields: [transferId], references: [id])

  @@index([clinicId])
  @@index([itemId])
  @@index([lotId])
  @@index([movementType])
  @@index([createdAt])
  @@index([patientId])
  @@index([providerId])
  @@index([transferId])
  @@map("stock_movements")
}

enum StockMovementType {
  RECEIVED            // From purchase order
  USED                // Used in treatment
  ADJUSTMENT_ADD      // Manual increase
  ADJUSTMENT_REMOVE   // Manual decrease
  TRANSFER_IN         // From another location
  TRANSFER_OUT        // To another location
  RETURNED_TO_SUPPLIER
  RETURNED_FROM_PATIENT
  EXPIRED             // Removed due to expiration
  DAMAGED             // Removed due to damage
  LOST                // Unaccounted for
  RECALLED            // Manufacturer recall
  OPENING_BALANCE     // Initial stock setup
  COUNT_VARIANCE      // Physical count adjustment
}

enum MovementReferenceType {
  PURCHASE_ORDER
  TRANSFER
  ADJUSTMENT
  PATIENT_TREATMENT
  RETURN
  RECALL
  INVENTORY_COUNT
}

// -----------------------------------------------------------------------------
// Purchase Orders - Procurement workflow
// -----------------------------------------------------------------------------

/// PurchaseOrder - Order for supplies from suppliers
model PurchaseOrder {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  supplierId      String         @db.ObjectId

  // Order Identification
  poNumber        String         // PO-2024-00001 format
  externalPoNumber String?       // Supplier's order number

  // Status
  status          PurchaseOrderStatus @default(DRAFT)

  // Dates
  orderDate       DateTime?      // When submitted to supplier
  expectedDate    DateTime?      // Expected delivery date
  receivedDate    DateTime?      // When fully received

  // Amounts
  subtotal        Float          @default(0)
  taxAmount       Float          @default(0)
  shippingAmount  Float          @default(0)
  discountAmount  Float          @default(0)
  totalAmount     Float          @default(0)

  // Shipping
  shipTo          Json?          // Shipping address
  shippingMethod  String?
  trackingNumber  String?

  // Payment
  paymentTerms    String?        // e.g., "Net 30"
  invoiceNumber   String?
  invoiceDate     DateTime?

  // Approval
  approvalRequired Boolean       @default(false)
  approvalThreshold Float?       // Amount requiring approval
  approvedBy      String?        @db.ObjectId
  approvedAt      DateTime?
  rejectedBy      String?        @db.ObjectId
  rejectedAt      DateTime?
  rejectionReason String?

  // Notes
  notes           String?        // External notes (visible on PO)
  internalNotes   String?        // Internal notes only

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String         @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  supplier        Supplier       @relation(fields: [supplierId], references: [id])
  items           PurchaseOrderItem[]
  receipts        PurchaseOrderReceipt[]
  lots            InventoryLot[]

  @@unique([clinicId, poNumber])
  @@index([clinicId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@index([poNumber])
  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  DRAFT             // Being created
  PENDING_APPROVAL  // Awaiting approval
  APPROVED          // Approved, ready to submit
  REJECTED          // Approval rejected
  SUBMITTED         // Sent to supplier
  ACKNOWLEDGED      // Supplier confirmed
  PARTIALLY_RECEIVED // Some items received
  RECEIVED          // All items received
  CLOSED            // Complete, invoiced
  CANCELLED         // Order cancelled
}

/// PurchaseOrderItem - Line items on a purchase order
model PurchaseOrderItem {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  purchaseOrderId String         @db.ObjectId
  itemId          String         @db.ObjectId

  // Item Details
  lineNumber      Int            // Line sequence
  description     String         // Item description
  sku             String         // Item SKU
  supplierSku     String?        // Supplier's SKU

  // Quantities
  orderedQuantity Int
  receivedQuantity Int           @default(0)
  backorderedQuantity Int        @default(0)

  // Pricing
  unitPrice       Float
  discountPercent Float          @default(0)
  lineTotal       Float

  // Status
  status          POItemStatus   @default(ORDERED)

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  purchaseOrder   PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item            InventoryItem  @relation(fields: [itemId], references: [id])

  @@index([purchaseOrderId])
  @@index([itemId])
  @@map("purchase_order_items")
}

enum POItemStatus {
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  BACKORDERED
  CANCELLED
}

/// PurchaseOrderReceipt - Receiving records for purchase orders
model PurchaseOrderReceipt {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  purchaseOrderId String         @db.ObjectId

  // Receipt Details
  receiptNumber   String         // RCV-2024-00001 format
  receiptDate     DateTime       @default(now())

  // Shipping Info
  packingSlipNumber String?
  carrierName     String?
  trackingNumber  String?

  // Items Received (with lot info)
  items           Json           // Array of { itemId, quantity, lotNumber, expirationDate }

  // Notes
  notes           String?
  damageNotes     String?        // Document any damaged items

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  createdBy       String         @db.ObjectId

  // Relations
  purchaseOrder   PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([purchaseOrderId])
  @@index([receiptDate])
  @@index([receiptNumber])
  @@map("purchase_order_receipts")
}

// -----------------------------------------------------------------------------
// Inventory Transfers - Multi-location inventory movement
// -----------------------------------------------------------------------------

/// InventoryTransfer - Transfer supplies between clinic locations
model InventoryTransfer {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  fromClinicId    String         @db.ObjectId
  toClinicId      String         @db.ObjectId

  // Transfer Identification
  transferNumber  String         // TRF-2024-00001 format

  // Status
  status          TransferStatus @default(REQUESTED)

  // Dates
  requestedDate   DateTime       @default(now())
  approvedDate    DateTime?
  shippedDate     DateTime?
  receivedDate    DateTime?

  // People
  requestedBy     String         @db.ObjectId
  approvedBy      String?        @db.ObjectId
  rejectedBy      String?        @db.ObjectId
  shippedBy       String?        @db.ObjectId
  receivedBy      String?        @db.ObjectId

  // Rejection
  rejectionReason String?

  // Shipping
  shippingMethod  String?
  trackingNumber  String?
  carrierName     String?

  // Notes
  reason          String?        // Why the transfer is needed
  notes           String?

  // Priority
  isUrgent        Boolean        @default(false)
  urgentReason    String?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  fromClinic      Clinic           @relation("TransfersFrom", fields: [fromClinicId], references: [id])
  toClinic        Clinic           @relation("TransfersTo", fields: [toClinicId], references: [id])
  items           TransferItem[]
  stockMovements  StockMovement[]

  @@unique([transferNumber])
  @@index([fromClinicId])
  @@index([toClinicId])
  @@index([status])
  @@index([requestedDate])
  @@map("inventory_transfers")
}

enum TransferStatus {
  REQUESTED       // Request submitted
  APPROVED        // Approved by source location
  REJECTED        // Request rejected
  PREPARING       // Being picked/packed
  IN_TRANSIT      // Shipped
  RECEIVED        // Received at destination
  CANCELLED       // Cancelled before completion
}

/// TransferItem - Line items on an inventory transfer
model TransferItem {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  transferId      String         @db.ObjectId
  itemId          String         @db.ObjectId
  lotId           String?        @db.ObjectId

  // Quantities
  requestedQuantity Int
  approvedQuantity Int?
  shippedQuantity Int?
  receivedQuantity Int?

  // Status
  status          TransferItemStatus @default(REQUESTED)

  // Variance
  varianceReason  String?        // Reason for quantity differences

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  transfer        InventoryTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  item            InventoryItem     @relation(fields: [itemId], references: [id])
  lot             InventoryLot?     @relation(fields: [lotId], references: [id])

  @@index([transferId])
  @@index([itemId])
  @@map("transfer_items")
}

enum TransferItemStatus {
  REQUESTED
  APPROVED
  PARTIALLY_APPROVED
  REJECTED
  SHIPPED
  RECEIVED
  VARIANCE
}

// -----------------------------------------------------------------------------
// Reorder Alerts - Low stock notifications
// -----------------------------------------------------------------------------

/// ReorderAlert - Low stock alert for inventory items
model ReorderAlert {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  itemId          String         @db.ObjectId

  // Alert Details
  alertType       ReorderAlertType
  alertDate       DateTime       @default(now())

  // Stock Info at Alert Time
  currentStock    Int
  reorderPoint    Int
  suggestedQuantity Int

  // Status
  status          AlertStatus    @default(ACTIVE)
  dismissedAt     DateTime?
  dismissedBy     String?        @db.ObjectId
  dismissReason   String?

  // Resolution
  purchaseOrderId String?        @db.ObjectId
  resolvedAt      DateTime?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  item            InventoryItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([itemId])
  @@index([status])
  @@index([alertDate])
  @@index([alertType])
  @@map("reorder_alerts")
}

enum ReorderAlertType {
  LOW_STOCK         // Below reorder point
  CRITICAL_STOCK    // Below safety stock
  OUT_OF_STOCK      // Zero stock
  APPROACHING_LOW   // Projected to be low soon
}

enum AlertStatus {
  ACTIVE            // Needs attention
  DISMISSED         // Manually dismissed
  ORDERED           // Purchase order created
  RESOLVED          // Stock replenished
}

// -----------------------------------------------------------------------------
// Expiration Alerts - Expiring inventory notifications
// -----------------------------------------------------------------------------

/// ExpirationAlert - Alert for expiring inventory lots
model ExpirationAlert {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  itemId          String         @db.ObjectId
  lotId           String         @db.ObjectId

  // Alert Details
  alertLevel      ExpirationAlertLevel
  alertDate       DateTime       @default(now())
  expirationDate  DateTime
  daysUntilExpiry Int

  // Quantity at Risk
  quantity        Int
  estimatedValue  Float?

  // Status
  status          ExpirationAlertStatus @default(ACTIVE)
  action          ExpirationAction?
  actionDate      DateTime?
  actionBy        String?        @db.ObjectId
  actionNotes     String?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  lot             InventoryLot   @relation(fields: [lotId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([itemId])
  @@index([lotId])
  @@index([status])
  @@index([alertLevel])
  @@index([expirationDate])
  @@map("expiration_alerts")
}

enum ExpirationAlertLevel {
  WARNING         // 90 days before
  CAUTION         // 60 days before
  URGENT          // 30 days before
  CRITICAL        // 7 days or less
  EXPIRED         // Past expiration
}

enum ExpirationAlertStatus {
  ACTIVE          // Needs attention
  ACKNOWLEDGED    // Seen, no action yet
  RESOLVED        // Action taken
}

enum ExpirationAction {
  USED            // Prioritized and consumed
  RETURNED        // Returned to supplier
  DISCARDED       // Disposed of
  EXTENDED        // Expiration extended
  TRANSFERRED     // Sent to another location
}

// -----------------------------------------------------------------------------
// Usage Analytics - Aggregated usage data for reporting
// -----------------------------------------------------------------------------

/// UsageAnalyticsSummary - Aggregated usage data for analytics
model UsageAnalyticsSummary {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  itemId          String         @db.ObjectId

  // Period
  period          String         // YYYY-MM format
  periodType      AnalyticsPeriodType

  // Usage Metrics
  totalQuantity   Int
  totalValue      Float

  // Breakdowns (JSON for flexibility)
  byProvider      Json?          // { providerId: quantity }
  byProcedure     Json?          // { procedureType: quantity }
  byDayOfWeek     Json?          // { day: quantity }

  // Calculations
  averageDailyUsage Float?
  variance        Float?         // vs. previous period
  variancePercent Float?

  // Timestamps
  calculatedAt    DateTime       @default(now())

  @@unique([clinicId, itemId, period, periodType])
  @@index([clinicId])
  @@index([itemId])
  @@index([period])
  @@index([periodType])
  @@map("usage_analytics_summaries")
}

enum AnalyticsPeriodType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

/// WasteRecord - Record of wasted inventory
model WasteRecord {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  itemId          String         @db.ObjectId
  lotId           String?        @db.ObjectId

  // Waste Details
  wasteType       WasteType
  wasteDate       DateTime       @default(now())
  quantity        Int
  unitCost        Float
  totalValue      Float

  // Context
  reason          String?
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  createdBy       String         @db.ObjectId

  @@index([clinicId])
  @@index([itemId])
  @@index([wasteType])
  @@index([wasteDate])
  @@map("waste_records")
}

enum WasteType {
  EXPIRED
  DAMAGED
  LOST
  RECALLED
  CONTAMINATED
  OTHER
}

// =============================================================================
// BOOKING & SCHEDULING AREA - Appointments, calendar management, scheduling
// =============================================================================

// -----------------------------------------------------------------------------
// Appointment Types - Configurable types of appointments
// -----------------------------------------------------------------------------

/// AppointmentType - Defines types of appointments (Scan, Adjustment, Bonding, etc.)
model AppointmentType {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String   @db.ObjectId

  // Identification
  code             String   // Unique code within clinic (e.g., "SCAN", "ADJ", "BOND")
  name             String   // Display name (e.g., "Scan Appointment", "Adjustment")
  description      String?

  // Duration settings (in minutes)
  defaultDuration  Int      // Default appointment duration
  minDuration      Int?     // Minimum allowed duration
  maxDuration      Int?     // Maximum allowed duration

  // Visual settings
  color            String   // Hex color for calendar display (e.g., "#3B82F6")
  icon             String?  // Icon identifier

  // Resource requirements
  requiresChair    Boolean  @default(true)  // Requires treatment chair
  requiresRoom     Boolean  @default(false) // Requires specific room

  // Buffer times (in minutes)
  prepTime         Int      @default(0)     // Preparation time before
  cleanupTime      Int      @default(0)     // Cleanup time after

  // Configuration
  isActive         Boolean  @default(true)  // Available for booking
  allowOnline      Boolean  @default(false) // Can be booked via patient portal
  sortOrder        Int      @default(0)     // Display order in lists

  // Timestamps & Audit
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime?                // Soft delete
  createdBy        String?  @db.ObjectId
  updatedBy        String?  @db.ObjectId

  // Relations
  clinic           Clinic   @relation(fields: [clinicId], references: [id])
  appointments     Appointment[]
  waitlistEntries  WaitlistEntry[]
  recurringAppointments RecurringAppointment[]

  @@unique([clinicId, code])
  @@index([clinicId])
  @@index([isActive])
  @@map("appointment_types")
}

// -----------------------------------------------------------------------------
// Appointments - Core appointment records
// -----------------------------------------------------------------------------

/// Appointment status lifecycle
enum AppointmentStatus {
  SCHEDULED       // Appointment booked, not yet confirmed
  CONFIRMED       // Patient confirmed attendance
  ARRIVED         // Patient has arrived at clinic
  IN_PROGRESS     // Appointment in progress
  COMPLETED       // Appointment completed
  NO_SHOW         // Patient did not show up
  CANCELLED       // Appointment cancelled
}

/// Confirmation status for appointment
enum ConfirmationStatus {
  UNCONFIRMED     // No confirmation sent yet
  PENDING         // Confirmation sent, awaiting response
  CONFIRMED       // Patient confirmed
  DECLINED        // Patient declined, needs reschedule
}

/// Source of appointment booking
enum AppointmentSource {
  STAFF           // Booked by staff in-person or phone
  PHONE           // Specifically phone booking
  ONLINE          // Patient self-service booking
  WAITLIST        // Booked from waitlist opening
  TREATMENT_PLAN  // Auto-generated from treatment plan
  RECALL          // Generated from recall system
}

/// Appointment - Scheduled patient appointment
model Appointment {
  id                   String             @id @default(auto()) @map("_id") @db.ObjectId
  clinicId             String             @db.ObjectId
  patientId            String             @db.ObjectId

  // Timing
  startTime            DateTime
  endTime              DateTime
  duration             Int                // Duration in minutes

  // Type and assignment
  appointmentTypeId    String             @db.ObjectId
  providerId           String             @db.ObjectId
  chairId              String?            @db.ObjectId
  roomId               String?            @db.ObjectId

  // Status tracking
  status               AppointmentStatus      @default(SCHEDULED)
  confirmationStatus   ConfirmationStatus     @default(UNCONFIRMED)

  // Confirmation details
  confirmedAt          DateTime?
  confirmedBy          String?            // "patient", "staff", "auto"

  // Check-in flow
  arrivedAt            DateTime?
  checkedInBy          String?            @db.ObjectId
  startedAt            DateTime?
  completedAt          DateTime?

  // Cancellation details
  cancelledAt          DateTime?
  cancelledBy          String?            @db.ObjectId
  cancellationReason   String?

  // No-show tracking
  markedNoShowAt       DateTime?
  noShowReason         String?

  // Booking info
  source               AppointmentSource  @default(STAFF)
  bookedBy             String             @db.ObjectId
  bookedAt             DateTime           @default(now())

  // Notes
  notes                String?            // Internal staff notes
  patientNotes         String?            // Notes visible to patient

  // Timestamps & Audit
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  deletedAt            DateTime?          // Soft delete

  // Relations
  clinic               Clinic             @relation(fields: [clinicId], references: [id])
  patient              Patient            @relation(fields: [patientId], references: [id])
  appointmentType      AppointmentType    @relation(fields: [appointmentTypeId], references: [id])
  provider             StaffProfile       @relation("AppointmentProvider", fields: [providerId], references: [id])
  chair                TreatmentChair?    @relation(fields: [chairId], references: [id])
  room                 Room?              @relation(fields: [roomId], references: [id])
  reminders            AppointmentReminder[]

  // Practice Orchestration relations
  patientFlowState     PatientFlowState?
  resourceOccupancy    ResourceOccupancy?
  staffAssignments     StaffAssignment[]

  // Imaging Management relations
  patientImages        PatientImage[]
  progressReports      ProgressReport[]

  @@index([clinicId])
  @@index([patientId])
  @@index([providerId])
  @@index([appointmentTypeId])
  @@index([startTime])
  @@index([status])
  @@index([chairId])
  @@map("appointments")
}

// =============================================================================
// WAITLIST & RECOVERY - Waitlist management, cancellation tracking, recovery
// =============================================================================

/// WaitlistEntry - Patient waiting for an appointment
model WaitlistEntry {
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String              @db.ObjectId
  patientId             String              @db.ObjectId

  // Waitlist details
  appointmentTypeId     String              @db.ObjectId
  priority              WaitlistPriority    @default(STANDARD)
  status                WaitlistStatus      @default(ACTIVE)

  // Preferences
  preferredProviderId   String?             @db.ObjectId
  dateRangeStart        DateTime?
  dateRangeEnd          DateTime?
  preferredTimes        String[]            // "MORNING", "AFTERNOON", "EVENING"
  preferredDays         Int[]               // 0-6 (Sunday-Saturday)

  // Notes
  notes                 String?
  reasonForWaitlist     String?

  // Expiration
  expiresAt             DateTime?

  // Tracking
  position              Int?                // Dynamic position in queue
  addedAt               DateTime            @default(now())
  addedBy               String              @db.ObjectId

  // Notifications tracking (simplified - full notifications on hold)
  notificationsSent     Int                 @default(0)
  lastNotifiedAt        DateTime?

  // Resolution
  resolvedAt            DateTime?
  resolvedBy            String?             @db.ObjectId
  resolution            WaitlistResolution?
  bookedAppointmentId   String?             @db.ObjectId

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  clinic                Clinic              @relation(fields: [clinicId], references: [id])
  patient               Patient             @relation(fields: [patientId], references: [id])
  appointmentType       AppointmentType     @relation(fields: [appointmentTypeId], references: [id])
  preferredProvider     StaffProfile?       @relation("WaitlistPreferredProvider", fields: [preferredProviderId], references: [id])
  openingNotifications  OpeningNotification[]

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([priority])
  @@index([appointmentTypeId])
  @@map("waitlist_entries")
}

enum WaitlistPriority {
  URGENT
  HIGH
  STANDARD
  FLEXIBLE
}

enum WaitlistStatus {
  ACTIVE
  NOTIFIED      // Currently being offered an opening
  BOOKED        // Successfully booked
  EXPIRED       // Entry expired
  REMOVED       // Manually removed
  DECLINED      // Patient declined all offers
}

enum WaitlistResolution {
  BOOKED
  EXPIRED
  PATIENT_REMOVED
  STAFF_REMOVED
  DECLINED_ALL_OFFERS
}

/// AppointmentCancellation - Detailed cancellation tracking
model AppointmentCancellation {
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String              @db.ObjectId
  appointmentId         String              @db.ObjectId
  patientId             String              @db.ObjectId

  // Cancellation details
  cancellationType      CancellationType
  cancelledAt           DateTime            @default(now())
  cancelledBy           String              @db.ObjectId
  cancelledByType       CancelledByType

  // Original appointment info (snapshot)
  originalStartTime     DateTime
  originalEndTime       DateTime
  originalProviderId    String              @db.ObjectId
  appointmentTypeId     String              @db.ObjectId

  // Reason
  reason                CancellationReason
  reasonDetails         String?

  // Notice period
  noticeHours           Float               // Hours before appointment
  isLateCancel          Boolean             @default(false)

  // Fee
  lateCancelFee         Float?
  feeWaived             Boolean             @default(false)
  feeWaivedReason       String?
  feeWaivedBy           String?             @db.ObjectId

  // Recovery tracking
  recoveryStatus        RecoveryStatus      @default(PENDING)
  recoveryAttempts      Int                 @default(0)
  lastRecoveryAttemptAt DateTime?
  recoveryNotes         String?
  rescheduledAppointmentId String?          @db.ObjectId

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  clinic                Clinic              @relation(fields: [clinicId], references: [id])
  patient               Patient             @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([appointmentId])
  @@index([cancelledAt])
  @@index([reason])
  @@index([recoveryStatus])
  @@map("appointment_cancellations")
}

enum CancellationType {
  CANCELLED       // Patient cancelled in advance
  LATE_CANCEL     // Cancelled within late cancel window
  NO_SHOW         // Patient didn't show up
  PRACTICE_CANCEL // Practice cancelled (provider sick, etc.)
}

enum CancelledByType {
  PATIENT
  STAFF
  SYSTEM
  PROVIDER
}

enum CancellationReason {
  SCHEDULE_CONFLICT
  ILLNESS
  TRANSPORTATION
  FORGOT
  FINANCIAL
  WEATHER
  FAMILY_EMERGENCY
  CHANGED_PROVIDERS
  PRACTICE_CLOSURE
  PROVIDER_UNAVAILABLE
  OTHER
}

enum RecoveryStatus {
  PENDING
  IN_PROGRESS
  RECOVERED
  LOST
  NOT_NEEDED
}

/// PatientRiskScore - Track patients at risk of dropping out
model PatientRiskScore {
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String              @db.ObjectId
  patientId             String              @db.ObjectId

  // Risk assessment
  riskScore             Float               // 0-100, higher = more at risk
  riskLevel             RiskLevel
  calculatedAt          DateTime            @default(now())

  // Risk factors (stored as JSON for flexibility)
  riskFactors           Json?               // Array of { factor, weight, description, value }

  // Recommendations
  recommendedActions    String[]

  // Status
  status                RiskStatus          @default(ACTIVE)
  reviewedAt            DateTime?
  reviewedBy            String?             @db.ObjectId
  reviewNotes           String?

  // Intervention tracking
  interventionStatus    InterventionStatus?
  interventionAt        DateTime?
  interventionBy        String?             @db.ObjectId
  interventionNotes     String?

  // Stats at time of calculation
  noShowCount           Int                 @default(0)
  cancelCount           Int                 @default(0)
  missedInRowCount      Int                 @default(0)
  daysSinceLastVisit    Int?
  totalAppointments     Int                 @default(0)

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  clinic                Clinic              @relation(fields: [clinicId], references: [id])
  patient               Patient             @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([riskLevel])
  @@index([status])
  @@map("patient_risk_scores")
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  ACTIVE
  REVIEWED
  RESOLVED
  DROPPED_OUT
}

enum InterventionStatus {
  PENDING
  IN_PROGRESS
  SUCCESSFUL
  UNSUCCESSFUL
}

// =============================================================================
// EMERGENCY & REMINDERS - Emergency appointments, on-call, reminders, confirmations
// =============================================================================

/// EmergencyAppointment - Emergency patient requests and triage
model EmergencyAppointment {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // Patient info
  patientId             String?               @db.ObjectId // Can be null for new patients
  patientName           String                // Name (for walk-ins without record)
  patientPhone          String
  patientEmail          String?

  // Emergency details
  emergencyType         EmergencyType
  severity              EmergencySeverity     @default(MEDIUM)
  description           String
  symptoms              String[]              // Additional symptoms
  onsetTime             DateTime?             // When did it start

  // Triage
  triageStatus          TriageStatus          @default(PENDING)
  triageNotes           String?
  triageCompletedAt     DateTime?
  triageCompletedBy     String?               @db.ObjectId
  selfCareInstructions  String?               // Instructions given to patient

  // Request channel
  requestChannel        RequestChannel        @default(PHONE)
  requestedAt           DateTime              @default(now())
  requestedBy           String?               @db.ObjectId // Staff who took the call

  // Resolution
  resolution            EmergencyResolution?
  resolvedAt            DateTime?
  resolvedBy            String?               @db.ObjectId
  resolutionNotes       String?

  // Appointment link (if scheduled)
  appointmentId         String?               @db.ObjectId
  scheduledFor          DateTime?

  // On-call handling
  onCallProviderId      String?               @db.ObjectId
  onCallNotifiedAt      DateTime?
  onCallAcknowledgedAt  DateTime?

  // After-hours flag
  isAfterHours          Boolean               @default(false)

  // Fee tracking
  emergencyFee          Float?
  feeWaived             Boolean               @default(false)
  feeWaivedReason       String?

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  patient               Patient?              @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([triageStatus])
  @@index([severity])
  @@index([requestedAt])
  @@map("emergency_appointments")
}

enum EmergencyType {
  BROKEN_BRACKET
  POKING_WIRE
  BROKEN_WIRE
  LOST_RETAINER
  LOOSE_BAND
  LOOSE_BRACKET
  APPLIANCE_IRRITATION
  TRAUMA_INJURY
  SEVERE_PAIN
  SWELLING_INFECTION
  LOST_ALIGNER
  BROKEN_RETAINER
  BROKEN_APPLIANCE
  OTHER
}

enum EmergencySeverity {
  LOW           // Can wait, self-care may resolve
  MEDIUM        // Should be seen within 24-48 hours
  HIGH          // Should be seen same-day
  CRITICAL      // Needs immediate attention, may need ER referral
}

enum TriageStatus {
  PENDING       // Awaiting triage
  IN_PROGRESS   // Being triaged
  COMPLETED     // Triage complete
  REFERRED      // Referred out (ER, general dentist)
}

enum RequestChannel {
  PHONE
  SMS
  WEB_FORM
  PATIENT_PORTAL
  WALK_IN
  AFTER_HOURS
  EMAIL
}

enum EmergencyResolution {
  APPOINTMENT_SCHEDULED
  SELF_CARE_RESOLVED
  REFERRED_GENERAL_DENTIST
  REFERRED_ER
  NO_ACTION_NEEDED
  PATIENT_NO_SHOW
  PATIENT_DECLINED
}

/// OnCallSchedule - Provider on-call assignments
model OnCallSchedule {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // Provider assignment
  providerId            String                @db.ObjectId
  providerName          String                // Denormalized for quick access

  // Schedule period
  startDate             DateTime
  endDate               DateTime
  startTime             String                // "17:00" format (after-hours start)
  endTime               String                // "08:00" format (next day)

  // Type
  type                  OnCallType            @default(PRIMARY)
  status                OnCallStatus          @default(SCHEDULED)

  // Backup
  backupProviderId      String?               @db.ObjectId
  backupProviderName    String?

  // Contact override (if different from profile)
  contactPhone          String?
  contactEmail          String?
  notes                 String?

  // Holiday/special info
  isHoliday             Boolean               @default(false)
  holidayName           String?

  // Acknowledgment
  acknowledgedAt        DateTime?

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  createdBy             String                @db.ObjectId

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  swapRequests          OnCallSwapRequest[]   @relation("OriginalOnCall")
  swapsReceived         OnCallSwapRequest[]   @relation("SwapTarget")

  @@index([clinicId])
  @@index([providerId])
  @@index([startDate, endDate])
  @@index([status])
  @@map("on_call_schedules")
}

enum OnCallType {
  PRIMARY
  BACKUP
  HOLIDAY
  SPECIAL
}

enum OnCallStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  SWAPPED
  CANCELLED
}

/// OnCallSwapRequest - Shift swap requests between providers
model OnCallSwapRequest {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // Original assignment
  originalOnCallId      String                @db.ObjectId
  requestingProviderId  String                @db.ObjectId

  // Swap target
  targetOnCallId        String?               @db.ObjectId
  targetProviderId      String                @db.ObjectId

  // Request details
  reason                String
  status                SwapRequestStatus     @default(PENDING)

  // Approval
  approvedAt            DateTime?
  approvedBy            String?               @db.ObjectId
  declinedAt            DateTime?
  declinedBy            String?               @db.ObjectId
  declineReason         String?

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  originalOnCall        OnCallSchedule        @relation("OriginalOnCall", fields: [originalOnCallId], references: [id])
  targetOnCall          OnCallSchedule?       @relation("SwapTarget", fields: [targetOnCallId], references: [id])

  @@index([clinicId])
  @@index([originalOnCallId])
  @@index([status])
  @@map("on_call_swap_requests")
}

enum SwapRequestStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}

/// ReminderTemplate - Clinic-specific reminder message templates
model ReminderTemplate {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // Template info
  name                  String
  channel               ReminderChannel
  type                  ReminderType

  // Content
  subject               String?               // For email
  body                  String                // Template with variables like {patient_name}

  // Options
  includeCalendarLink   Boolean               @default(false)
  includeDirections     Boolean               @default(false)
  includeConfirmLink    Boolean               @default(false)
  includeCancelLink     Boolean               @default(false)

  // Status
  isActive              Boolean               @default(true)
  isDefault             Boolean               @default(false)

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  createdBy             String?               @db.ObjectId

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  sequenceSteps         ReminderSequenceStep[]

  @@index([clinicId])
  @@index([channel])
  @@index([type])
  @@map("reminder_templates")
}

enum ReminderChannel {
  SMS
  EMAIL
  VOICE
  PUSH
}

enum ReminderType {
  STANDARD            // Regular reminder
  CONFIRMATION        // Requesting confirmation
  FINAL               // Last reminder before appointment
  PRE_VISIT           // Prep instructions
  FIRST_VISIT         // Special for first-time patients
  FOLLOW_UP           // Post-appointment follow-up
}

/// ReminderSequence - Multi-step reminder workflows
model ReminderSequence {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // Sequence info
  name                  String
  description           String?
  appointmentTypeId     String?               @db.ObjectId // Specific type or null for all
  isDefault             Boolean               @default(false)
  isActive              Boolean               @default(true)

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  createdBy             String?               @db.ObjectId

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  steps                 ReminderSequenceStep[]

  @@index([clinicId])
  @@index([appointmentTypeId])
  @@map("reminder_sequences")
}

/// ReminderSequenceStep - Individual step in a reminder sequence
model ReminderSequenceStep {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  sequenceId            String                @db.ObjectId

  // Step order
  stepOrder             Int                   // 1, 2, 3...

  // Timing
  offsetDays            Int                   // Days before appointment (negative = after)
  offsetHours           Int                   @default(0) // Additional hours
  sendTime              String?               // Preferred time "09:00" (uses patient timezone)

  // Content
  channel               ReminderChannel
  reminderType          ReminderType
  templateId            String?               @db.ObjectId

  // Behavior
  skipIfConfirmed       Boolean               @default(true)
  skipIfCancelled       Boolean               @default(true)
  skipIfPreviousFailed  Boolean               @default(false)

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  sequence              ReminderSequence      @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  template              ReminderTemplate?     @relation(fields: [templateId], references: [id])

  @@index([sequenceId])
  @@map("reminder_sequence_steps")
}

/// AppointmentReminder - Individual reminder records
model AppointmentReminder {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId
  appointmentId         String                @db.ObjectId
  patientId             String                @db.ObjectId

  // Reminder details
  channel               ReminderChannel
  reminderType          ReminderType
  sequenceStepId        String?               @db.ObjectId
  templateId            String?               @db.ObjectId

  // Scheduling
  scheduledFor          DateTime
  sentAt                DateTime?

  // Status
  status                ReminderStatus        @default(SCHEDULED)
  failureReason         String?
  retryCount            Int                   @default(0)

  // Delivery tracking
  deliveredAt           DateTime?
  deliveryReceipt       String?               // External delivery ID

  // Response tracking (for confirmations)
  responseType          ConfirmationResponse?
  respondedAt           DateTime?
  responseRaw           String?               // Raw response text

  // Content sent
  contentSent           String?               // Actual message sent

  // External IDs
  externalMessageId     String?               // Twilio/SendGrid ID

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  appointment           Appointment           @relation(fields: [appointmentId], references: [id])
  patient               Patient               @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([appointmentId])
  @@index([patientId])
  @@index([scheduledFor])
  @@index([status])
  @@map("appointment_reminders")
}

enum ReminderStatus {
  SCHEDULED
  SENDING
  SENT
  DELIVERED
  FAILED
  CANCELLED
  SKIPPED
}

enum ConfirmationResponse {
  CONFIRMED
  DECLINED
  RESCHEDULE_REQUESTED
  NO_RESPONSE
}

/// AfterHoursMessage - After-hours contact tracking
model AfterHoursMessage {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // Caller info
  callerName            String
  callerPhone           String
  callerEmail           String?
  patientId             String?               @db.ObjectId // If identified

  // Message details
  messageType           AfterHoursMessageType
  urgency               AfterHoursUrgency     @default(ROUTINE)
  message               String
  routing               AfterHoursRouting     @default(VOICEMAIL)

  // Status
  status                AfterHoursStatus      @default(PENDING)
  acknowledgedAt        DateTime?
  acknowledgedBy        String?               @db.ObjectId

  // Resolution
  resolvedAt            DateTime?
  resolvedBy            String?               @db.ObjectId
  resolutionNotes       String?

  // Callback tracking
  callbackScheduledFor  DateTime?
  callbackCompletedAt   DateTime?
  callbackNotes         String?

  // Links
  emergencyAppointmentId String?              @db.ObjectId
  appointmentId         String?               @db.ObjectId

  // On-call handling
  onCallProviderId      String?               @db.ObjectId
  onCallNotifiedAt      DateTime?

  // Timestamps
  receivedAt            DateTime              @default(now())
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  patient               Patient?              @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([urgency])
  @@index([receivedAt])
  @@map("after_hours_messages")
}

enum AfterHoursMessageType {
  EMERGENCY
  APPOINTMENT_REQUEST
  GENERAL_QUESTION
  BILLING_QUESTION
  PRESCRIPTION_REQUEST
  OTHER
}

enum AfterHoursUrgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum AfterHoursRouting {
  VOICEMAIL
  ON_CALL_PROVIDER
  ANSWERING_SERVICE
  AUTO_RESPONSE
  EMERGENCY_LINE
}

enum AfterHoursStatus {
  PENDING
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  CALLBACK_SCHEDULED
  NO_ACTION_NEEDED
}

/// AfterHoursSettings - Clinic after-hours configuration
model AfterHoursSettings {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @unique @db.ObjectId

  // Business hours
  weekdayOpen           String                @default("08:00")
  weekdayClose          String                @default("17:00")
  saturdayOpen          String?               // null = closed
  saturdayClose         String?
  sundayOpen            String?
  sundayClose           String?

  // Phone routing
  afterHoursPhone       String?
  answeringServicePhone String?
  emergencyLinePhone    String?

  // Auto-response templates
  smsAutoReply          String?
  emailAutoReply        String?
  voicemailGreeting     String?

  // Emergency keywords for auto-triage
  emergencyKeywords     String[]              // ["pain", "bleeding", "swelling", "broken"]

  // Thresholds
  urgentResponseMinutes Int                   @default(30)
  routineResponseHours  Int                   @default(24)

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  updatedBy             String?               @db.ObjectId

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])

  @@map("after_hours_settings")
}

/// EmergencyProtocol - Standardized procedures for emergencies
model EmergencyProtocol {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // Protocol details
  emergencyType         EmergencyType
  name                  String
  description           String?

  // Severity defaults
  typicalSeverity       EmergencySeverity     @default(MEDIUM)
  maxWaitDays           Int                   @default(2) // Max days before must be seen

  // Triage questions
  triageQuestions       Json?                 // Array of { question, options: [{ text, severity }] }

  // Instructions
  selfCareInstructions  String?               // Patient can do at home
  whenToCall            String?               // When patient should call
  whenToSeekER          String?               // When to go to ER

  // Media
  imageUrl              String?
  videoUrl              String?

  // Versioning
  version               Int                   @default(1)
  isActive              Boolean               @default(true)

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  updatedBy             String?               @db.ObjectId

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, emergencyType])
  @@index([clinicId])
  @@index([emergencyType])
  @@map("emergency_protocols")
}

/// EmergencyFAQ - Patient-facing emergency FAQ
model EmergencyFAQ {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId

  // FAQ content
  question              String
  answer                String
  category              FAQCategory           @default(GENERAL)
  emergencyType         EmergencyType?        // Related emergency type if applicable

  // Display
  displayOrder          Int                   @default(0)
  isPublished           Boolean               @default(true)

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  createdBy             String?               @db.ObjectId

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([category])
  @@map("emergency_faqs")
}

enum FAQCategory {
  PREVENTION
  SELF_CARE
  WHEN_TO_CALL
  GENERAL
}

// =============================================================================
// ADVANCED SCHEDULING - Provider schedules, templates, recurring appointments
// =============================================================================

/// ProviderSchedule - Default working hours for a provider on a specific day
model ProviderSchedule {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String              @db.ObjectId
  providerId       String              @db.ObjectId

  // Day of week (0=Sunday, 1=Monday, etc.)
  dayOfWeek        Int                 // 0-6

  // Working hours
  startTime        String              // "08:00" format
  endTime          String              // "17:00" format
  isWorkingDay     Boolean             @default(true)

  // Breaks during the day (stored as JSON array)
  breaks           Json?               // Array of { startTime, endTime, label }

  // Effective date range (for historical tracking / future changes)
  effectiveFrom    DateTime?
  effectiveTo      DateTime?

  // Lunch settings
  lunchStartTime   String?             // "12:00"
  lunchEndTime     String?             // "13:00"
  autoBlockLunch   Boolean             @default(true)

  // Timestamps
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  createdBy        String?             @db.ObjectId
  updatedBy        String?             @db.ObjectId

  // Relations
  clinic           Clinic              @relation(fields: [clinicId], references: [id])
  provider         StaffProfile        @relation("ProviderSchedules", fields: [providerId], references: [id])

  @@unique([clinicId, providerId, dayOfWeek, effectiveFrom])
  @@index([clinicId])
  @@index([providerId])
  @@index([dayOfWeek])
  @@map("provider_schedules")
}

/// ScheduleBlock - Blocked time on provider's calendar (vacation, meeting, etc.)
model ScheduleBlock {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String              @db.ObjectId
  providerId       String              @db.ObjectId

  // Block details
  title            String
  blockType        ScheduleBlockType
  reason           String?

  // Time range
  startDateTime    DateTime
  endDateTime      DateTime
  allDay           Boolean             @default(false)

  // Recurrence (for recurring blocks like weekly meetings)
  isRecurring      Boolean             @default(false)
  recurrenceRule   String?             // RRULE format

  // Status
  status           ScheduleBlockStatus @default(ACTIVE)

  // Approval (for time off requests)
  requiresApproval Boolean             @default(false)
  approvedBy       String?             @db.ObjectId
  approvedAt       DateTime?

  // Notifications
  notifyPatients   Boolean             @default(false)  // Auto-notify affected patients
  notificationSent Boolean             @default(false)

  // Timestamps
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  createdBy        String?             @db.ObjectId

  // Relations
  clinic           Clinic              @relation(fields: [clinicId], references: [id])
  provider         StaffProfile        @relation("ScheduleBlocks", fields: [providerId], references: [id])

  @@index([clinicId])
  @@index([providerId])
  @@index([startDateTime])
  @@index([status])
  @@map("schedule_blocks")
}

enum ScheduleBlockType {
  VACATION          // Time off / vacation
  SICK_LEAVE        // Sick leave
  PERSONAL          // Personal time
  MEETING           // Staff meeting
  TRAINING          // Training session
  CONFERENCE        // External conference
  ADMIN_TIME        // Administrative work
  LUNCH             // Lunch break
  BREAK             // Short break
  HOLIDAY           // Clinic holiday
  MAINTENANCE       // Equipment/room maintenance
  OTHER             // Other reason
}

enum ScheduleBlockStatus {
  ACTIVE            // Block is active
  PENDING_APPROVAL  // Awaiting approval
  APPROVED          // Approved but not yet active
  REJECTED          // Request rejected
  CANCELLED         // Block cancelled
}

/// BookingTemplate - Reusable booking slot templates for the calendar
model BookingTemplate {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String              @db.ObjectId

  // Template info
  name             String
  description      String?
  templateType     BookingTemplateType @default(DAY)

  // Settings
  isActive         Boolean             @default(true)
  isDefault        Boolean             @default(false)

  // For provider-specific templates
  providerId       String?             @db.ObjectId

  // Template slots (stored as JSON)
  slots            Json                // Array of BookingTemplateSlot

  // Color coding
  color            String?             // Hex color for calendar display

  // Versioning
  version          Int                 @default(1)

  // Timestamps
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  createdBy        String?             @db.ObjectId
  updatedBy        String?             @db.ObjectId

  // Relations
  clinic           Clinic              @relation(fields: [clinicId], references: [id])
  provider         StaffProfile?       @relation("BookingTemplates", fields: [providerId], references: [id])
  applications     TemplateApplication[]

  @@index([clinicId])
  @@index([templateType])
  @@index([isActive])
  @@map("booking_templates")
}

enum BookingTemplateType {
  DAY               // Single day template
  WEEK              // Full week template
  HALF_DAY_AM       // Morning only
  HALF_DAY_PM       // Afternoon only
}

/// TemplateApplication - Record of when a template was applied to the calendar
model TemplateApplication {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String              @db.ObjectId
  templateId       String              @db.ObjectId
  providerId       String?             @db.ObjectId  // Optional - null for clinic-wide applications

  // Application details
  appliedDate      DateTime            @db.Date  // The date template was applied to
  dateRangeStart   DateTime?           @db.Date  // For bulk applications
  dateRangeEnd     DateTime?           @db.Date

  // Settings
  overrideExisting Boolean             @default(false)

  // Stats
  slotsCreated     Int                 @default(0)
  slotsSkipped     Int                 @default(0)

  // Timestamps
  appliedAt        DateTime            @default(now())
  appliedBy        String              @db.ObjectId

  // Relations
  clinic           Clinic              @relation(fields: [clinicId], references: [id])
  template         BookingTemplate     @relation(fields: [templateId], references: [id])
  provider         StaffProfile?       @relation("TemplateApplications", fields: [providerId], references: [id])

  @@index([clinicId])
  @@index([templateId])
  @@index([providerId])
  @@index([appliedDate])
  @@map("template_applications")
}

/// RecurringAppointment - Recurring appointment series definition
model RecurringAppointment {
  id                   String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId             String              @db.ObjectId
  patientId            String              @db.ObjectId

  // Series details
  name                 String?             // Optional series name
  appointmentTypeId    String              @db.ObjectId
  providerId           String              @db.ObjectId
  chairId              String?             @db.ObjectId
  duration             Int                 // Duration in minutes

  // Preferred time
  preferredTime        String              // "09:00" format
  preferredDayOfWeek   Int?                // 0-6 for weekly recurrence

  // Recurrence pattern
  pattern              RecurrencePattern
  interval             Int                 @default(1)  // Every X weeks/months
  daysOfWeek           Int[]               // For weekly: which days [1, 3, 5] = Mon, Wed, Fri
  dayOfMonth           Int?                // For monthly: day of month
  weekOfMonth          Int?                // For monthly: which week (1-4, -1 for last)

  // Series bounds
  startDate            DateTime            @db.Date
  endDate              DateTime?           @db.Date
  maxOccurrences       Int?

  // Status tracking
  status               RecurringStatus     @default(ACTIVE)
  occurrencesCreated   Int                 @default(0)
  lastGeneratedDate    DateTime?           @db.Date

  // Notes
  notes                String?

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  createdBy            String              @db.ObjectId
  cancelledAt          DateTime?
  cancelledBy          String?             @db.ObjectId

  // Relations
  clinic               Clinic              @relation(fields: [clinicId], references: [id])
  patient              Patient             @relation(fields: [patientId], references: [id])
  appointmentType      AppointmentType     @relation(fields: [appointmentTypeId], references: [id])
  provider             StaffProfile        @relation("RecurringAppointments", fields: [providerId], references: [id])
  occurrences          RecurringOccurrence[]

  @@index([clinicId])
  @@index([patientId])
  @@index([providerId])
  @@index([status])
  @@map("recurring_appointments")
}

enum RecurrencePattern {
  DAILY             // Every day
  WEEKLY            // Every week
  BIWEEKLY          // Every 2 weeks
  MONTHLY           // Every month
  CUSTOM            // Custom interval
}

enum RecurringStatus {
  ACTIVE            // Series is active
  PAUSED            // Temporarily paused
  COMPLETED         // All occurrences generated
  CANCELLED         // Series cancelled
}

/// RecurringOccurrence - Links a recurring series to generated appointments
model RecurringOccurrence {
  id                   String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId             String              @db.ObjectId
  recurringId          String              @db.ObjectId
  appointmentId        String?             @db.ObjectId  // null if not yet created

  // Occurrence details
  occurrenceNumber     Int                 // 1st, 2nd, 3rd, etc.
  scheduledDate        DateTime            @db.Date
  scheduledTime        String              // "09:00"

  // Status
  status               OccurrenceStatus    @default(PENDING)
  skippedReason        String?

  // Modification tracking
  isModified           Boolean             @default(false)
  modifiedAt           DateTime?
  modifiedBy           String?             @db.ObjectId

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Relations
  clinic               Clinic              @relation(fields: [clinicId], references: [id])
  recurring            RecurringAppointment @relation(fields: [recurringId], references: [id], onDelete: Cascade)

  @@unique([recurringId, occurrenceNumber])
  @@index([clinicId])
  @@index([recurringId])
  @@index([appointmentId])
  @@index([scheduledDate])
  @@map("recurring_occurrences")
}

enum OccurrenceStatus {
  PENDING           // Not yet created as appointment
  SCHEDULED         // Appointment created
  MODIFIED          // This occurrence was modified
  SKIPPED           // Skipped (holiday, conflict)
  CANCELLED         // Individual occurrence cancelled
}

/// OpeningNotification - Notification sent for cancelled appointment opening
model OpeningNotification {
  id                   String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId             String              @db.ObjectId

  // Opening details (from cancellation)
  cancellationId       String              @db.ObjectId
  openingDateTime      DateTime            // When the opening is
  duration             Int                 // Duration in minutes
  appointmentTypeId    String              @db.ObjectId
  providerId           String              @db.ObjectId

  // Waitlist targeting
  waitlistEntryId      String              @db.ObjectId  // Who was notified
  patientId            String              @db.ObjectId

  // Notification
  channel              ReminderChannel     // SMS, EMAIL
  sentAt               DateTime?
  deliveredAt          DateTime?
  messageContent       String?

  // Response
  status               OpeningNotificationStatus @default(PENDING)
  respondedAt          DateTime?
  response             OpeningResponse?
  holdExpiresAt        DateTime?           // Hold expiration if accepted

  // Result
  bookedAppointmentId  String?             @db.ObjectId  // If booked

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Relations
  clinic               Clinic              @relation(fields: [clinicId], references: [id])
  waitlistEntry        WaitlistEntry       @relation(fields: [waitlistEntryId], references: [id])
  patient              Patient             @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([cancellationId])
  @@index([waitlistEntryId])
  @@index([status])
  @@map("opening_notifications")
}

enum OpeningNotificationStatus {
  PENDING             // Not yet sent
  SENT                // Sent, awaiting response
  DELIVERED           // Confirmed delivered
  ACCEPTED            // Patient accepted
  DECLINED            // Patient declined
  EXPIRED             // No response in time
  BOOKED              // Successfully booked
  FAILED              // Failed to send
}

enum OpeningResponse {
  YES                 // Patient wants the slot
  NO                  // Patient declined
  MAYBE               // Interested but not committed
}

/// ReEngagementCampaign - Campaign to re-engage inactive patients
model ReEngagementCampaign {
  id                   String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId             String              @db.ObjectId

  // Campaign info
  name                 String
  description          String?
  status               CampaignStatus      @default(DRAFT)

  // Target criteria
  inactiveDays         Int                 // Days since last appointment
  appointmentTypeIds   String[]            @db.ObjectId  // Empty = any type
  excludePatientIds    String[]            @db.ObjectId  // Exclusion list

  // Outreach settings
  channels             ReminderChannel[]   // SMS, EMAIL
  messages             Json                // Array of CampaignMessage

  // Schedule
  scheduledStartDate   DateTime?
  scheduledEndDate     DateTime?
  sendTime             String?             // "09:00" - preferred send time

  // Limits
  maxPatientsPerDay    Int?
  maxTotalPatients     Int?

  // Stats
  patientsTargeted     Int                 @default(0)
  messagesSent         Int                 @default(0)
  messagesDelivered    Int                 @default(0)
  responses            Int                 @default(0)
  appointmentsBooked   Int                 @default(0)

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  createdBy            String              @db.ObjectId
  launchedAt           DateTime?
  completedAt          DateTime?

  // Relations
  clinic               Clinic              @relation(fields: [clinicId], references: [id])
  patients             CampaignPatient[]

  @@index([clinicId])
  @@index([status])
  @@map("re_engagement_campaigns")
}

enum CampaignStatus {
  DRAFT               // Being created
  SCHEDULED           // Ready to run
  ACTIVE              // Currently running
  PAUSED              // Temporarily paused
  COMPLETED           // Finished
  CANCELLED           // Cancelled
}

/// CampaignPatient - Patient included in a re-engagement campaign
model CampaignPatient {
  id                   String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId             String              @db.ObjectId
  campaignId           String              @db.ObjectId
  patientId            String              @db.ObjectId

  // Patient status in campaign
  status               CampaignPatientStatus @default(PENDING)
  daysSinceLastVisit   Int

  // Outreach tracking
  messagesSent         Int                 @default(0)
  lastMessageAt        DateTime?
  lastChannel          ReminderChannel?

  // Response
  respondedAt          DateTime?
  response             CampaignPatientResponse?
  appointmentBooked    Boolean             @default(false)
  bookedAppointmentId  String?             @db.ObjectId

  // Timestamps
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Relations
  clinic               Clinic              @relation(fields: [clinicId], references: [id])
  campaign             ReEngagementCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  patient              Patient             @relation(fields: [patientId], references: [id])

  @@unique([campaignId, patientId])
  @@index([clinicId])
  @@index([campaignId])
  @@index([patientId])
  @@index([status])
  @@map("campaign_patients")
}

enum CampaignPatientStatus {
  PENDING             // Not yet contacted
  CONTACTED           // Message(s) sent
  RESPONDED           // Patient responded
  BOOKED              // Appointment booked
  OPTED_OUT           // Patient opted out
  FAILED              // Failed to reach
  EXCLUDED            // Manually excluded
}

enum CampaignPatientResponse {
  INTERESTED          // Wants to book
  NOT_INTERESTED      // Not interested now
  UNSUBSCRIBE         // Opt out of future campaigns
  NO_RESPONSE         // No response received
}

// -----------------------------------------------------------------------------
// Automated Campaigns - General purpose campaign workflow system
// -----------------------------------------------------------------------------

/// CampaignType - Types of automated campaigns
enum CampaignType {
  MARKETING           // Promotional campaigns
  REMINDER            // Appointment reminders
  FOLLOW_UP           // Post-visit follow-ups
  SURVEY              // Feedback collection
  REACTIVATION        // Re-engagement
  WELCOME             // New patient onboarding
  EDUCATION           // Treatment education
}

/// TriggerType - How campaigns are triggered
enum TriggerType {
  EVENT               // Triggered by system events
  SCHEDULED           // One-time scheduled send
  RECURRING           // Repeating schedule
}

/// StepType - Types of workflow steps
enum StepType {
  SEND                // Send a message
  WAIT                // Wait for a duration
  CONDITION           // Check a condition
  BRANCH              // Branch based on criteria
}

/// SendStatus - Status of individual campaign sends
enum SendStatus {
  PENDING             // Waiting to be sent
  SENT                // Message sent
  DELIVERED           // Confirmed delivery
  OPENED              // Message opened (email)
  CLICKED             // Link clicked
  FAILED              // Delivery failed
  SKIPPED             // Skipped due to condition
  CANCELLED           // Cancelled before send
}

/// Campaign - Automated communication workflow
model Campaign {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String            @db.ObjectId

  // Campaign identification
  name            String
  description     String?
  type            CampaignType

  // Targeting - JSON with audience criteria
  audience        Json?             // { patientStatus: [], treatmentTypes: [], tags: [] }
  excludeCriteria Json?             // Exclusion rules

  // Trigger configuration
  triggerType     TriggerType
  triggerEvent    String?           // For EVENT type: "appointment.booked", "treatment.started", etc.
  triggerSchedule DateTime?         // For SCHEDULED type
  triggerRecurrence Json?           // For RECURRING: { frequency: "weekly", days: [1,3,5], time: "09:00" }

  // Status
  status          CampaignStatus    @default(DRAFT)

  // Stats (denormalized for performance)
  totalRecipients Int               @default(0)
  totalSent       Int               @default(0)
  totalDelivered  Int               @default(0)
  totalOpened     Int               @default(0)
  totalClicked    Int               @default(0)
  totalFailed     Int               @default(0)

  // Audit
  createdBy       String            @db.ObjectId
  activatedAt     DateTime?
  pausedAt        DateTime?
  completedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?

  // Relations
  clinic          Clinic            @relation(fields: [clinicId], references: [id])
  steps           CampaignStep[]
  sends           CampaignSend[]

  @@index([clinicId, status])
  @@index([clinicId, type])
  @@index([triggerEvent])
  @@map("campaigns")
}

/// CampaignStep - Individual step in a campaign workflow
model CampaignStep {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  campaignId      String            @db.ObjectId

  // Step order and identification
  stepOrder       Int
  name            String
  type            StepType

  // For SEND steps
  channel         MessageChannel?   // SMS, EMAIL, PUSH, IN_APP
  templateId      String?           @db.ObjectId

  // For WAIT steps
  waitDuration    Int?              // Duration in minutes
  waitUntil       String?           // Dynamic expression: "2 days before appointment"

  // For CONDITION steps - JSON condition object
  condition       Json?             // { field: "patient.hasEmail", operator: "eq", value: true }

  // For BRANCH steps - Array of branch paths
  branches        Json?             // [{ condition: {...}, nextStepId: "..." }]
  nextStepId      String?           @db.ObjectId // Default next step

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  campaign        Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  template        MessageTemplate?  @relation(fields: [templateId], references: [id])
  sends           CampaignSend[]

  @@index([campaignId, stepOrder])
  @@map("campaign_steps")
}

/// CampaignSend - Individual send to a patient within a campaign
model CampaignSend {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String            @db.ObjectId
  campaignId      String            @db.ObjectId
  stepId          String            @db.ObjectId
  patientId       String            @db.ObjectId

  // Status
  status          SendStatus        @default(PENDING)

  // Scheduling
  scheduledAt     DateTime
  sentAt          DateTime?
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  failedAt        DateTime?

  // Result tracking
  messageId       String?           @db.ObjectId  // Link to actual Message sent
  errorMessage    String?
  skipReason      String?

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  clinic          Clinic            @relation(fields: [clinicId], references: [id])
  campaign        Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  step            CampaignStep      @relation(fields: [stepId], references: [id], onDelete: Cascade)
  patient         Patient           @relation(fields: [patientId], references: [id])
  message         Message?          @relation(fields: [messageId], references: [id])

  @@index([clinicId])
  @@index([campaignId, status])
  @@index([patientId])
  @@index([scheduledAt, status])
  @@index([stepId])
  @@map("campaign_sends")
}

// =============================================================================
// PRACTICE ORCHESTRATION AREA - Operations dashboard, patient flow, resources
// =============================================================================

// -----------------------------------------------------------------------------
// Patient Flow - Real-time patient journey tracking through the clinic
// -----------------------------------------------------------------------------

/// FlowStage - Stages in the patient journey
enum FlowStage {
  SCHEDULED           // Appointment on calendar, patient not arrived
  CHECKED_IN          // Patient arrived and checked in
  WAITING             // In waiting room
  CALLED              // Called back to clinical area
  IN_CHAIR            // Seated in treatment chair
  COMPLETED           // Treatment finished
  CHECKED_OUT         // Checkout processed
  DEPARTED            // Left the office
  NO_SHOW             // Did not arrive (auto or manual)
  CANCELLED           // Appointment cancelled
}

/// FlowPriority - Priority levels for patient flow
enum FlowPriority {
  LOW                 // Routine, can wait
  NORMAL              // Standard priority
  HIGH                // Should be seen soon
  URGENT              // Needs immediate attention
}

/// PatientFlowState - Real-time tracking of patient journey through clinic
model PatientFlowState {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  appointmentId   String         @unique @db.ObjectId
  patientId       String         @db.ObjectId

  // Current state
  stage           FlowStage      @default(SCHEDULED)
  chairId         String?        @db.ObjectId
  providerId      String?        @db.ObjectId

  // Timestamps for each stage
  scheduledAt     DateTime       // When appointment was scheduled for
  checkedInAt     DateTime?      // When patient checked in
  calledAt        DateTime?      // When patient was called
  seatedAt        DateTime?      // When patient was seated
  completedAt     DateTime?      // When treatment completed
  checkedOutAt    DateTime?      // When checkout completed
  departedAt      DateTime?      // When patient left

  // Current wait time tracking
  currentWaitStartedAt DateTime? // When current wait started

  // Notes and priority
  notes           String?
  priority        FlowPriority   @default(NORMAL)

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  appointment     Appointment    @relation(fields: [appointmentId], references: [id])
  patient         Patient        @relation(fields: [patientId], references: [id])
  chair           TreatmentChair? @relation(fields: [chairId], references: [id])
  provider        StaffProfile?  @relation("FlowProvider", fields: [providerId], references: [id])
  stageHistory    FlowStageHistory[]

  @@index([clinicId, stage])
  @@index([clinicId, scheduledAt])
  @@index([patientId])
  @@map("patient_flow_states")
}

/// FlowStageHistory - Historical record of stage transitions
model FlowStageHistory {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  flowStateId     String         @db.ObjectId

  // Stage info
  stage           FlowStage
  enteredAt       DateTime       @default(now())
  exitedAt        DateTime?
  duration        Int?           // Duration in minutes

  // Who triggered the transition
  triggeredBy     String?        @db.ObjectId
  notes           String?

  // Relations
  flowState       PatientFlowState @relation(fields: [flowStateId], references: [id], onDelete: Cascade)

  @@index([flowStateId, stage])
  @@map("flow_stage_history")
}

// -----------------------------------------------------------------------------
// Resource Occupancy - Real-time status of chairs and rooms
// -----------------------------------------------------------------------------

/// OccupancyStatus - Status of a resource (chair/room)
enum OccupancyStatus {
  AVAILABLE           // Ready for use
  OCCUPIED            // Currently in use
  BLOCKED             // Blocked (e.g., lunch, meeting)
  MAINTENANCE         // Under maintenance
  CLEANING            // Being cleaned/sterilized
}

/// ChairActivitySubStage - Detailed sub-stages within IN_CHAIR flow stage
/// Used to track what's happening at each chair in real-time
enum ChairActivitySubStage {
  SETUP              // Patient being seated, bib on, chart review
  ASSISTANT_WORKING  // Assistant performing procedures (wire changes, etc.)
  READY_FOR_DOCTOR   //  Waiting for doctor - PROMINENT indicator
  DOCTOR_CHECKING    // Doctor actively checking patient
  FINISHING          // Final steps before completion
  CLEANING           // Post-treatment cleanup (chair turnover)
}

/// ResourceOccupancy - Real-time occupancy tracking for chairs/rooms
model ResourceOccupancy {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Resource reference (either chairId or roomId)
  chairId         String?        @db.ObjectId
  roomId          String?        @db.ObjectId

  // Current state
  status          OccupancyStatus @default(AVAILABLE)

  // If occupied, which appointment/patient
  appointmentId   String?        @unique @db.ObjectId
  patientId       String?        @db.ObjectId

  // Timing
  occupiedAt      DateTime?
  expectedFreeAt  DateTime?

  // Block info (if status = BLOCKED or MAINTENANCE)
  blockReason     String?
  blockedBy       String?        @db.ObjectId
  blockedUntil    DateTime?

  // Chair activity sub-stage tracking (when status = OCCUPIED)
  // Tracks detailed workflow: Setup  Assistant  Ready for Doctor  Doctor Checking  Finishing
  activitySubStage    ChairActivitySubStage?  // Current sub-stage within the appointment
  subStageStartedAt   DateTime?               // When current sub-stage began
  assignedStaffId     String?        @db.ObjectId  // Staff currently working at this chair
  procedureNotes      String?                 // Quick procedure notes for the session

  // Timestamps
  updatedAt       DateTime       @updatedAt

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  chair           TreatmentChair? @relation(fields: [chairId], references: [id])
  room            Room?          @relation(fields: [roomId], references: [id])
  appointment     Appointment?   @relation(fields: [appointmentId], references: [id])
  patient         Patient?       @relation(fields: [patientId], references: [id])
  assignedStaff   StaffProfile?  @relation("ChairAssignedStaff", fields: [assignedStaffId], references: [id])

  @@unique([clinicId, chairId])
  @@index([clinicId, status])
  @@index([clinicId, activitySubStage])
  @@map("resource_occupancy")
}

// -----------------------------------------------------------------------------
// Staff Assignments - Staff assigned to appointments
// -----------------------------------------------------------------------------

/// StaffAssignment - Staff member assigned to an appointment
model StaffAssignment {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  staffId         String         @db.ObjectId
  appointmentId   String         @db.ObjectId

  // Role in this appointment
  role            String         // provider, assistant, hygienist
  notes           String?        // Assignment notes

  // Assignment info
  assignedAt      DateTime       @default(now())
  assignedBy      String?        @db.ObjectId
  unassignedAt    DateTime?

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  staff           StaffProfile   @relation(fields: [staffId], references: [id])
  appointment     Appointment    @relation(fields: [appointmentId], references: [id])

  @@unique([appointmentId, staffId])
  @@index([clinicId, staffId])
  @@index([appointmentId])
  @@map("staff_assignments")
}

// -----------------------------------------------------------------------------
// Operations Tasks - Daily tasks for staff
// -----------------------------------------------------------------------------

/// TaskType - Type of operations task
enum OpsTaskType {
  MANUAL              // Manually created by staff
  AI_GENERATED        // Generated by AI Manager
  SYSTEM              // System-generated (e.g., maintenance reminders)
}

/// TaskStatus - Status of an operations task
enum OpsTaskStatus {
  PENDING             // Not started
  IN_PROGRESS         // Being worked on
  COMPLETED           // Done
  CANCELLED           // Cancelled
}

/// TaskPriority - Priority of an operations task
enum OpsTaskPriority {
  LOW                 // Can wait
  NORMAL              // Standard
  HIGH                // Should be done soon
  URGENT              // Needs immediate attention
}

/// OperationsTask - Daily operational tasks for staff
model OperationsTask {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Task details
  title           String
  description     String?
  type            OpsTaskType    @default(MANUAL)

  // Assignment
  assigneeId      String?        @db.ObjectId
  ownerId         String?        @db.ObjectId

  // Timing
  dueAt           DateTime?
  completedAt     DateTime?

  // Status
  status          OpsTaskStatus  @default(PENDING)
  priority        OpsTaskPriority @default(NORMAL)

  // Related entity (optional link to appointment, patient, etc.)
  relatedType     String?        // appointment, patient, resource
  relatedId       String?        @db.ObjectId

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  assignee        StaffProfile?  @relation("TaskAssignee", fields: [assigneeId], references: [id])
  owner           StaffProfile?  @relation("TaskOwner", fields: [ownerId], references: [id])

  @@index([clinicId, status])
  @@index([clinicId, assigneeId])
  @@index([clinicId, dueAt])
  @@map("operations_tasks")
}

// -----------------------------------------------------------------------------
// Daily Metrics - Aggregated daily statistics
// -----------------------------------------------------------------------------

/// DailyMetrics - Aggregated metrics for a day
model DailyMetrics {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String        @db.ObjectId
  date             DateTime      @db.Date

  // Patient counts
  scheduledCount   Int           @default(0)
  checkedInCount   Int           @default(0)
  completedCount   Int           @default(0)
  noShowCount      Int           @default(0)
  cancelledCount   Int           @default(0)
  walkInCount      Int           @default(0)

  // Time metrics (in minutes)
  avgWaitMinutes   Float?        // Average wait time (check-in to chair)
  avgChairMinutes  Float?        // Average chair time
  totalWaitMinutes Int?          // Total wait time
  totalChairMinutes Int?         // Total chair time

  // Performance metrics
  onTimePercentage Float?        // % of appointments started on time
  chairUtilization Float?        // % chair utilization

  // Provider-specific (JSON for flexibility)
  providerMetrics  Json?         // { providerId: { patients, avgTime, onTime } }

  // Timestamps
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  clinic           Clinic        @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, date])
  @@index([clinicId])
  @@map("daily_metrics")
}

// -----------------------------------------------------------------------------
// Floor Plan Configuration - Layout for floor plan view
// -----------------------------------------------------------------------------

/// FloorPlanConfig - Floor plan layout configuration for a clinic
model FloorPlanConfig {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @unique @db.ObjectId

  // Identification
  name            String         @default("Main Floor")
  isDefault       Boolean        @default(true)

  // Layout settings
  gridColumns     Int            @default(20)  // Number of columns
  gridRows        Int            @default(12)  // Number of rows
  cellSize        Int            @default(40)  // Pixels per grid cell

  // Background image (optional)
  backgroundImage String?

  // Item positions (JSON array of positioned room items)
  // [{ roomId, name, x, y, width, height, rotation, chairs: [{ chairId, name, x, y, rotation }] }]
  layout          Json           @default("[]")

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  updatedBy       String?        @db.ObjectId

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])

  @@map("floor_plan_configs")
}

// =============================================================================
// PATIENT COMMUNICATIONS AREA - Messaging, templates, notifications
// =============================================================================

// -----------------------------------------------------------------------------
// Enums for Patient Communications
// -----------------------------------------------------------------------------

/// MessageChannel - Communication channel type
enum MessageChannel {
  SMS
  EMAIL
  PUSH
  IN_APP
}

/// MessageDirection - Direction of message
enum MessageDirection {
  OUTBOUND     // Sent to patient
  INBOUND      // Received from patient
}

/// MessageStatus - Status of message
enum MessageStatus {
  DRAFT        // Not yet sent
  PENDING      // Queued for sending
  SCHEDULED    // Scheduled for future
  SENT         // Sent to provider
  DELIVERED    // Confirmed delivered
  FAILED       // Failed to send
  BOUNCED      // Bounced back
  CANCELLED    // Cancelled before sending
}

/// DeliveryStatus - Detailed delivery status
enum DeliveryStatus {
  PENDING      // Waiting to be sent
  SENT         // Sent to provider
  DELIVERED    // Confirmed delivered
  FAILED       // Delivery failed
  BOUNCED      // Message bounced
  OPENED       // Email/notification opened
  CLICKED      // Link clicked
  UNSUBSCRIBED // User unsubscribed
  COMPLAINED   // Marked as spam
}

// -----------------------------------------------------------------------------
// Educational Content Library - Patient education materials
// -----------------------------------------------------------------------------

/// ContentStatus - Status of educational content
enum ContentStatus {
  DRAFT         // Being created/edited
  PUBLISHED     // Live and accessible
  ARCHIVED      // No longer active
}

/// DeliveryMethod - How content is delivered to patients
enum DeliveryMethod {
  EMAIL         // Sent via email
  PORTAL        // Available in patient portal
  SMS_LINK      // SMS with link
  IN_APP        // In-app notification
}

/// ContentArticle - Educational content article
model ContentArticle {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String?           @db.ObjectId  // Null for global content

  // Content
  title           String
  slug            String
  summary         String?
  body            String            // Rich text/markdown content

  // Media
  featuredImage   String?
  attachments     Json?             // Array of attachment URLs/metadata
  videoUrl        String?

  // Organization
  category        String
  tags            String[]          @default([])
  treatmentTypes  String[]          @default([])  // braces, aligners, etc.
  treatmentPhases String[]          @default([])  // pre-treatment, active, retention
  ageGroups       String[]          @default([])  // child, teen, adult
  languages       String[]          @default(["en"])

  // Status
  status          ContentStatus     @default(DRAFT)
  publishedAt     DateTime?
  expiresAt       DateTime?

  // Metrics
  viewCount       Int               @default(0)
  shareCount      Int               @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Audit
  createdBy       String            @db.ObjectId
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?

  // Relations
  clinic          Clinic?           @relation(fields: [clinicId], references: [id])
  deliveries      ContentDelivery[]

  @@unique([clinicId, slug])
  @@index([clinicId, category])
  @@index([clinicId, status])
  @@index([tags])
  @@map("content_articles")
}

/// ContentDelivery - Track content delivered to patients
model ContentDelivery {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String            @db.ObjectId
  articleId       String            @db.ObjectId
  patientId       String            @db.ObjectId

  // Delivery
  method          DeliveryMethod
  deliveredAt     DateTime          @default(now())
  viewedAt        DateTime?

  // Context
  triggeredBy     String?           // Event name or "manual"
  sentBy          String?           @db.ObjectId

  // Relations
  clinic          Clinic            @relation(fields: [clinicId], references: [id])
  article         ContentArticle    @relation(fields: [articleId], references: [id])
  patient         Patient           @relation(fields: [patientId], references: [id])

  @@index([clinicId, patientId])
  @@index([articleId])
  @@map("content_deliveries")
}

/// ContentCategory - Categories for organizing content
model ContentCategory {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String?           @db.ObjectId  // Null for global

  name            String
  slug            String
  description     String?
  parentId        String?           @db.ObjectId
  sortOrder       Int               @default(0)

  icon            String?
  color           String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  clinic          Clinic?           @relation(fields: [clinicId], references: [id])
  parent          ContentCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children        ContentCategory[] @relation("CategoryHierarchy")

  @@unique([clinicId, slug])
  @@index([clinicId])
  @@map("content_categories")
}

/// FAQItem - Frequently asked questions
model FAQItem {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String?           @db.ObjectId  // Null for global

  question        String
  answer          String
  category        String
  tags            String[]          @default([])

  // Display
  sortOrder       Int               @default(0)
  isFeatured      Boolean           @default(false)

  // Metrics
  viewCount       Int               @default(0)
  helpfulCount    Int               @default(0)
  notHelpfulCount Int               @default(0)

  // Status
  isActive        Boolean           @default(true)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  clinic          Clinic?           @relation(fields: [clinicId], references: [id])

  @@index([clinicId, category])
  @@index([clinicId, isActive])
  @@map("faq_items")
}

// -----------------------------------------------------------------------------
// Message Templates - Reusable message templates
// -----------------------------------------------------------------------------

/// MessageTemplate - Reusable message template with multi-channel support
model MessageTemplate {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Template identification
  name            String
  description     String?
  category        String         // appointment, billing, treatment, marketing, general

  // SMS content
  smsBody         String?

  // Email content
  emailSubject    String?
  emailBody       String?        // Plain text version
  emailHtmlBody   String?        // HTML version

  // Push notification content
  pushTitle       String?
  pushBody        String?

  // In-app notification content
  inAppTitle      String?
  inAppBody       String?

  // Available variables for substitution (e.g., ["patient.firstName", "appointment.date"])
  variables       String[]       @default([])

  // Status
  isActive        Boolean        @default(true)
  isSystem        Boolean        @default(false) // System templates cannot be deleted
  version         Int            @default(1)

  // Timestamps & Audit
  createdBy       String         @db.ObjectId
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  messages        Message[]
  campaignSteps   CampaignStep[]

  @@unique([clinicId, name])
  @@index([clinicId, category])
  @@index([clinicId, isActive])
  @@map("message_templates")
}

// -----------------------------------------------------------------------------
// Messages - Individual messages sent/received
// -----------------------------------------------------------------------------

/// Message - Individual message to/from a patient
model Message {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String           @db.ObjectId
  patientId       String           @db.ObjectId

  // Message content
  channel         MessageChannel
  subject         String?          // For email
  body            String           // Message body (rendered from template or custom)
  htmlBody        String?          // HTML body for email

  // Direction & routing
  direction       MessageDirection @default(OUTBOUND)
  templateId      String?          @db.ObjectId

  // Contact info used
  toAddress       String?          // Phone number, email, or device token
  fromAddress     String?          // Sender (clinic phone/email)

  // Status & scheduling
  status          MessageStatus    @default(PENDING)
  scheduledAt     DateTime?        // For scheduled messages
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?        // For in-app messages

  // Threading/conversation support
  conversationId  String?          @db.ObjectId  // Group related messages
  replyToId       String?          @db.ObjectId  // Reply to another message

  // Related entity (optional link to appointment, etc.)
  relatedType     String?          // appointment, invoice, treatment
  relatedId       String?          @db.ObjectId

  // Metadata for provider-specific data
  metadata        Json?
  tags            String[]         @default([])

  // Error handling
  errorMessage    String?
  retryCount      Int              @default(0)

  // Timestamps & Audit
  createdBy       String           @db.ObjectId
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  clinic          Clinic           @relation(fields: [clinicId], references: [id])
  patient         Patient          @relation(fields: [patientId], references: [id])
  template        MessageTemplate? @relation(fields: [templateId], references: [id])
  deliveries      MessageDelivery[]
  replyTo         Message?         @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies         Message[]        @relation("MessageReplies")
  campaignSends   CampaignSend[]

  @@index([clinicId, patientId])
  @@index([clinicId, status])
  @@index([clinicId, channel])
  @@index([clinicId, createdAt])
  @@index([conversationId])
  @@map("messages")
}

// -----------------------------------------------------------------------------
// Message Delivery - Tracks delivery attempts and status per provider
// -----------------------------------------------------------------------------

/// MessageDelivery - Delivery attempt for a message
model MessageDelivery {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  messageId         String         @db.ObjectId

  // Provider details
  provider          String         // twilio, sendgrid, firebase, internal
  providerMessageId String?        // External message ID from provider

  // Delivery status
  status            DeliveryStatus @default(PENDING)
  statusDetails     String?        // Detailed status message

  // Timestamps for tracking
  sentAt            DateTime?
  deliveredAt       DateTime?
  openedAt          DateTime?
  clickedAt         DateTime?
  bouncedAt         DateTime?
  failedAt          DateTime?

  // Webhook data from provider
  webhookData       Json?

  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  message           Message        @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([providerMessageId])
  @@index([status])
  @@map("message_deliveries")
}

// -----------------------------------------------------------------------------
// Notification Preferences - Patient communication preferences
// -----------------------------------------------------------------------------

/// NotificationPreference - Patient communication preferences
model NotificationPreference {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  patientId       String         @unique @db.ObjectId  // One preference per patient

  // Channel preferences
  smsEnabled      Boolean        @default(true)
  emailEnabled    Boolean        @default(true)
  pushEnabled     Boolean        @default(true)

  // Category preferences
  appointmentReminders   Boolean  @default(true)
  treatmentUpdates       Boolean  @default(true)
  billingNotifications   Boolean  @default(true)
  marketingMessages      Boolean  @default(false)  // Requires explicit opt-in

  // Preferred channel order (first = primary)
  channelPriority String[]       @default(["SMS", "EMAIL", "PUSH"])

  // Quiet hours (no messages during these times)
  quietHoursStart String?        // e.g., "21:00" (9 PM)
  quietHoursEnd   String?        // e.g., "08:00" (8 AM)
  timezone        String?        // Patient timezone

  // Opt-out tracking
  smsOptOutAt     DateTime?
  emailOptOutAt   DateTime?

  // Consent tracking
  marketingConsentAt DateTime?   // When marketing consent was given
  marketingConsentBy String?     // How consent was given (web, sms, verbal)

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  patient         Patient        @relation(fields: [patientId], references: [id])

  @@unique([clinicId, patientId])
  @@index([clinicId])
  @@map("notification_preferences")
}

// =============================================================================
// SURVEYS - Patient feedback and surveys
// =============================================================================

// -----------------------------------------------------------------------------
// Survey - Survey form definition
// -----------------------------------------------------------------------------

/// SurveyStatus - Status of a survey
enum SurveyStatus {
  DRAFT             // Being edited
  ACTIVE            // Accepting responses
  PAUSED            // Temporarily not accepting responses
  CLOSED            // Permanently closed
  ARCHIVED          // Archived
}

/// SurveyQuestionType - Types of survey questions
enum SurveyQuestionType {
  TEXT              // Free text answer
  TEXTAREA          // Multi-line text answer
  SINGLE_CHOICE     // Radio buttons - one answer
  MULTIPLE_CHOICE   // Checkboxes - multiple answers
  RATING            // Star/number rating
  NPS               // Net Promoter Score (0-10)
  YES_NO            // Boolean yes/no
  DATE              // Date picker
  EMAIL             // Email input
  PHONE             // Phone input
}

/// Survey - Survey form definition
model Survey {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Survey details
  title           String
  description     String?
  category        String         // satisfaction, nps, treatment, general, exit

  // Configuration
  isAnonymous     Boolean        @default(false)
  allowMultiple   Boolean        @default(false)  // Allow multiple responses per patient
  requiresAuth    Boolean        @default(false)  // Require portal login

  // Questions stored as JSON array for flexibility
  questions       Json           // Array of question objects

  // Branding
  logoUrl         String?
  primaryColor    String?
  thankYouMessage String?

  // Status & scheduling
  status          SurveyStatus   @default(DRAFT)
  startsAt        DateTime?
  endsAt          DateTime?

  // Metrics
  responseCount   Int            @default(0)
  completionRate  Float          @default(0)   // Percentage of completions vs starts

  // Timestamps & Audit
  createdBy       String         @db.ObjectId
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  responses       SurveyResponse[]

  @@index([clinicId, status])
  @@index([clinicId, category])
  @@map("surveys")
}

// -----------------------------------------------------------------------------
// Survey Response - Individual survey submission
// -----------------------------------------------------------------------------

/// SurveyResponseStatus - Status of a survey response
enum SurveyResponseStatus {
  STARTED           // Survey started but not completed
  COMPLETED         // Survey submitted
  ABANDONED         // Started but never completed
}

/// SurveyResponse - Individual patient response to a survey
model SurveyResponse {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId
  surveyId        String               @db.ObjectId
  patientId       String?              @db.ObjectId  // Optional for anonymous surveys

  // Response data
  answers         Json                 // Array of answer objects matching question IDs
  status          SurveyResponseStatus @default(STARTED)

  // Metadata
  startedAt       DateTime             @default(now())
  completedAt     DateTime?
  timeSpent       Int?                 // Seconds spent on survey
  ipAddress       String?              // For duplicate detection
  userAgent       String?

  // Scoring (for NPS and satisfaction surveys)
  overallScore    Float?               // Calculated overall score if applicable
  npsScore        Int?                 // NPS score if applicable (0-10)

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  clinic          Clinic               @relation(fields: [clinicId], references: [id])
  survey          Survey               @relation(fields: [surveyId], references: [id])
  patient         Patient?             @relation(fields: [patientId], references: [id])

  @@index([surveyId, status])
  @@index([clinicId, patientId])
  @@index([surveyId, createdAt])
  @@map("survey_responses")
}

// =============================================================================
// PATIENT PORTAL - Patient-facing mobile PWA for self-service
// =============================================================================

// -----------------------------------------------------------------------------
// Portal Account - Patient authentication for the portal
// -----------------------------------------------------------------------------

/// PortalAccountStatus - Status of portal account
enum PortalAccountStatus {
  PENDING           // Account created but not verified
  ACTIVE            // Account is active and usable
  SUSPENDED         // Temporarily suspended
  LOCKED            // Locked due to failed attempts
  DEACTIVATED       // Deactivated by admin or patient
}

/// PortalAccount - Patient portal authentication account
model PortalAccount {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String              @db.ObjectId
  patientId           String              @unique @db.ObjectId  // One portal account per patient

  // Authentication credentials
  email               String              // Login email (can differ from patient email)
  passwordHash        String?             // Hashed password (null if using magic link only)

  // Account status
  status              PortalAccountStatus @default(PENDING)

  // Email verification
  emailVerified       Boolean             @default(false)
  emailVerifiedAt     DateTime?
  verificationToken   String?             // Token for email verification
  verificationExpires DateTime?

  // Password reset
  resetToken          String?             // Token for password reset
  resetTokenExpires   DateTime?

  // Magic link auth
  magicLinkToken      String?             // Current magic link token
  magicLinkExpires    DateTime?

  // Security
  failedLoginAttempts Int                 @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?
  lastLoginUserAgent  String?

  // Two-factor authentication (optional)
  twoFactorEnabled    Boolean             @default(false)
  twoFactorSecret     String?             // TOTP secret
  twoFactorBackupCodes String[]           @default([])

  // Push notification tokens (for PWA)
  pushTokens          Json?               // Array of { token, device, createdAt }

  // Preferences
  preferredLanguage   String              @default("en")

  // Terms and privacy acceptance
  termsAcceptedAt     DateTime?
  privacyAcceptedAt   DateTime?

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  deletedAt           DateTime?           // Soft delete

  // Relations
  clinic              Clinic              @relation(fields: [clinicId], references: [id])
  patient             Patient             @relation(fields: [patientId], references: [id])
  sessions            PortalSession[]
  activityLogs        PortalActivityLog[]

  @@unique([clinicId, email])
  @@index([clinicId])
  @@index([email])
  @@index([verificationToken])
  @@index([resetToken])
  @@index([magicLinkToken])
  @@map("portal_accounts")
}

// -----------------------------------------------------------------------------
// Portal Session - Active login sessions for portal users
// -----------------------------------------------------------------------------

/// PortalSession - Active portal session
model PortalSession {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId
  accountId           String              @db.ObjectId

  // Session token
  sessionToken        String              @unique

  // Device info
  userAgent           String?
  ipAddress           String?
  deviceType          String?             // mobile, tablet, desktop
  deviceName          String?             // e.g., "iPhone 15", "Chrome on Windows"

  // Status
  isActive            Boolean             @default(true)

  // Timestamps
  createdAt           DateTime            @default(now())
  expiresAt           DateTime
  lastActivityAt      DateTime            @default(now())
  revokedAt           DateTime?
  revokedReason       String?             // logout, expired, admin_revoke, security

  // Relations
  account             PortalAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([expiresAt])
  @@map("portal_sessions")
}

// -----------------------------------------------------------------------------
// Portal Activity Log - Audit trail for patient portal actions
// -----------------------------------------------------------------------------

/// PortalActivityType - Types of portal activities
enum PortalActivityType {
  LOGIN               // Successful login
  LOGIN_FAILED        // Failed login attempt
  LOGOUT              // Logout
  PASSWORD_CHANGE     // Changed password
  PASSWORD_RESET      // Reset password via link
  PROFILE_VIEW        // Viewed profile
  PROFILE_UPDATE      // Updated profile info
  APPOINTMENT_VIEW    // Viewed appointment details
  APPOINTMENT_BOOK    // Booked new appointment
  APPOINTMENT_CONFIRM // Confirmed appointment attendance
  APPOINTMENT_CANCEL  // Cancelled appointment
  APPOINTMENT_RESCHEDULE // Rescheduled appointment
  MESSAGE_VIEW        // Viewed messages
  MESSAGE_SEND        // Sent a message
  DOCUMENT_VIEW       // Viewed a document
  DOCUMENT_DOWNLOAD   // Downloaded a document
  PAYMENT_VIEW        // Viewed payment history
  PAYMENT_MAKE        // Made a payment
  SETTINGS_CHANGE     // Changed settings
  TWO_FACTOR_ENABLE   // Enabled 2FA
  TREATMENT_VIEW      // Viewed treatment progress
  TWO_FACTOR_DISABLE  // Disabled 2FA
}

/// PortalActivityLog - Audit log of patient portal activity
model PortalActivityLog {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId
  accountId           String              @db.ObjectId

  // Activity details
  activityType        PortalActivityType
  description         String?             // Human-readable description

  // Related entity (optional)
  relatedType         String?             // appointment, message, document, payment
  relatedId           String?             @db.ObjectId

  // Request context
  ipAddress           String?
  userAgent           String?

  // Additional metadata
  metadata            Json?               // Any additional context

  // Timestamp
  createdAt           DateTime            @default(now())

  // Relations
  account             PortalAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, createdAt])
  @@index([activityType])
  @@map("portal_activity_logs")
}

// =============================================================================
// TREATMENT MANAGEMENT AREA - Treatment plans, progress tracking, milestones
// =============================================================================

/// TreatmentPlanStatus - Status of treatment plan lifecycle
enum TreatmentPlanStatus {
  DRAFT           // Being created
  PRESENTED       // Presented to patient
  ACCEPTED        // Patient accepted
  ACTIVE          // Currently in progress
  ON_HOLD         // Temporarily paused
  COMPLETED       // Successfully finished
  DISCONTINUED    // Stopped before completion
  TRANSFERRED     // Patient transferred to another provider
}

/// TreatmentPhaseType - Types of treatment phases
enum TreatmentPhaseType {
  INITIAL_ALIGNMENT   // Initial tooth movement
  LEVELING            // Leveling and alignment
  SPACE_CLOSURE       // Closing extraction spaces
  FINISHING           // Fine-tuning positions
  DETAILING           // Final adjustments
  RETENTION           // Post-treatment retention
  OBSERVATION         // Monitoring period
  CUSTOM              // Custom phase
}

/// PhaseStatus - Status of individual phases
enum PhaseStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

/// MilestoneStatus - Status of treatment milestones
enum MilestoneStatus {
  PENDING       // Not yet started
  IN_PROGRESS   // Currently working toward
  ACHIEVED      // Successfully reached
  MISSED        // Target date passed
  DEFERRED      // Postponed
}

/// TreatmentPlan - Patient treatment plan
model TreatmentPlan {
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String              @db.ObjectId
  patientId             String              @db.ObjectId

  // Plan identification
  planNumber            String              // Unique identifier (e.g., "TP-2024-001")
  planName              String              // Display name (e.g., "Full Orthodontic Treatment")
  planType              String?             // Type of treatment

  // Status tracking
  status                TreatmentPlanStatus @default(DRAFT)
  version               Int                 @default(1) // For tracking modifications

  // Clinical details
  chiefComplaint        String?             // Patient's primary concern
  diagnosis             String[]            // Clinical diagnoses
  treatmentGoals        String[]            // Goals to achieve
  treatmentDescription  String?             // Overview description

  // Provider assignment
  primaryProviderId     String?             @db.ObjectId
  supervisingProviderId String?             @db.ObjectId

  // Duration and estimates
  estimatedDuration     Int?                // In months
  estimatedVisits       Int?                // Expected number of visits
  totalFee              Float?              // Total treatment cost

  // Important dates
  presentedDate         DateTime?           // When presented to patient
  acceptedDate          DateTime?           // When patient accepted
  startDate             DateTime?           // Actual treatment start
  estimatedEndDate      DateTime?           // Expected completion
  actualEndDate         DateTime?           // Actual completion

  // Timestamps & Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  deletedAt             DateTime?           // Soft delete
  createdBy             String?             @db.ObjectId
  updatedBy             String?             @db.ObjectId

  // Relations
  clinic                Clinic              @relation(fields: [clinicId], references: [id])
  patient               Patient             @relation(fields: [patientId], references: [id])
  primaryProvider       StaffProfile?       @relation("TreatmentPlanPrimaryProvider", fields: [primaryProviderId], references: [id])
  supervisingProvider   StaffProfile?       @relation("TreatmentPlanSupervisingProvider", fields: [supervisingProviderId], references: [id])
  phases                TreatmentPhase[]
  milestones            TreatmentMilestone[]
  progressPhotos        TreatmentPhoto[]

  // Treatment Planning relations
  treatmentOptions      TreatmentOption[]
  casePresentations     CasePresentation[]
  caseAcceptances       CaseAcceptance[]

  // Imaging Management relations
  patientImages         PatientImage[]
  progressReports       ProgressReport[]

  // Clinical Documentation relations
  progressNotes         ProgressNote[]
  visitRecords          VisitRecord[]

  // Appliance Management relations
  applianceRecords        ApplianceRecord[]
  alignerRecords          AlignerRecord[]
  retainerRecords         RetainerRecord[]
  elasticPrescriptions    ElasticPrescription[]

  // Plan versioning relations
  planModifications     PlanModification[]

  // Treatment Tracking relations
  treatmentProgress       TreatmentProgress[]
  debondReadiness         DebondReadiness[]
  retentionProtocol       RetentionProtocol[]
  treatmentOutcome        TreatmentOutcome?

  // Lab Work Management relations
  labOrders               LabOrder[]

  @@index([clinicId])
  @@index([patientId])
  @@index([primaryProviderId])
  @@index([status])
  @@map("treatment_plans")
}

/// TreatmentOptionStatus - Status of a treatment option
enum TreatmentOptionStatus {
  DRAFT           // Being developed
  PRESENTED       // Shown to patient
  SELECTED        // Patient chose this option
  DECLINED        // Patient declined
  ARCHIVED        // No longer relevant
}

/// ApplianceSystemType - Types of appliance systems
enum ApplianceSystemType {
  METAL_BRACKETS
  CERAMIC_BRACKETS
  SELF_LIGATING
  LINGUAL
  CLEAR_ALIGNERS
  COMBINATION
  FUNCTIONAL
  SURGICAL
  RETENTION_ONLY
}

/// TreatmentOption - Alternative treatment options within a plan
model TreatmentOption {
  id                  String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String                @db.ObjectId
  treatmentPlanId     String                @db.ObjectId

  // Option identification
  optionNumber        Int                   // 1, 2, 3, etc.
  optionName          String                // e.g., "Traditional Braces", "Invisalign"
  description         String?               // Detailed description

  // Appliance details
  applianceSystem     ApplianceSystemType
  applianceDetails    String?               // Specific product/brand details

  // Duration and cost
  estimatedDuration   Int?                  // In months
  estimatedVisits     Int?                  // Expected visits
  estimatedCost       Float?                // Treatment cost

  // Recommendation
  isRecommended       Boolean               @default(false)
  recommendationNotes String?               // Why recommended or not

  // Patient selection
  status              TreatmentOptionStatus @default(DRAFT)
  selectedDate        DateTime?             // When patient selected this option
  selectionNotes      String?               // Patient's reasoning

  // Pros and Cons
  advantages          String[]              // List of pros
  disadvantages       String[]              // List of cons

  // Timestamps
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  deletedAt           DateTime?             // Soft delete

  // Relations
  clinic              Clinic                @relation(fields: [clinicId], references: [id])
  treatmentPlan       TreatmentPlan         @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  caseAcceptances     CaseAcceptance[]      // When this option is selected

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@map("treatment_options")
}

/// CasePresentationOutcome - Result of case presentation
enum CasePresentationOutcome {
  ACCEPTED          // Patient accepted treatment
  DECLINED          // Patient declined
  THINKING          // Patient considering
  FOLLOW_UP_NEEDED  // Needs follow-up discussion
  SECOND_OPINION    // Seeking second opinion
  RESCHEDULED       // Will present again later
}

/// CasePresentation - Record of treatment presentation to patient
model CasePresentation {
  id                  String                    @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String                    @db.ObjectId
  treatmentPlanId     String                    @db.ObjectId
  patientId           String                    @db.ObjectId

  // Presentation details
  presentationDate    DateTime
  presentedById       String                    @db.ObjectId  // Provider who presented

  // Location/Method
  presentationType    String                    @default("IN_PERSON") // IN_PERSON, VIRTUAL
  location            String?                   // Room or virtual platform

  // Attendees
  attendees           String[]                  // Names/roles of people present
  guardianPresent     Boolean                   @default(false)
  guardianName        String?

  // Content presented
  treatmentOptionsPresented String[]            @db.ObjectId  // IDs of options shown
  visualsUsed         String[]                  // Types: PHOTOS, XRAYS, MODELS, SIMULATIONS
  materialsProvided   String[]                  // Brochures, estimates given

  // Outcome
  outcome             CasePresentationOutcome   @default(THINKING)
  outcomeNotes        String?                   // Details about outcome
  patientQuestions    String[]                  // Questions asked
  patientConcerns     String[]                  // Concerns raised

  // Follow-up
  followUpRequired    Boolean                   @default(false)
  followUpDate        DateTime?
  followUpNotes       String?

  // Duration
  durationMinutes     Int?

  // Timestamps
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  deletedAt           DateTime?                 // Soft delete

  // Relations
  clinic              Clinic                    @relation(fields: [clinicId], references: [id])
  treatmentPlan       TreatmentPlan             @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  patient             Patient                   @relation(fields: [patientId], references: [id])
  presentedBy         StaffProfile              @relation("CasePresentationPresenter", fields: [presentedById], references: [id])

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([patientId])
  @@index([presentationDate])
  @@map("case_presentations")
}

/// ConsentType - Types of consent documents
enum ConsentType {
  INFORMED_CONSENT        // General treatment consent
  FINANCIAL_AGREEMENT     // Payment terms
  HIPAA_ACKNOWLEDGMENT    // Privacy practices
  PHOTO_RELEASE           // Photography consent
  MINOR_CONSENT           // Guardian consent for minor
  TREATMENT_MODIFICATION  // Consent for plan changes
}

/// CaseAcceptanceStatus - Status of case acceptance
enum CaseAcceptanceStatus {
  PENDING           // Awaiting signatures
  PARTIALLY_SIGNED  // Some signatures collected
  FULLY_SIGNED      // All signatures collected
  EXPIRED           // Acceptance window expired
  WITHDRAWN         // Patient withdrew acceptance
}

/// CaseAcceptance - Patient acceptance of treatment plan
model CaseAcceptance {
  id                  String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String                @db.ObjectId
  treatmentPlanId     String                @db.ObjectId
  patientId           String                @db.ObjectId
  casePresentationId  String?               @db.ObjectId  // Link to presentation

  // Acceptance status
  status              CaseAcceptanceStatus  @default(PENDING)
  acceptedDate        DateTime?             // When fully accepted

  // Selected option
  selectedOptionId    String?               @db.ObjectId  // Which option patient chose

  // Consent tracking
  informedConsentSigned     Boolean         @default(false)
  informedConsentDate       DateTime?
  financialAgreementSigned  Boolean         @default(false)
  financialAgreementDate    DateTime?
  hipaaAcknowledged         Boolean         @default(false)
  hipaaAcknowledgedDate     DateTime?
  photoReleaseConsent       Boolean         @default(false)
  photoReleaseDate          DateTime?

  // Financial terms
  totalTreatmentCost  Float?                // Agreed treatment cost
  downPayment         Float?                // Initial payment
  monthlyPayment      Float?                // If payment plan
  paymentPlanMonths   Int?                  // Duration of payment plan
  insuranceEstimate   Float?                // Estimated insurance coverage
  patientResponsibility Float?              // Patient's out-of-pocket

  // Signatures (stored as base64 or reference)
  patientSignature    String?               // Digital signature data
  patientSignedDate   DateTime?
  guardianSignature   String?               // If minor
  guardianSignedDate  DateTime?
  guardianName        String?
  guardianRelation    String?               // Parent, Guardian, etc.

  // Witness
  witnessedById       String?               @db.ObjectId
  witnessedDate       DateTime?

  // Documents
  documentUrls        String[]              // URLs to signed documents

  // Notes
  specialConditions   String?               // Any special terms
  notes               String?

  // Timestamps
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  deletedAt           DateTime?             // Soft delete

  // Relations
  clinic              Clinic                @relation(fields: [clinicId], references: [id])
  treatmentPlan       TreatmentPlan         @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  patient             Patient               @relation(fields: [patientId], references: [id])
  selectedOption      TreatmentOption?      @relation(fields: [selectedOptionId], references: [id])
  witnessedBy         StaffProfile?         @relation("CaseAcceptanceWitness", fields: [witnessedById], references: [id])

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([patientId])
  @@index([status])
  @@map("case_acceptances")
}

/// PlanModificationType - Types of treatment plan modifications
enum PlanModificationType {
  MINOR_ADJUSTMENT        // Small changes, no version bump
  PHASE_ADDITION          // Adding new treatment phase
  PHASE_REMOVAL           // Removing a treatment phase
  APPLIANCE_CHANGE        // Changing appliance type (requires consent)
  DURATION_EXTENSION      // Extending treatment duration
  DURATION_REDUCTION      // Reducing treatment duration
  TREATMENT_UPGRADE       // Upgrading treatment approach
  TREATMENT_DOWNGRADE     // Downgrading treatment approach
  FEE_ADJUSTMENT          // Changing treatment cost
  PROVIDER_CHANGE         // Changing assigned provider
  GOAL_MODIFICATION       // Changing treatment goals
  CLINICAL_PROTOCOL       // Changing clinical approach
  OTHER                   // Other modifications
}

/// PlanModification - Track changes to treatment plans with versioning
model PlanModification {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId
  treatmentPlanId       String                @db.ObjectId

  // Modification details
  modificationType      PlanModificationType
  modificationDate      DateTime              @default(now())
  modifiedById          String                @db.ObjectId    // Staff who made the change

  // Version tracking
  previousVersion       Int                   // Version before change
  newVersion            Int                   // Version after change (null for minor)
  createsNewVersion     Boolean               @default(false) // Whether this created a version bump

  // Change details
  changeDescription     String                // Human-readable description
  reason                String                // Why the change was made
  changedFields         Json?                 // Field-level changes { field: { old, new } }

  // Financial impact
  previousFee           Float?                // Fee before change
  newFee                Float?                // Fee after change
  feeChangeAmount       Float?                // Difference (can be negative)

  // Acknowledgment (for significant changes)
  requiresAcknowledgment  Boolean             @default(false)
  acknowledgedAt          DateTime?
  acknowledgedById        String?             @db.ObjectId    // Patient or guardian who acknowledged
  acknowledgmentMethod    String?             // 'signature', 'verbal', 'portal', etc.
  acknowledgmentNotes     String?

  // New consent (for major changes like appliance change)
  requiresNewConsent      Boolean             @default(false)
  newConsentObtained      Boolean             @default(false)
  consentDate             DateTime?
  consentDocumentUrl      String?             // URL to new consent document

  // Snapshot of previous state (for comparison/rollback)
  previousStateSnapshot   Json?               // Full plan state before modification

  // Timestamps
  createdAt             DateTime              @default(now())

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  treatmentPlan         TreatmentPlan         @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  modifiedBy            StaffProfile          @relation("PlanModificationModifiedBy", fields: [modifiedById], references: [id])
  acknowledgedBy        Patient?              @relation("PlanModificationAcknowledgedBy", fields: [acknowledgedById], references: [id])

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([modificationDate])
  @@index([modificationType])
  @@map("plan_modifications")
}

/// TreatmentPhase - Individual phases within a treatment plan
model TreatmentPhase {
  id                  String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String            @db.ObjectId
  treatmentPlanId     String            @db.ObjectId

  // Phase identification
  phaseNumber         Int               // Order within plan (1, 2, 3...)
  phaseName           String            // Display name
  phaseType           TreatmentPhaseType @default(CUSTOM)
  description         String?           // What this phase involves
  objectives          String[]          // Phase-specific goals

  // Status tracking
  status              PhaseStatus       @default(NOT_STARTED)

  // Timeline
  plannedStartDate    DateTime?
  plannedEndDate      DateTime?
  actualStartDate     DateTime?
  actualEndDate       DateTime?

  // Progress tracking
  estimatedVisits     Int?
  completedVisits     Int               @default(0)
  progressPercent     Int               @default(0) // 0-100

  // Notes
  notes               String?

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?           // Soft delete

  // Relations
  clinic              Clinic            @relation(fields: [clinicId], references: [id])
  treatmentPlan       TreatmentPlan     @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  images              PatientImage[]
  milestones          TreatmentMilestone[]

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@map("treatment_phases")
}

/// TreatmentMilestone - Key milestones in treatment progress
model TreatmentMilestone {
  id                  String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String            @db.ObjectId
  treatmentPlanId     String            @db.ObjectId
  phaseId             String?           @db.ObjectId  // Optional link to specific phase

  // Milestone details
  milestoneName       String            // e.g., "Initial Alignment Complete"
  milestoneType       String?           // Type category
  description         String?           // What this milestone represents

  // Status
  status              MilestoneStatus   @default(PENDING)

  // Dates
  targetDate          DateTime?         // When we aim to achieve
  achievedDate        DateTime?         // When actually achieved

  // Additional info
  completionCriteria  String?           // What defines completion
  notes               String?

  // Visible to patient in portal
  visibleToPatient    Boolean           @default(true)
  patientDescription  String?           // Patient-friendly description

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?           // Soft delete

  // Relations
  clinic              Clinic            @relation(fields: [clinicId], references: [id])
  treatmentPlan       TreatmentPlan     @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  phase               TreatmentPhase?   @relation(fields: [phaseId], references: [id])

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([phaseId])
  @@map("treatment_milestones")
}

/// TreatmentPhoto - Progress photos associated with treatment
model TreatmentPhoto {
  id                  String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String            @db.ObjectId
  treatmentPlanId     String            @db.ObjectId
  patientId           String            @db.ObjectId

  // Photo details
  photoType           String            // "BEFORE", "PROGRESS", "AFTER"
  photoCategory       String?           // "FRONTAL", "LATERAL", "OCCLUSAL", "SMILE"
  description         String?

  // File storage
  fileUrl             String            // URL to stored image
  thumbnailUrl        String?           // Thumbnail version
  fileName            String?
  fileSize            Int?              // In bytes
  mimeType            String?           // e.g., "image/jpeg"

  // Metadata
  takenDate           DateTime?         // When photo was taken
  takenBy             String?           @db.ObjectId // Provider/staff who took it

  // Portal visibility
  visibleToPatient    Boolean           @default(true)

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?         // Soft delete

  // Relations
  clinic              Clinic            @relation(fields: [clinicId], references: [id])
  treatmentPlan       TreatmentPlan     @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  patient             Patient           @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([patientId])
  @@index([photoType])
  @@map("treatment_photos")
}

// =============================================================================
// CLINICAL DOCUMENTATION - Progress notes, procedures, findings, measurements
// =============================================================================

/// ProgressNoteType - Types of clinical progress notes
enum ProgressNoteType {
  INITIAL_EXAM
  CONSULTATION
  RECORDS_APPOINTMENT
  BONDING
  ADJUSTMENT
  EMERGENCY
  DEBOND
  RETENTION_CHECK
  OBSERVATION
  GENERAL
}

/// NoteStatus - Status of progress notes
enum NoteStatus {
  DRAFT
  PENDING_SIGNATURE
  SIGNED
  PENDING_COSIGN
  COSIGNED
  AMENDED
}

/// ClinicalFindingType - Types of clinical findings
enum ClinicalFindingType {
  DECALCIFICATION
  CARIES
  GINGIVITIS
  BRACKET_ISSUE
  WIRE_ISSUE
  ELASTIC_COMPLIANCE
  ORAL_HYGIENE
  ROOT_RESORPTION
  IMPACTION
  ECTOPIC_ERUPTION
  ANKYLOSIS
  OTHER
}

/// Severity - Severity levels for clinical findings
enum Severity {
  MILD
  MODERATE
  SEVERE
}

/// OrthoMeasurementType - Types of orthodontic measurements
enum OrthoMeasurementType {
  OVERJET
  OVERBITE
  OVERBITE_PERCENT
  CROWDING_UPPER
  CROWDING_LOWER
  SPACING_UPPER
  SPACING_LOWER
  MIDLINE_UPPER
  MIDLINE_LOWER
  MOLAR_RELATIONSHIP_RIGHT
  MOLAR_RELATIONSHIP_LEFT
  CANINE_RELATIONSHIP_RIGHT
  CANINE_RELATIONSHIP_LEFT
  ARCH_LENGTH_UPPER
  ARCH_LENGTH_LOWER
  INTERCANINE_WIDTH_UPPER
  INTERCANINE_WIDTH_LOWER
  INTERMOLAR_WIDTH_UPPER
  INTERMOLAR_WIDTH_LOWER
  CROSSBITE
  OPEN_BITE
}

/// MeasurementMethod - Method used to record measurement
enum MeasurementMethod {
  CLINICAL
  MODEL_ANALYSIS
  DIGITAL_SCAN
  CEPHALOMETRIC
}

/// Quadrant - Dental quadrant identifiers
enum Quadrant {
  UPPER_RIGHT
  UPPER_LEFT
  LOWER_LEFT
  LOWER_RIGHT
}

/// Arch - Dental arch identifiers
enum Arch {
  UPPER
  LOWER
  BOTH
}

/// ProcedureStatus - Status of procedure records
enum ProcedureStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED
}

/// ProgressNote - Clinical progress notes in SOAP format
model ProgressNote {
  id                    String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String           @db.ObjectId
  patientId             String           @db.ObjectId
  treatmentPlanId       String?          @db.ObjectId
  appointmentId         String?          @db.ObjectId

  // Note Details
  noteDate              DateTime         @default(now())
  noteType              ProgressNoteType
  chiefComplaint        String?

  // Clinical Content (SOAP format)
  subjective            String?          // Patient-reported symptoms, concerns
  objective             String?          // Clinical findings, observations
  assessment            String?          // Provider's clinical assessment
  plan                  String?          // Next steps, treatment modifications

  // Procedures Summary
  proceduresSummary     String?

  // Provider
  providerId            String           @db.ObjectId
  supervisingProviderId String?          @db.ObjectId

  // Signatures
  status                NoteStatus       @default(DRAFT)
  signedAt              DateTime?
  signedById            String?          @db.ObjectId
  coSignedAt            DateTime?
  coSignedById          String?          @db.ObjectId

  // Amendments
  isAmended             Boolean          @default(false)
  amendmentReason       String?
  amendedAt             DateTime?

  // Attachments
  imageIds              String[]         @db.ObjectId

  // Timestamps & Audit
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  deletedAt             DateTime?
  createdBy             String?          @db.ObjectId
  updatedBy             String?          @db.ObjectId

  // Relations
  clinic                Clinic           @relation(fields: [clinicId], references: [id])
  patient               Patient          @relation(fields: [patientId], references: [id])
  treatmentPlan         TreatmentPlan?   @relation(fields: [treatmentPlanId], references: [id])
  provider              StaffProfile     @relation("ProgressNoteProvider", fields: [providerId], references: [id])
  supervisingProvider   StaffProfile?    @relation("ProgressNoteSupervisor", fields: [supervisingProviderId], references: [id])
  signedBy              StaffProfile?    @relation("ProgressNoteSigner", fields: [signedById], references: [id])
  coSignedBy            StaffProfile?    @relation("ProgressNoteCoSigner", fields: [coSignedById], references: [id])
  procedures            ProcedureRecord[]
  findings              ClinicalFinding[]
  measurements          ClinicalMeasurement[]

  @@index([clinicId])
  @@index([patientId])
  @@index([treatmentPlanId])
  @@index([providerId])
  @@index([noteDate])
  @@index([status])
  @@map("progress_notes")
}

/// ProcedureRecord - Documents procedures performed with ADA codes
model ProcedureRecord {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String          @db.ObjectId
  progressNoteId   String          @db.ObjectId

  // Procedure Details
  procedureCode    String          // ADA code (e.g., D8080)
  procedureName    String          // Description
  description      String?

  // Location
  toothNumbers     Int[]           // Affected teeth
  quadrant         Quadrant?
  arch             Arch?

  // Provider
  performedById    String          @db.ObjectId
  assistedById     String?         @db.ObjectId

  // Timing
  performedAt      DateTime        @default(now())
  duration         Int?            // In minutes

  // Status
  status           ProcedureStatus @default(COMPLETED)

  // Notes
  notes            String?
  complications    String?

  // Timestamps
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  clinic           Clinic          @relation(fields: [clinicId], references: [id])
  progressNote     ProgressNote    @relation(fields: [progressNoteId], references: [id], onDelete: Cascade)
  performedBy      StaffProfile    @relation("ProcedurePerformer", fields: [performedById], references: [id])
  assistedBy       StaffProfile?   @relation("ProcedureAssistant", fields: [assistedById], references: [id])

  @@index([clinicId])
  @@index([progressNoteId])
  @@index([procedureCode])
  @@map("procedure_records")
}

/// ClinicalFinding - Clinical observations and issues
model ClinicalFinding {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String              @db.ObjectId
  progressNoteId   String              @db.ObjectId

  // Finding Details
  findingType      ClinicalFindingType
  description      String
  severity         Severity?

  // Location
  toothNumbers     Int[]
  location         String?

  // Clinical Action
  actionRequired   Boolean             @default(false)
  actionTaken      String?
  followUpRequired Boolean             @default(false)

  // Timestamps
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Relations
  clinic           Clinic              @relation(fields: [clinicId], references: [id])
  progressNote     ProgressNote        @relation(fields: [progressNoteId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([progressNoteId])
  @@index([findingType])
  @@map("clinical_findings")
}

/// ClinicalMeasurement - Orthodontic measurements tracking
model ClinicalMeasurement {
  id               String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId         String               @db.ObjectId
  patientId        String               @db.ObjectId
  progressNoteId   String?              @db.ObjectId

  // Measurement Details
  measurementDate  DateTime             @default(now())
  measurementType  OrthoMeasurementType
  value            Float                // Measurement value
  unit             String               @default("mm")

  // Recording
  recordedById     String               @db.ObjectId
  method           MeasurementMethod?

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  // Relations
  clinic           Clinic               @relation(fields: [clinicId], references: [id])
  patient          Patient              @relation(fields: [patientId], references: [id])
  progressNote     ProgressNote?        @relation(fields: [progressNoteId], references: [id])
  recordedBy       StaffProfile         @relation("MeasurementRecorder", fields: [recordedById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([measurementType])
  @@index([measurementDate])
  @@map("clinical_measurements")
}

/// NoteTemplate - Custom documentation templates
model NoteTemplate {
  id                  String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String?          @db.ObjectId  // null for system templates
  providerId          String?          @db.ObjectId  // null for shared templates

  // Template Details
  templateName        String
  templateType        ProgressNoteType
  description         String?

  // Content
  defaultSubjective   String?
  defaultObjective    String?
  defaultAssessment   String?
  defaultPlan         String?
  defaultProcedures   String[]         // Procedure codes

  // Status
  isActive            Boolean          @default(true)
  isSystemTemplate    Boolean          @default(false)

  // Timestamps
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  clinic              Clinic?          @relation(fields: [clinicId], references: [id])
  provider            StaffProfile?    @relation("NoteTemplateOwner", fields: [providerId], references: [id])

  @@index([clinicId])
  @@index([providerId])
  @@index([templateType])
  @@map("note_templates")
}

/// VisitRecordStatus - Status of visit documentation
enum VisitRecordStatus {
  IN_PROGRESS
  COMPLETE
  INCOMPLETE
  CANCELLED
}

/// VisitRecord - Aggregates all documentation for a single patient visit
model VisitRecord {
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String              @db.ObjectId
  patientId             String              @db.ObjectId
  appointmentId         String?             @db.ObjectId @unique
  treatmentPlanId       String?             @db.ObjectId

  // Visit Details
  visitDate             DateTime            @default(now())
  visitType             ProgressNoteType    // Uses same types as progress notes
  status                VisitRecordStatus   @default(IN_PROGRESS)

  // Provider
  primaryProviderId     String              @db.ObjectId
  assistingStaffIds     String[]            @db.ObjectId

  // Visit Summary
  chiefComplaint        String?
  visitSummary          String?
  nextVisitRecommendation String?

  // Timing
  checkInTime           DateTime?
  checkOutTime          DateTime?
  treatmentDuration     Int?                // Total treatment time in minutes

  // Linked Documentation IDs
  progressNoteId        String?             @db.ObjectId @unique
  procedureIds          String[]            @db.ObjectId
  findingIds            String[]            @db.ObjectId
  measurementIds        String[]            @db.ObjectId
  imageIds              String[]            @db.ObjectId

  // Completion Tracking
  completedAt           DateTime?
  completedById         String?             @db.ObjectId

  // Timestamps & Audit
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  deletedAt             DateTime?
  createdBy             String?             @db.ObjectId
  updatedBy             String?             @db.ObjectId

  // Relations
  clinic                Clinic              @relation(fields: [clinicId], references: [id])
  patient               Patient             @relation(fields: [patientId], references: [id])
  treatmentPlan         TreatmentPlan?      @relation(fields: [treatmentPlanId], references: [id])
  primaryProvider       StaffProfile        @relation("VisitPrimaryProvider", fields: [primaryProviderId], references: [id])
  completedBy           StaffProfile?       @relation("VisitCompletedBy", fields: [completedById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([visitDate])
  @@index([status])
  @@map("visit_records")
}

// =============================================================================
// APPLIANCE MANAGEMENT - Brackets, wires, aligners, retainers tracking
// =============================================================================

/// ApplianceRecordType - Types of orthodontic appliances
enum ApplianceRecordType {
  BRACKETS
  BANDS
  ALIGNERS
  RETAINER_FIXED
  RETAINER_REMOVABLE
  EXPANDER
  HERBST
  MARA
  HEADGEAR
  FACEMASK
  TAD
  ELASTICS
  SPRING
  POWER_CHAIN
  OTHER
}

/// ApplianceStatus - Status of an appliance
enum ApplianceStatus {
  ORDERED
  RECEIVED
  ACTIVE
  ADJUSTED
  REMOVED
  REPLACED
  LOST
  BROKEN
}

/// WireType - Types of orthodontic wires
enum WireType {
  ROUND
  RECTANGULAR
  SQUARE
}

/// WireMaterial - Materials for orthodontic wires
enum WireMaterial {
  NITI
  NITI_HEAT
  STAINLESS_STEEL
  TMA
  BETA_TITANIUM
  COPPER_NITI
}

/// WireStatus - Status of a wire
enum WireStatus {
  ACTIVE
  REMOVED
  BROKEN
  REPLACED
}

/// AlignerTreatmentStatus - Status of aligner treatment
enum AlignerTreatmentStatus {
  SUBMITTED
  APPROVED
  MANUFACTURING
  IN_PROGRESS
  REFINEMENT
  COMPLETED
  DISCONTINUED
}

/// RetainerType - Types of retainers
enum RetainerType {
  HAWLEY
  ESSIX
  VIVERA
  FIXED_BONDED
  SPRING_RETAINER
  WRAP_AROUND
}

/// RetainerStatus - Status of a retainer
enum RetainerStatus {
  ORDERED
  IN_FABRICATION
  RECEIVED
  DELIVERED
  ACTIVE
  REPLACED
  LOST
  BROKEN
}

/// RetentionWearSchedule - Retainer wear schedule options
enum RetentionWearSchedule {
  FULL_TIME
  NIGHTS_ONLY
  EVERY_OTHER_NIGHT
  FEW_NIGHTS_WEEK
  AS_NEEDED
}

/// ApplianceRecord - Tracks all orthodontic appliances
model ApplianceRecord {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String              @db.ObjectId
  patientId       String              @db.ObjectId
  treatmentPlanId String?             @db.ObjectId

  // Appliance Details
  applianceType   ApplianceRecordType
  applianceSystem String?             // Brand/system (e.g., "Damon", "In-Ovation")
  manufacturer    String?

  // Configuration
  specification   Json?               // Detailed specs (bracket prescription, etc.)

  // Placement
  arch            Arch
  toothNumbers    Int[]               // Which teeth

  // Dates
  placedDate      DateTime?
  removedDate     DateTime?

  // Status
  status          ApplianceStatus     @default(ACTIVE)

  // Provider
  placedById      String?             @db.ObjectId
  removedById     String?             @db.ObjectId

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  clinic                Clinic              @relation(fields: [clinicId], references: [id])
  patient               Patient             @relation(fields: [patientId], references: [id])
  treatmentPlan         TreatmentPlan?      @relation(fields: [treatmentPlanId], references: [id])
  placedBy              StaffProfile?       @relation("AppliancePlacedBy", fields: [placedById], references: [id])
  removedBy             StaffProfile?       @relation("ApplianceRemovedBy", fields: [removedById], references: [id])
  wireRecords           WireRecord[]
  elasticPrescriptions  ElasticPrescription[]
  applianceActivations  ApplianceActivation[]

  @@index([clinicId])
  @@index([patientId])
  @@index([treatmentPlanId])
  @@index([applianceType])
  @@index([status])
  @@map("appliance_records")
}

/// WireRecord - Tracks wire changes/progressions
model WireRecord {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String          @db.ObjectId
  applianceRecordId String          @db.ObjectId

  // Wire Details
  wireType          WireType
  wireSize          String          // e.g., "0.014", "0.016x0.022"
  wireMaterial      WireMaterial
  manufacturer      String?

  // Placement
  arch              Arch

  // Dates
  placedDate        DateTime
  removedDate       DateTime?

  // Status
  status            WireStatus      @default(ACTIVE)

  // Provider
  placedById        String          @db.ObjectId
  removedById       String?         @db.ObjectId

  // Sequence
  sequenceNumber    Int             @default(1)

  // Notes
  notes             String?
  bends             String?         // Custom bends applied

  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  clinic            Clinic          @relation(fields: [clinicId], references: [id])
  applianceRecord   ApplianceRecord @relation(fields: [applianceRecordId], references: [id])
  placedBy          StaffProfile    @relation("WirePlacedBy", fields: [placedById], references: [id])
  removedBy         StaffProfile?   @relation("WireRemovedBy", fields: [removedById], references: [id])

  @@index([clinicId])
  @@index([applianceRecordId])
  @@index([placedDate])
  @@index([status])
  @@map("wire_records")
}

/// AlignerRecord - Tracks aligner treatment cases
model AlignerRecord {
  id                String                  @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String                  @db.ObjectId
  patientId         String                  @db.ObjectId
  treatmentPlanId   String?                 @db.ObjectId

  // Aligner Details
  alignerSystem     String                  // e.g., "Invisalign", "ClearCorrect", "SureSmile"
  caseNumber        String?                 // Lab case number

  // Treatment Info
  totalAligners     Int                     // Total aligners in treatment
  currentAligner    Int                     @default(1)
  refinementNumber  Int                     @default(0) // 0 = initial, 1+ = refinements

  // Status
  status            AlignerTreatmentStatus  @default(IN_PROGRESS)

  // Dates
  startDate         DateTime
  estimatedEndDate  DateTime?
  actualEndDate     DateTime?

  // Delivery
  alignersDelivered Int                     @default(0)
  lastDeliveryDate  DateTime?

  // Wear Compliance
  averageWearHours  Float?                  // Average daily wear hours

  // Timestamps
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  // Relations
  clinic            Clinic                  @relation(fields: [clinicId], references: [id])
  patient           Patient                 @relation(fields: [patientId], references: [id])
  treatmentPlan     TreatmentPlan?          @relation(fields: [treatmentPlanId], references: [id])
  deliveries        AlignerDelivery[]

  @@index([clinicId])
  @@index([patientId])
  @@index([treatmentPlanId])
  @@index([status])
  @@map("aligner_records")
}

/// AlignerDelivery - Individual aligner delivery records
model AlignerDelivery {
  id                  String        @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String        @db.ObjectId
  alignerRecordId     String        @db.ObjectId

  // Delivery Details
  deliveryDate        DateTime
  alignerNumberStart  Int           // First aligner in batch
  alignerNumberEnd    Int           // Last aligner in batch

  // Instructions
  wearSchedule        Int           @default(14) // Days per aligner
  wearHoursPerDay     Int           @default(22)

  // Attachments
  attachmentsPlaced   Boolean       @default(false)
  attachmentTeeth     Int[]         // Which teeth got attachments

  // IPR (Interproximal Reduction)
  iprPerformed        Boolean       @default(false)
  iprDetails          String?       // Details of IPR performed

  // Provider
  deliveredById       String        @db.ObjectId

  // Notes
  instructions        String?       // Patient instructions
  notes               String?

  // Timestamps
  createdAt           DateTime      @default(now())

  // Relations
  clinic              Clinic        @relation(fields: [clinicId], references: [id])
  alignerRecord       AlignerRecord @relation(fields: [alignerRecordId], references: [id])
  deliveredBy         StaffProfile  @relation("AlignerDeliveredBy", fields: [deliveredById], references: [id])

  @@index([clinicId])
  @@index([alignerRecordId])
  @@map("aligner_deliveries")
}

/// RetainerRecord - Tracks retainer management
model RetainerRecord {
  id                  String                  @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String                  @db.ObjectId
  patientId           String                  @db.ObjectId
  treatmentPlanId     String?                 @db.ObjectId

  // Retainer Details
  retainerType        RetainerType
  arch                Arch
  material            String?

  // Lab
  labOrderId          String?                 @db.ObjectId // Link to lab order if applicable

  // Dates
  orderedDate         DateTime?
  receivedDate        DateTime?
  deliveredDate       DateTime?

  // Status
  status              RetainerStatus          @default(ORDERED)

  // Delivery
  deliveredById       String?                 @db.ObjectId

  // Retention Protocol
  wearSchedule        RetentionWearSchedule?
  wearInstructions    String?

  // Replacement
  isReplacement       Boolean                 @default(false)
  replacementReason   String?
  previousRetainerId  String?                 @db.ObjectId

  // Notes
  notes               String?

  // Timestamps
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt

  // Relations
  clinic              Clinic                  @relation(fields: [clinicId], references: [id])
  patient             Patient                 @relation(fields: [patientId], references: [id])
  treatmentPlan       TreatmentPlan?          @relation(fields: [treatmentPlanId], references: [id])
  deliveredBy         StaffProfile?           @relation("RetainerDeliveredBy", fields: [deliveredById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([treatmentPlanId])
  @@index([status])
  @@map("retainer_records")
}

/// ElasticType - Types of orthodontic elastics
enum ElasticType {
  CLASS_II
  CLASS_III
  VERTICAL
  CROSS
  BOX
  TRIANGLE
  ZIG_ZAG
  CUSTOM
}

/// ElasticSize - Standard elastic sizes
enum ElasticSize {
  LIGHT_1_8
  LIGHT_3_16
  MEDIUM_1_4
  MEDIUM_5_16
  HEAVY_3_8
  HEAVY_1_2
}

/// ElasticPrescription - Document elastic wear prescriptions
model ElasticPrescription {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String              @db.ObjectId
  patientId           String              @db.ObjectId
  treatmentPlanId     String?             @db.ObjectId
  applianceRecordId   String?             @db.ObjectId

  // Elastic Details
  elasticType         ElasticType
  elasticSize         ElasticSize
  elasticForce        String?             // Force in ounces, e.g., "4.5 oz"
  manufacturer        String?

  // Attachment Points
  fromTooth           Int
  toTooth             Int
  configuration       String?             // e.g., "Upper canine to lower first molar"

  // Wear Instructions
  wearSchedule        String              // e.g., "24 hours except eating"
  hoursPerDay         Int                 @default(22)
  startDate           DateTime            @default(now())
  endDate             DateTime?

  // Status
  isActive            Boolean             @default(true)
  discontinuedDate    DateTime?
  discontinuedReason  String?

  // Compliance Notes
  complianceNotes     String?

  // Provider
  prescribedById      String              @db.ObjectId

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  clinic              Clinic              @relation(fields: [clinicId], references: [id])
  patient             Patient             @relation(fields: [patientId], references: [id])
  treatmentPlan       TreatmentPlan?      @relation(fields: [treatmentPlanId], references: [id])
  applianceRecord     ApplianceRecord?    @relation(fields: [applianceRecordId], references: [id])
  prescribedBy        StaffProfile        @relation(fields: [prescribedById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([treatmentPlanId])
  @@index([isActive])
  @@map("elastic_prescriptions")
}

/// ApplianceActivation - Track activation schedule for appliances (expanders, etc.)
model ApplianceActivation {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String              @db.ObjectId
  applianceRecordId   String              @db.ObjectId

  // Activation Details
  activationDate      DateTime
  activationType      String              // e.g., "Turn", "Adjust", "Activate"
  turns               Int?                // Number of turns for expanders
  millimeters         Float?              // Expansion in mm

  // Instructions
  instructions        String?
  nextActivationDate  DateTime?

  // Provider
  performedById       String              @db.ObjectId

  // Patient-Reported (for home activations)
  isPatientReported   Boolean             @default(false)
  reportedWearHours   Int?

  // Notes
  notes               String?

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  clinic              Clinic              @relation(fields: [clinicId], references: [id])
  applianceRecord     ApplianceRecord     @relation(fields: [applianceRecordId], references: [id])
  performedBy         StaffProfile        @relation(fields: [performedById], references: [id])

  @@index([clinicId])
  @@index([applianceRecordId])
  @@index([activationDate])
  @@map("appliance_activations")
}

// =============================================================================
// CRM & PATIENT ONBOARDING AREA - Lead management, intake forms, referrals
// =============================================================================

/// ContactMethod - Preferred method of contact
enum ContactMethod {
  PHONE
  EMAIL
  TEXT
  MAIL
}

/// LeadSource - How the lead found the practice
enum LeadSource {
  WEBSITE
  PHONE_CALL
  WALK_IN
  REFERRAL_DENTIST
  REFERRAL_PATIENT
  SOCIAL_MEDIA
  GOOGLE_ADS
  INSURANCE_DIRECTORY
  OTHER
}

/// LeadStage - Pipeline stage for lead progression
enum LeadStage {
  INQUIRY               // Initial contact
  CONTACTED             // Staff has made contact
  CONSULTATION_SCHEDULED // Appointment booked
  CONSULTATION_COMPLETED // Consultation done
  PENDING_DECISION       // Waiting for patient decision
  TREATMENT_ACCEPTED     // Patient accepted treatment
  TREATMENT_STARTED      // Treatment has begun
  LOST                   // Did not convert
}

/// LeadStatus - High-level lead status
enum LeadStatus {
  NEW
  IN_PROGRESS
  CONVERTED
  LOST
}

/// LeadPatientType - Type of patient (for leads)
enum LeadPatientType {
  NEW_PATIENT
  RETURNING_PATIENT
  TRANSFER_PATIENT
}

/// Lead - Prospective patient tracking
model Lead {
  id                   String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId             String          @db.ObjectId

  // Contact Info
  firstName            String
  lastName             String
  email                String?
  phone                String
  preferredContact     ContactMethod   @default(PHONE)

  // Lead Source
  source               LeadSource
  sourceDetails        String?         // Campaign name, referrer name, etc.
  referringDentistId   String?         @db.ObjectId

  // Pipeline
  status               LeadStatus      @default(NEW)
  stage                LeadStage       @default(INQUIRY)
  assignedToId         String?         @db.ObjectId

  // Patient Info
  patientType          LeadPatientType @default(NEW_PATIENT)
  patientAge           Int?
  isMinor              Boolean         @default(false)
  guardianName         String?
  guardianPhone        String?
  guardianEmail        String?

  // Interest / Reason
  primaryConcern       String?         // Main reason for seeking treatment
  treatmentInterest    String?         // Specific treatment interest (braces, Invisalign, etc.)
  urgency              String?         // "immediate", "within_month", "exploring"

  // Consultation
  consultationDate     DateTime?
  consultationNotes    String?

  // Conversion
  convertedAt          DateTime?
  convertedToPatientId String?         @db.ObjectId
  lostReason           String?
  lostDate             DateTime?

  // Timestamps
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  deletedAt            DateTime?       // Soft delete

  // Relations
  clinic               Clinic          @relation(fields: [clinicId], references: [id])
  assignedTo           StaffProfile?   @relation("LeadAssignee", fields: [assignedToId], references: [id])
  referringDentist     ReferringProvider? @relation(fields: [referringDentistId], references: [id])
  activities           LeadActivity[]
  tasks                LeadTask[]
  formSubmissions      FormSubmission[]
  recordsRequests      RecordsRequest[]
  intakeTokens         IntakeToken[]

  @@index([clinicId])
  @@index([status])
  @@index([stage])
  @@index([assignedToId])
  @@index([source])
  @@index([createdAt])
  @@map("leads")
}

/// LeadActivityType - Types of lead activities
enum LeadActivityType {
  NOTE
  CALL
  EMAIL
  TEXT
  MEETING
  STAGE_CHANGE
  STATUS_CHANGE
  ASSIGNMENT_CHANGE
  FORM_SUBMITTED
  DOCUMENT_UPLOADED
  SYSTEM
}

/// LeadActivity - Activity log for leads
model LeadActivity {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String           @db.ObjectId
  leadId      String           @db.ObjectId

  type        LeadActivityType
  title       String
  description String?
  metadata    Json?            // Additional structured data

  // Who performed the activity
  performedById String?        @db.ObjectId

  createdAt   DateTime         @default(now())

  // Relations
  lead        Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  performedBy StaffProfile?    @relation("LeadActivityPerformer", fields: [performedById], references: [id])

  @@index([clinicId])
  @@index([leadId])
  @@index([type])
  @@index([createdAt])
  @@map("lead_activities")
}

/// LeadTaskStatus - Status of lead tasks
enum LeadTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

/// LeadTaskPriority - Priority of lead tasks
enum LeadTaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

/// LeadTask - Tasks associated with leads
model LeadTask {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String           @db.ObjectId
  leadId      String           @db.ObjectId

  title       String
  description String?
  dueDate     DateTime?
  priority    LeadTaskPriority @default(MEDIUM)
  status      LeadTaskStatus   @default(PENDING)

  // Assignment
  assignedToId String?         @db.ObjectId
  completedAt  DateTime?
  completedById String?        @db.ObjectId

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  lead        Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedTo  StaffProfile?    @relation("LeadTaskAssignee", fields: [assignedToId], references: [id])
  completedBy StaffProfile?    @relation("LeadTaskCompleter", fields: [completedById], references: [id])

  @@index([clinicId])
  @@index([leadId])
  @@index([status])
  @@index([dueDate])
  @@index([assignedToId])
  @@map("lead_tasks")
}

// =============================================================================
// INTAKE FORMS - Digital form collection for patients and leads
// =============================================================================

/// FormType - Type of intake form
enum FormType {
  PATIENT_INFO
  MEDICAL_HISTORY
  DENTAL_HISTORY
  INSURANCE
  CONSENT_TREATMENT
  CONSENT_PRIVACY       // Generic privacy/info protection consent (HIPAA/PIPEDA/etc.)
  CONSENT_PHOTO
  CONSENT_FINANCIAL
  CUSTOM
}

/// FormCategory - Category of form
enum FormCategory {
  INTAKE
  CONSENT
  INSURANCE
  CLINICAL
}

/// FormTemplate - Reusable form definitions
model FormTemplate {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String?       @db.ObjectId  // null = global template

  name        String
  description String?
  type        FormType
  category    FormCategory

  // Form definition (JSON schema)
  schema      Json          // Form fields, validation, conditional logic

  isActive    Boolean       @default(true)
  isRequired  Boolean       @default(false)
  sortOrder   Int           @default(0)

  // Version tracking
  version     Int           @default(1)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdById String?       @db.ObjectId

  // Relations
  clinic      Clinic?       @relation(fields: [clinicId], references: [id])
  submissions FormSubmission[]

  @@index([clinicId])
  @@index([type])
  @@index([category])
  @@index([isActive])
  @@map("form_templates")
}

/// FormSubmissionStatus - Status of form submission
enum FormSubmissionStatus {
  PENDING     // Started but not completed
  COMPLETED   // Fully submitted
  REVIEWED    // Staff has reviewed
  ARCHIVED    // No longer active
}

/// FormSubmission - Submitted form data
model FormSubmission {
  id            String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId      String               @db.ObjectId

  templateId    String               @db.ObjectId
  leadId        String?              @db.ObjectId
  patientId     String?              @db.ObjectId

  // Submission data
  responses     Json                 // Form responses
  status        FormSubmissionStatus @default(PENDING)

  // Completion tracking
  startedAt     DateTime?
  completedAt   DateTime?
  submittedBy   String?              // Email or name of submitter

  // E-signature
  signatureData String?              // Base64 signature image
  signedAt      DateTime?
  signerName    String?
  signerRelation String?             // "Self", "Parent", "Guardian"

  // Review tracking
  reviewedAt    DateTime?
  reviewedById  String?              @db.ObjectId
  reviewNotes   String?

  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  // Relations
  clinic        Clinic               @relation(fields: [clinicId], references: [id])
  template      FormTemplate         @relation(fields: [templateId], references: [id])
  lead          Lead?                @relation(fields: [leadId], references: [id])
  patient       Patient?             @relation(fields: [patientId], references: [id])
  reviewedBy    StaffProfile?        @relation("FormReviewer", fields: [reviewedById], references: [id])

  @@index([clinicId])
  @@index([templateId])
  @@index([leadId])
  @@index([patientId])
  @@index([status])
  @@map("form_submissions")
}

// =============================================================================
// REFERRAL TRACKING - Manage referring provider relationships
// =============================================================================

/// ReferringProviderType - Type of referring provider (external dentists/specialists)
enum ReferringProviderType {
  GENERAL_DENTIST
  PEDIATRIC_DENTIST
  ORAL_SURGEON
  PERIODONTIST
  ENDODONTIST
  PROSTHODONTIST
  OTHER_SPECIALIST
  PHYSICIAN
  OTHER
}

/// ReferrerStatus - Status of referring provider relationship
enum ReferrerStatus {
  ACTIVE
  INACTIVE
  PREFERRED       // High-value referrer
}

/// ReferringProvider - Referring dentist/provider management
model ReferringProvider {
  id              String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String                @db.ObjectId

  // Provider Info
  type            ReferringProviderType @default(GENERAL_DENTIST)
  practiceName    String
  firstName       String
  lastName        String
  credentials     String?        // DDS, DMD, etc.

  // Contact
  email           String?
  phone           String?
  fax             String?
  website         String?

  // Address
  address         String?
  city            String?
  state           String?        // Province for Canada
  zipCode         String?        // Postal code for Canada

  // Relationship
  status          ReferrerStatus @default(ACTIVE)
  notes           String?

  // Stats (denormalized for quick access)
  totalReferrals    Int          @default(0)
  referralsThisYear Int          @default(0)
  lastReferralDate  DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  leads           Lead[]
  referralLetters ReferralLetter[]

  @@index([clinicId])
  @@index([status])
  @@index([type])
  @@index([practiceName])
  @@map("referring_providers")
}

/// ReferralLetterType - Types of communication with referring providers
enum ReferralLetterType {
  THANK_YOU_NEW_PATIENT
  THANK_YOU_CONSULTATION
  TREATMENT_STARTED
  PROGRESS_UPDATE
  TREATMENT_COMPLETE
  GENERAL_APPRECIATION
}

/// ReferralDeliveryMethod - How the referral letter was sent
enum ReferralDeliveryMethod {
  EMAIL
  FAX
  MAIL
  PORTAL
}

/// ReferralLetter - Letters/communications to referring providers
model ReferralLetter {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String                  @db.ObjectId

  providerId      String                  @db.ObjectId
  patientId       String?                 @db.ObjectId
  leadId          String?                 @db.ObjectId

  type            ReferralLetterType
  subject         String
  body            String

  // Delivery
  sentAt          DateTime?
  sentVia         ReferralDeliveryMethod?

  createdAt       DateTime           @default(now())
  createdById     String             @db.ObjectId

  // Relations
  clinic          Clinic             @relation(fields: [clinicId], references: [id])
  provider        ReferringProvider  @relation(fields: [providerId], references: [id])
  patient         Patient?           @relation(fields: [patientId], references: [id])
  createdBy       StaffProfile       @relation("ReferralLetterCreator", fields: [createdById], references: [id])

  @@index([clinicId])
  @@index([providerId])
  @@index([patientId])
  @@index([type])
  @@map("referral_letters")
}

// =============================================================================
// RECORDS REQUESTS - Coordinate incoming/outgoing patient records
// =============================================================================

/// RecordDirection - Direction of records transfer
enum RecordDirection {
  INCOMING   // Records we're requesting from another provider
  OUTGOING   // Records another provider is requesting from us
}

/// RecordType - Types of records being requested
enum RecordType {
  XRAYS
  PHOTOS
  TREATMENT_RECORDS
  MEDICAL_HISTORY
  BILLING_RECORDS
  ALL
}

/// RecordRequestStatus - Status of records request
enum RecordRequestStatus {
  PENDING
  SENT
  RECEIVED
  COMPLETED
  CANCELLED
}

/// RecordsRequest - Patient records transfer coordination
model RecordsRequest {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String              @db.ObjectId

  direction       RecordDirection     // INCOMING or OUTGOING
  patientId       String?             @db.ObjectId
  leadId          String?             @db.ObjectId

  // Provider Info (external provider)
  providerName    String
  providerPhone   String?
  providerFax     String?
  providerEmail   String?
  providerAddress String?

  // Request Details
  recordTypes     RecordType[]
  dateRange       String?             // "Last 5 years", "All records", etc.
  notes           String?

  // Status
  status          RecordRequestStatus @default(PENDING)

  // Dates
  requestedAt     DateTime            @default(now())
  sentAt          DateTime?
  receivedAt      DateTime?
  dueDate         DateTime?

  // Authorization
  authorizationSigned Boolean         @default(false)
  authorizationDate   DateTime?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  deletedAt       DateTime?           // Soft delete
  createdById     String              @db.ObjectId

  // Relations
  clinic          Clinic              @relation(fields: [clinicId], references: [id])
  patient         Patient?            @relation(fields: [patientId], references: [id])
  lead            Lead?               @relation(fields: [leadId], references: [id])
  createdByUser   StaffProfile        @relation("RecordsRequestCreator", fields: [createdById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([leadId])
  @@index([direction])
  @@index([status])
  @@index([dueDate])
  @@map("records_requests")
}

// =============================================================================
// INTAKE TOKENS - Secure tokens for public form access
// =============================================================================

/// IntakeToken - Token for public intake form access
model IntakeToken {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String    @db.ObjectId

  token       String    @unique // Secure random token

  // Link to lead or patient
  leadId      String?   @db.ObjectId
  patientId   String?   @db.ObjectId

  // Which form templates are allowed
  templateIds String[]  @db.ObjectId

  // Contact info for sending the link
  email       String?
  phone       String?

  // Expiration and usage
  expiresAt   DateTime?
  isUsed      Boolean   @default(false)
  usedAt      DateTime?

  createdAt   DateTime  @default(now())
  createdById String    @db.ObjectId

  // Relations
  clinic      Clinic    @relation(fields: [clinicId], references: [id])
  lead        Lead?     @relation(fields: [leadId], references: [id])
  patient     Patient?  @relation(fields: [patientId], references: [id])
  createdBy   StaffProfile @relation("IntakeTokenCreator", fields: [createdById], references: [id])

  @@index([clinicId])
  @@index([leadId])
  @@index([patientId])
  @@map("intake_tokens")
}

// =============================================================================
// IMAGING MANAGEMENT AREA - Patient images, protocols, organization
// =============================================================================

/// ImageCategory - Types of clinical images
enum ImageCategory {
  EXTRAORAL_PHOTO      // External photos (frontal, profile, smile)
  INTRAORAL_PHOTO      // Inside mouth photos
  PANORAMIC_XRAY       // Panoramic radiograph
  CEPHALOMETRIC_XRAY   // Ceph X-ray for analysis
  PERIAPICAL_XRAY      // Individual tooth X-rays
  CBCT                 // 3D cone beam CT
  SCAN_3D              // iTero, 3Shape scans
  OTHER
}

/// TagCategory - Types of image tags
enum TagCategory {
  CLINICAL      // crowding, spacing, crossbite
  TREATMENT     // braces, invisalign, retainer
  QUALITY       // blurry, good-lighting
  CUSTOM
}

/// AnnotationType - Types of image annotations
enum AnnotationType {
  FREEHAND
  LINE
  ARROW
  CIRCLE
  RECTANGLE
  TEXT
  POLYGON
}

/// PatientImage - Individual patient image record
model PatientImage {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String          @db.ObjectId
  patientId         String          @db.ObjectId

  // File Info
  fileName          String
  fileUrl           String          // Storage URL (local or S3)
  thumbnailUrl      String?         // Thumbnail version
  fileSize          Int             // bytes
  mimeType          String          // image/jpeg, image/png, etc.

  // Classification
  category          ImageCategory
  subcategory       String?         // e.g., "FRONTAL_SMILE", "UPPER_OCCLUSAL"

  // Metadata
  captureDate       DateTime?       // When image was taken
  capturedById      String?         @db.ObjectId // Who took it
  appointmentId     String?         @db.ObjectId // Associated appointment
  treatmentPlanId   String?         @db.ObjectId // Associated treatment plan
  treatmentPhaseId  String?         @db.ObjectId // Associated treatment phase

  // Protocol tracking
  protocolId        String?         @db.ObjectId
  protocolSlotId    String?         @db.ObjectId

  // Quality
  qualityScore      Int?            // 0-100, AI-assessed or manual

  // Visibility
  visibleToPatient  Boolean         @default(false)

  // Description
  description       String?
  notes             String?

  // Retention & Archival
  retentionPolicyId   String?         @db.ObjectId
  retentionExpiresAt  DateTime?       // When retention period ends
  isArchived          Boolean         @default(false)
  archivedAt          DateTime?
  archiveStorageKey   String?         // Cold storage location
  legalHold           Boolean         @default(false)
  legalHoldSetAt      DateTime?
  legalHoldSetById    String?         @db.ObjectId
  legalHoldReason     String?

  // Standard fields
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  createdById       String          @db.ObjectId
  deletedAt         DateTime?       // Soft delete

  // Relations
  clinic            Clinic          @relation(fields: [clinicId], references: [id])
  patient           Patient         @relation(fields: [patientId], references: [id])
  createdBy         StaffProfile    @relation("ImageCreator", fields: [createdById], references: [id])
  capturedBy        StaffProfile?   @relation("ImageCapturer", fields: [capturedById], references: [id])
  appointment       Appointment?    @relation(fields: [appointmentId], references: [id])
  treatmentPlan     TreatmentPlan?  @relation(fields: [treatmentPlanId], references: [id])
  treatmentPhase    TreatmentPhase? @relation(fields: [treatmentPhaseId], references: [id])
  protocol          PhotoProtocol?  @relation(fields: [protocolId], references: [id])
  protocolSlot      PhotoProtocolSlot? @relation(fields: [protocolSlotId], references: [id])
  retentionPolicy   ImageRetentionPolicy? @relation(fields: [retentionPolicyId], references: [id])
  legalHoldSetBy    StaffProfile?   @relation("ImageLegalHoldSetter", fields: [legalHoldSetById], references: [id])
  tags              ImageTagAssignment[]
  annotations       ImageAnnotation[]
  measurements      ImageMeasurement[]
  cephAnalyses      CephAnalysis[]
  archiveRecords    ImageArchiveRecord[]

  // Lab Work Management relations
  labOrderAttachments LabOrderAttachment[]

  @@index([clinicId])
  @@index([patientId])
  @@index([category])
  @@index([captureDate])
  @@index([appointmentId])
  @@index([treatmentPlanId])
  @@index([treatmentPhaseId])
  @@index([protocolId])
  @@index([retentionPolicyId])
  @@index([retentionExpiresAt])
  @@index([isArchived])
  @@index([legalHold])
  @@map("patient_images")
}

/// PhotoProtocol - Standard photo series template
model PhotoProtocol {
  id          String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String?               @db.ObjectId  // null = system default

  name        String                // "Initial Records", "Progress Check"
  description String?
  isActive    Boolean               @default(true)
  isDefault   Boolean               @default(false)

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  // Relations
  clinic      Clinic?               @relation(fields: [clinicId], references: [id])
  slots       PhotoProtocolSlot[]
  images      PatientImage[]

  @@index([clinicId])
  @@index([isActive])
  @@map("photo_protocols")
}

/// PhotoProtocolSlot - Individual slot in a photo protocol
model PhotoProtocolSlot {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  protocolId      String          @db.ObjectId

  name            String          // "Frontal Smile", "Right Lateral"
  category        ImageCategory
  subcategory     String?
  sortOrder       Int
  isRequired      Boolean         @default(true)

  // Guide for positioning
  guideImageUrl   String?
  instructions    String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  protocol        PhotoProtocol   @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  images          PatientImage[]

  @@index([protocolId])
  @@map("photo_protocol_slots")
}

/// ImageTag - Tags for categorizing images
model ImageTag {
  id          String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String?             @db.ObjectId  // null = system tag

  name        String
  color       String?             // Hex color for UI
  category    TagCategory         @default(CUSTOM)

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  clinic      Clinic?             @relation(fields: [clinicId], references: [id])
  assignments ImageTagAssignment[]

  @@unique([clinicId, name])
  @@index([clinicId])
  @@index([category])
  @@map("image_tags")
}

/// ImageTagAssignment - Links tags to images
model ImageTagAssignment {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  imageId   String       @db.ObjectId
  tagId     String       @db.ObjectId

  createdAt DateTime     @default(now())

  // Relations
  image     PatientImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  tag       ImageTag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([imageId, tagId])
  @@index([imageId])
  @@index([tagId])
  @@map("image_tag_assignments")
}

/// ImageAnnotation - Annotations drawn on images
model ImageAnnotation {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  imageId     String          @db.ObjectId

  type        AnnotationType
  geometry    Json            // Coordinates, dimensions, points
  style       Json?           // Color, stroke width, fill
  text        String?         // For text annotations
  label       String?         // Annotation label/name

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdById String          @db.ObjectId

  // Relations
  image       PatientImage    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  createdBy   StaffProfile    @relation("AnnotationCreator", fields: [createdById], references: [id])

  @@index([imageId])
  @@map("image_annotations")
}

/// MeasurementType - Types of measurements that can be made on images
enum MeasurementType {
  LINEAR      // Distance between 2 points
  ANGLE       // Angle between 3 points
  AREA        // Polygon area
  PERIMETER   // Polygon perimeter
}

/// ImageMeasurement - Measurements made on patient images
/// Used for tracking linear distances, angles, and areas on clinical images
model ImageMeasurement {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String          @db.ObjectId
  imageId     String          @db.ObjectId

  type        MeasurementType
  points      Json            // Array of {x, y} coordinates
  value       Float           // Calculated measurement value
  unit        String          // mm, degrees, mm, px

  label       String?         // User-defined label for the measurement
  calibration Float?          // pixels per mm (for calibrated measurements)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdById String          @db.ObjectId

  // Relations
  image       PatientImage    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  createdBy   StaffProfile    @relation("MeasurementCreator", fields: [createdById], references: [id])
  clinic      Clinic          @relation(fields: [clinicId], references: [id])

  @@index([imageId])
  @@index([clinicId])
  @@map("image_measurements")
}

/// CollageTemplate - Predefined layouts for image collages
/// Used for creating standardized patient progress presentations
model CollageTemplate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String?  @db.ObjectId // null = system template

  name        String
  description String?
  category    String   // PROGRESS, COMPARISON, TREATMENT, PRESENTATION

  // Layout configuration
  layout      Json     // Grid definition: rows, cols, slot positions
  slots       Json     // Array of slot definitions with position, size, label
  aspectRatio String   @default("16:9") // 16:9, 4:3, 1:1, A4, LETTER

  // Styling
  background  String   @default("#ffffff")
  padding     Int      @default(16)
  gap         Int      @default(8)

  // Template metadata
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)
  thumbnail   String?  // Preview image URL

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?  @db.ObjectId

  // Relations
  clinic      Clinic?       @relation(fields: [clinicId], references: [id])
  createdBy   StaffProfile? @relation("CollageTemplateCreator", fields: [createdById], references: [id])
  collages    ImageCollage[]

  @@index([clinicId])
  @@index([category])
  @@map("collage_templates")
}

/// ImageCollage - A saved collage created from a template
/// Stores patient image arrangements for presentations and reports
model ImageCollage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String   @db.ObjectId
  patientId   String   @db.ObjectId
  templateId  String   @db.ObjectId

  title       String
  description String?

  // Slot assignments: maps slot IDs to image IDs
  slotAssignments Json   // { slotId: imageId, ... }

  // Optional customizations
  customizations  Json?  // Overrides for individual slots (labels, borders, etc)
  annotations     Json?  // Text overlays, arrows, highlights

  // Export tracking
  lastExportedAt  DateTime?
  exportFormat    String?    // PDF, PNG, JPG
  exportUrl       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @db.ObjectId

  // Relations
  clinic      Clinic          @relation(fields: [clinicId], references: [id])
  patient     Patient         @relation(fields: [patientId], references: [id])
  template    CollageTemplate @relation(fields: [templateId], references: [id])
  createdBy   StaffProfile    @relation("CollageCreator", fields: [createdById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([templateId])
  @@map("image_collages")
}

/// ProgressReport - Patient treatment progress documentation
/// Combines multiple collages and notes into a comprehensive report
model ProgressReport {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String   @db.ObjectId
  patientId   String   @db.ObjectId

  title       String
  reportType  String   // INITIAL, PROGRESS, FINAL, COMPARISON
  reportDate  DateTime @default(now())

  // Report content
  sections    Json     // Array of sections: { type, content, collageId?, imageIds? }
  summary     String?  // Executive summary
  notes       String?  // Clinical notes

  // Metadata
  treatmentPlanId String?  @db.ObjectId
  appointmentId   String?  @db.ObjectId

  // Export
  exportedAt  DateTime?
  exportUrl   String?

  // Visibility
  visibleToPatient Boolean @default(false)
  sharedAt         DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @db.ObjectId

  // Relations
  clinic        Clinic          @relation(fields: [clinicId], references: [id])
  patient       Patient         @relation(fields: [patientId], references: [id])
  treatmentPlan TreatmentPlan?  @relation(fields: [treatmentPlanId], references: [id])
  appointment   Appointment?    @relation(fields: [appointmentId], references: [id])
  createdBy     StaffProfile    @relation("ReportCreator", fields: [createdById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([reportDate])
  @@map("progress_reports")
}

/// CephAnalysis - Cephalometric analysis for lateral skull X-rays
/// Used for orthodontic diagnosis and treatment planning
model CephAnalysis {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String   @db.ObjectId
  patientId   String   @db.ObjectId
  imageId     String   @db.ObjectId

  // Analysis type
  presetId    String   // STEINER, DOWNS, TWEED, RICKETTS, QUICK, or custom

  // Landmark data
  landmarks   Json     // Array of { landmarkId, x, y, confidence?, isAutoPlaced? }

  // Calculated measurements
  measurements Json    // Array of { measurementId, value, deviation, interpretation }

  // Calibration
  calibration Float?   // Pixels per mm (for calibrated measurements)

  // Notes
  notes       String?
  summary     String?  // AI-generated or manual summary

  // Metadata
  analysisDate DateTime @default(now())
  isComplete   Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @db.ObjectId

  // Relations
  clinic      Clinic       @relation(fields: [clinicId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  image       PatientImage @relation(fields: [imageId], references: [id])
  createdBy   StaffProfile @relation("CephAnalysisCreator", fields: [createdById], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([imageId])
  @@index([analysisDate])
  @@map("ceph_analyses")
}

/// ImageRetentionPolicy - Configurable retention rules for images
model ImageRetentionPolicy {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String          @db.ObjectId

  name              String          // "Standard Clinical Images", "X-Ray Retention"
  description       String?
  isDefault         Boolean         @default(false)
  isActive          Boolean         @default(true)

  // Which images this applies to
  imageCategories   ImageCategory[] // Empty = all categories

  // Retention periods
  retentionYears    Int             // Years to retain from capture/creation
  retentionForMinorsYears Int?      // Additional years for minors (age 21 + X)
  archiveAfterYears Int?            // When to move to cold storage (null = never)

  // Settings
  notifyBeforeArchive Int?          // Days before archival to notify (null = no notification)
  autoExtendOnAccess  Boolean       @default(false) // Extend retention when accessed

  // Audit
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  createdById       String          @db.ObjectId

  // Relations
  clinic            Clinic          @relation(fields: [clinicId], references: [id])
  createdBy         StaffProfile    @relation("RetentionPolicyCreator", fields: [createdById], references: [id])
  images            PatientImage[]
  archiveRecords    ImageArchiveRecord[]

  @@unique([clinicId, name])
  @@index([clinicId])
  @@index([isDefault])
  @@map("image_retention_policies")
}

/// ImageArchiveRecord - Tracks archival, restoration, and deletion events
model ImageArchiveRecord {
  id                  String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String          @db.ObjectId
  imageId             String          @db.ObjectId

  action              ImageArchiveAction
  reason              String?         // Why this action was taken
  policyId            String?         @db.ObjectId  // Which policy triggered this

  // Storage locations
  originalStorageKey  String          // Where it was stored before
  archiveStorageKey   String?         // Where it was archived to (for ARCHIVED action)

  // Checksum for integrity
  fileChecksum        String?         // SHA256 of file for verification

  // Timestamps
  actionAt            DateTime        @default(now())
  expiresAt           DateTime?       // When permanent deletion is allowed
  restoredAt          DateTime?       // When restored from archive

  // Audit
  performedById       String          @db.ObjectId
  metadata            Json?           // Additional context

  // Relations
  clinic              Clinic          @relation(fields: [clinicId], references: [id])
  image               PatientImage    @relation(fields: [imageId], references: [id])
  policy              ImageRetentionPolicy? @relation(fields: [policyId], references: [id])
  performedBy         StaffProfile    @relation("ArchiveRecordPerformer", fields: [performedById], references: [id])

  @@index([clinicId])
  @@index([imageId])
  @@index([action])
  @@index([actionAt])
  @@index([expiresAt])
  @@map("image_archive_records")
}

enum ImageArchiveAction {
  ARCHIVED            // Moved to cold storage
  RESTORED            // Restored from cold storage
  DELETED             // Permanently deleted
  LEGAL_HOLD_SET      // Legal hold applied
  LEGAL_HOLD_REMOVED  // Legal hold removed
  RETENTION_EXTENDED  // Retention period extended
}

// =============================================================================
// TREATMENT TRACKING - Progress monitoring, debond, retention, outcomes
// =============================================================================

/// ProgressStatus - Overall treatment progress status
enum ProgressStatus {
  ON_TRACK                // Treatment progressing as expected
  AHEAD                   // Ahead of schedule
  BEHIND                  // Behind schedule
  SIGNIFICANTLY_BEHIND    // Significantly behind schedule
  PAUSED                  // Treatment temporarily paused
}

/// RetentionPhase - Phases of retention protocol
enum RetentionPhase {
  INITIAL       // Full-time wear immediately post-treatment
  TRANSITION    // Transitioning to reduced wear
  MAINTENANCE   // Regular maintenance phase
  LONG_TERM     // Long-term/indefinite retention
}

/// PatientComplianceLevel - Patient compliance rating for treatment/retention
enum PatientComplianceLevel {
  EXCELLENT       // Fully compliant
  GOOD            // Mostly compliant
  FAIR            // Partial compliance
  POOR            // Low compliance
  NON_COMPLIANT   // Not following instructions
}

/// RetainerCondition - Condition of retainer
enum RetainerCondition {
  GOOD              // In good condition
  WORN              // Shows wear but functional
  DAMAGED           // Has damage
  LOST              // Retainer lost
  NEEDS_REPLACEMENT // Needs to be replaced
}

/// StabilityStatus - Post-treatment stability
enum StabilityStatus {
  STABLE              // Teeth stable
  MINOR_RELAPSE       // Minor movement detected
  SIGNIFICANT_RELAPSE // Significant movement
  REQUIRES_TREATMENT  // Needs re-treatment
}

/// OutcomeRating - Overall treatment outcome rating
enum OutcomeRating {
  EXCELLENT     // Exceptional results
  GOOD          // Good results
  SATISFACTORY  // Acceptable results
  FAIR          // Below expected
  POOR          // Unsatisfactory
  INCOMPLETE    // Treatment not completed
}

/// TreatmentProgress - Snapshot of treatment progress at a point in time
model TreatmentProgress {
  id                  String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String              @db.ObjectId
  treatmentPlanId     String              @db.ObjectId
  patientId           String              @db.ObjectId

  // Progress metrics
  snapshotDate        DateTime            @default(now())
  status              ProgressStatus      @default(ON_TRACK)
  percentComplete     Float               // 0-100 percentage complete
  currentPhase        String?             // Current phase name
  currentPhaseNumber  Int?                // Phase number (1, 2, 3...)

  // Visit tracking
  completedVisits     Int                 @default(0)
  expectedVisits      Int?                // Expected visits by this point
  totalPlannedVisits  Int?                // Total planned visits
  missedAppointments  Int                 @default(0)

  // Duration tracking
  daysInTreatment     Int?                // Days since start
  expectedDays        Int?                // Expected days by this point
  estimatedDaysRemaining Int?             // Estimated days to completion

  // Milestone tracking
  milestonesAchieved  Int                 @default(0)
  totalMilestones     Int?
  nextMilestone       String?             // Name of next milestone
  nextMilestoneDate   DateTime?           // Target date for next milestone

  // Compliance
  complianceScore     Float?              // 0-100 compliance score
  complianceNotes     String?

  // Clinical notes
  clinicalProgress    String?             // Clinical progress notes
  concerns            String[]            // Any concerns noted
  recommendations     String[]            // Provider recommendations

  // Comparison to expected
  daysAhead           Int?                // Positive = ahead, negative = behind
  varianceReason      String?             // Explanation for variance

  // Provider
  assessedById        String              @db.ObjectId

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  clinic              Clinic              @relation(fields: [clinicId], references: [id])
  treatmentPlan       TreatmentPlan       @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  patient             Patient             @relation(fields: [patientId], references: [id])
  assessedBy          StaffProfile        @relation("TreatmentProgressAssessor", fields: [assessedById], references: [id])

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([patientId])
  @@index([snapshotDate])
  @@index([status])
  @@map("treatment_progress")
}

/// DebondReadiness - Assessment for debond eligibility
model DebondReadiness {
  id                    String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String            @db.ObjectId
  treatmentPlanId       String            @db.ObjectId
  patientId             String            @db.ObjectId

  // Assessment date
  assessmentDate        DateTime          @default(now())

  // Readiness criteria checklist
  alignmentComplete     Boolean           @default(false)
  spaceClosure          Boolean           @default(false)
  overbiteCorrection    Boolean           @default(false)
  overjetCorrection     Boolean           @default(false)
  midlineAlignment      Boolean           @default(false)
  occlusionSatisfactory Boolean           @default(false)
  patientSatisfied      Boolean           @default(false)
  rootParallelism       Boolean           @default(false)
  marginalRidges        Boolean           @default(false)
  interproximalContacts Boolean           @default(false)

  // Additional criteria (custom)
  additionalCriteria    Json?             // Array of custom criteria with status

  // Overall assessment
  isReady               Boolean           @default(false)
  readinessScore        Float?            // Percentage of criteria met
  notReadyReasons       String[]          // Why not ready

  // Provider notes
  clinicalNotes         String?
  recommendations       String[]

  // Approval workflow
  assessedById          String            @db.ObjectId
  approvedById          String?           @db.ObjectId
  approvedDate          DateTime?
  approvalNotes         String?

  // Scheduled debond
  scheduledDebondDate   DateTime?
  debondCompleted       Boolean           @default(false)
  debondCompletedDate   DateTime?

  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  clinic                Clinic            @relation(fields: [clinicId], references: [id])
  treatmentPlan         TreatmentPlan     @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  patient               Patient           @relation(fields: [patientId], references: [id])
  assessedBy            StaffProfile      @relation("DebondReadinessAssessor", fields: [assessedById], references: [id])
  approvedBy            StaffProfile?     @relation("DebondReadinessApprover", fields: [approvedById], references: [id])

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([patientId])
  @@index([isReady])
  @@index([scheduledDebondDate])
  @@map("debond_readiness")
}

/// RetentionProtocol - Post-treatment retention management
model RetentionProtocol {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId
  treatmentPlanId       String                @db.ObjectId
  patientId             String                @db.ObjectId

  // Protocol start
  startDate             DateTime              @default(now())
  debondDate            DateTime?             // Date braces removed

  // Current phase
  currentPhase          RetentionPhase        @default(INITIAL)
  phaseStartDate        DateTime              @default(now())

  // Wear schedule
  wearSchedule          RetentionWearSchedule @default(FULL_TIME)
  wearHoursPerDay       Int?                  // Specific hours if applicable
  wearInstructions      String?               // Specific instructions

  // Retainer information
  upperRetainerType     String?               // "Hawley", "Essix", "Fixed"
  lowerRetainerType     String?
  upperRetainerId       String?               @db.ObjectId // Link to RetainerRecord
  lowerRetainerId       String?               @db.ObjectId

  // Compliance tracking
  complianceStatus      PatientComplianceLevel @default(EXCELLENT)
  lastComplianceUpdate  DateTime?

  // Check schedule
  checkIntervalMonths   Int                   @default(6)  // Months between checks
  nextCheckDate         DateTime?
  totalChecks           Int                   @default(0)

  // Stability
  stabilityStatus       StabilityStatus       @default(STABLE)
  lastStabilityAssessment DateTime?
  stabilityNotes        String?

  // Protocol adjustments
  adjustmentHistory     Json?                 // Array of adjustments made
  currentNotes          String?

  // Provider
  managingProviderId    String                @db.ObjectId

  // Protocol status
  isActive              Boolean               @default(true)
  endDate               DateTime?
  endReason             String?

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  treatmentPlan         TreatmentPlan         @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  patient               Patient               @relation(fields: [patientId], references: [id])
  managingProvider      StaffProfile          @relation("RetentionProtocolProvider", fields: [managingProviderId], references: [id])
  retentionChecks       RetentionCheck[]

  @@index([clinicId])
  @@index([treatmentPlanId])
  @@index([patientId])
  @@index([currentPhase])
  @@index([nextCheckDate])
  @@index([isActive])
  @@map("retention_protocols")
}

/// RetentionCheck - Individual retention check visit record
model RetentionCheck {
  id                    String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String                @db.ObjectId
  retentionProtocolId   String                @db.ObjectId
  patientId             String                @db.ObjectId

  // Check details
  checkDate             DateTime              @default(now())
  checkNumber           Int                   // 1, 2, 3, etc.

  // Assessment
  wearScheduleFollowed  Boolean?
  reportedWearHours     Int?                  // Patient-reported hours
  complianceStatus      PatientComplianceLevel?

  // Retainer condition
  upperRetainerCondition RetainerCondition?
  lowerRetainerCondition RetainerCondition?
  retainerFit           String?               // "Good", "Tight", "Loose"

  // Stability assessment
  stabilityStatus       StabilityStatus?
  movementObserved      String[]              // Any tooth movement noted
  measurementsJson      Json?                 // Clinical measurements

  // Actions taken
  adjustmentsMade       String[]
  retainerReplaced      Boolean               @default(false)
  newRetainerOrdered    Boolean               @default(false)

  // Provider notes
  clinicalFindings      String?
  patientConcerns       String?
  instructions          String?
  recommendations       String[]

  // Next steps
  phaseAdvanced         Boolean               @default(false)
  newPhase              RetentionPhase?
  newWearSchedule       RetentionWearSchedule?
  nextCheckDate         DateTime?

  // Provider
  performedById         String                @db.ObjectId

  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  clinic                Clinic                @relation(fields: [clinicId], references: [id])
  retentionProtocol     RetentionProtocol     @relation(fields: [retentionProtocolId], references: [id], onDelete: Cascade)
  patient               Patient               @relation(fields: [patientId], references: [id])
  performedBy           StaffProfile          @relation("RetentionCheckPerformer", fields: [performedById], references: [id])

  @@index([clinicId])
  @@index([retentionProtocolId])
  @@index([patientId])
  @@index([checkDate])
  @@map("retention_checks")
}

/// TreatmentOutcome - Final treatment outcome assessment
model TreatmentOutcome {
  id                    String              @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String              @db.ObjectId
  treatmentPlanId       String              @db.ObjectId
  patientId             String              @db.ObjectId

  // Assessment date
  assessmentDate        DateTime            @default(now())

  // Treatment summary
  treatmentStartDate    DateTime?
  treatmentEndDate      DateTime?
  totalDurationMonths   Int?
  totalVisits           Int?

  // Overall outcome
  overallRating         OutcomeRating       @default(GOOD)
  objectivesAchieved    String[]            // List of achieved objectives
  objectivesPartial     String[]            // Partially achieved
  objectivesNotMet      String[]            // Not achieved

  // Clinical outcomes
  alignmentScore        Float?              // 0-100
  occlusionScore        Float?              // 0-100
  aestheticScore        Float?              // 0-100
  functionalScore       Float?              // 0-100

  // Measurements comparison
  initialMeasurements   Json?               // Initial clinical measurements
  finalMeasurements     Json?               // Final clinical measurements

  // Patient satisfaction
  patientSatisfactionScore Int?             // 1-10
  patientFeedback       String?
  wouldRecommend        Boolean?

  // Provider assessment
  clinicalNotes         String?
  treatmentChallenges   String[]            // Challenges encountered
  lessonsLearned        String?
  wouldDoAnythingDifferent String?

  // Follow-up
  followUpRecommendations String[]
  retentionProtocolId   String?             @db.ObjectId // Link to retention

  // Photos
  beforePhotoIds        String[]            @db.ObjectId
  afterPhotoIds         String[]            @db.ObjectId

  // Provider
  assessedById          String              @db.ObjectId

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  clinic                Clinic              @relation(fields: [clinicId], references: [id])
  treatmentPlan         TreatmentPlan       @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  patient               Patient             @relation(fields: [patientId], references: [id])
  assessedBy            StaffProfile        @relation("TreatmentOutcomeAssessor", fields: [assessedById], references: [id])

  @@unique([treatmentPlanId]) // One outcome per plan
  @@index([clinicId])
  @@index([patientId])
  @@index([overallRating])
  @@index([assessmentDate])
  @@map("treatment_outcomes")
}

// =============================================================================
// LAB WORK MANAGEMENT AREA - Lab orders, vendors, tracking, and quality
// =============================================================================

// -----------------------------------------------------------------------------
// Lab Vendor Management Models
// -----------------------------------------------------------------------------

/// LabVendor - External dental laboratory company
model LabVendor {
  id                    String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId              String          @db.ObjectId
  name                  String
  code                  String          // Short code (e.g., "OSL")
  legalName             String?
  taxId                 String?
  website               String?
  accountNumber         String?
  status                LabVendorStatus @default(ACTIVE)

  // Contact info (embedded)
  address               Json?           // {street, city, state, zip, country}
  primaryPhone          String?
  primaryEmail          String?

  // Integration
  portalUrl             String?
  apiEndpoint           String?
  credentials           String?         // Encrypted

  // Capabilities
  capabilities          String[]        // Product categories they support
  specialties           String[]

  // Shipping
  defaultCarrier        ShippingCarrier?
  shippingAccountNumber String?

  // Billing
  paymentTerms          Int?            @default(30) // Days
  billingEmail          String?

  // Audit
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  deletedAt             DateTime?
  createdBy             String?         @db.ObjectId
  updatedBy             String?         @db.ObjectId

  // Relations
  clinic                Clinic          @relation(fields: [clinicId], references: [id])
  contacts              LabVendorContact[]
  products              LabProduct[]
  feeSchedules          LabFeeSchedule[]
  contracts             LabContract[]
  orders                LabOrder[]
  metrics               LabVendorMetrics[]
  messages              LabMessage[]
  preferenceRules       LabPreferenceRule[]
  integrations          LabIntegration[]

  @@unique([clinicId, code])
  @@index([clinicId])
  @@index([status])
  @@map("lab_vendors")
}

/// LabVendorContact - Contact person at a lab vendor
model LabVendorContact {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  vendorId  String         @db.ObjectId
  name      String
  title     String?
  phone     String?
  email     String?
  role      LabContactRole @default(PRIMARY)
  isPrimary Boolean        @default(false)
  notes     String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  vendor    LabVendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@map("lab_vendor_contacts")
}

/// LabProduct - Product in the lab catalog
model LabProduct {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  clinicId           String             @db.ObjectId
  vendorId           String?            @db.ObjectId  // Null = clinic-wide product
  name               String
  description        String?
  sku                String?
  category           LabProductCategory

  // Prescription schema (JSON schema for Rx fields)
  prescriptionSchema Json?

  // Turnaround
  standardTurnaround Int                @default(7)  // Days
  rushTurnaround     Int?               // Days for rush

  // Status
  isActive           Boolean            @default(true)

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  deletedAt          DateTime?

  // Relations
  clinic             Clinic             @relation(fields: [clinicId], references: [id])
  vendor             LabVendor?         @relation(fields: [vendorId], references: [id])
  feeSchedules       LabFeeSchedule[]
  orderItems         LabOrderItem[]

  @@index([clinicId])
  @@index([vendorId])
  @@index([category])
  @@index([isActive])
  @@map("lab_products")
}

/// LabFeeSchedule - Pricing for lab products by vendor
model LabFeeSchedule {
  id                  String     @id @default(auto()) @map("_id") @db.ObjectId
  clinicId            String     @db.ObjectId
  vendorId            String     @db.ObjectId
  productId           String     @db.ObjectId

  basePrice           Float
  rushUpchargePercent Float?     @default(50)
  rushUpchargeFlat    Float?

  effectiveDate       DateTime
  endDate             DateTime?

  // Volume discounts (JSON array)
  volumeDiscounts     Json?

  isActive            Boolean    @default(true)

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  clinic              Clinic     @relation(fields: [clinicId], references: [id])
  vendor              LabVendor  @relation(fields: [vendorId], references: [id])
  product             LabProduct @relation(fields: [productId], references: [id])

  @@index([clinicId])
  @@index([vendorId])
  @@index([productId])
  @@index([isActive])
  @@map("lab_fee_schedules")
}

/// LabContract - Contract agreement with a lab vendor
model LabContract {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String            @db.ObjectId
  vendorId          String            @db.ObjectId

  contractNumber    String?
  name              String
  status            LabContractStatus @default(ACTIVE)

  startDate         DateTime
  endDate           DateTime?
  autoRenew         Boolean           @default(false)
  renewalNoticeDays Int?              @default(30)

  // Terms
  discountPercent   Float?
  minimumVolume     Int?
  slaTerms          String?
  notes             String?

  // Document
  documentUrl       String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?

  // Relations
  clinic            Clinic            @relation(fields: [clinicId], references: [id])
  vendor            LabVendor         @relation(fields: [vendorId], references: [id])

  @@index([clinicId])
  @@index([vendorId])
  @@index([status])
  @@map("lab_contracts")
}

/// LabPreferenceRule - Rule for automatic lab selection
model LabPreferenceRule {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String    @db.ObjectId
  vendorId    String    @db.ObjectId

  name        String
  description String?
  priority    Int       @default(0)  // Lower = higher priority
  isActive    Boolean   @default(true)

  // Rule conditions (JSON)
  conditions  Json      // {productCategory?, productId?, isRush?, etc.}

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  clinic      Clinic    @relation(fields: [clinicId], references: [id])
  vendor      LabVendor @relation(fields: [vendorId], references: [id])

  @@index([clinicId])
  @@index([vendorId])
  @@index([priority])
  @@map("lab_preference_rules")
}

/// LabVendorMetrics - Aggregated vendor performance metrics
model LabVendorMetrics {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String           @db.ObjectId
  vendorId          String           @db.ObjectId

  periodType        MetricPeriodType // DAILY, WEEKLY, MONTHLY, YEARLY
  periodStart       DateTime
  periodEnd         DateTime

  // Volume
  orderCount        Int              @default(0)
  itemCount         Int              @default(0)
  totalSpend        Float            @default(0)

  // Performance
  avgTurnaroundDays Float?
  onTimeRate        Float?           // Percentage
  remakeRate        Float?           // Percentage
  qualityScore      Float?           // 0-100

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  clinic            Clinic           @relation(fields: [clinicId], references: [id])
  vendor            LabVendor        @relation(fields: [vendorId], references: [id])

  @@unique([vendorId, periodType, periodStart])
  @@index([clinicId])
  @@index([vendorId])
  @@map("lab_vendor_metrics")
}

/// LabMessage - Communication with lab vendors
model LabMessage {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId    String           @db.ObjectId
  vendorId    String           @db.ObjectId
  orderId     String?          @db.ObjectId

  threadId    String?          @db.ObjectId  // For threading
  direction   MessageDirection // OUTBOUND, INBOUND

  subject     String?
  content     String

  sentAt      DateTime?
  readAt      DateTime?

  sentBy      String?          @db.ObjectId

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  clinic      Clinic           @relation(fields: [clinicId], references: [id])
  vendor      LabVendor        @relation(fields: [vendorId], references: [id])
  order       LabOrder?        @relation(fields: [orderId], references: [id])

  @@index([clinicId])
  @@index([vendorId])
  @@index([orderId])
  @@index([threadId])
  @@map("lab_messages")
}

// -----------------------------------------------------------------------------
// Lab Vendor Management Enums
// -----------------------------------------------------------------------------

enum LabVendorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum LabContactRole {
  PRIMARY
  BILLING
  TECHNICAL
  SHIPPING
  EMERGENCY
}

enum LabProductCategory {
  RETAINER
  APPLIANCE
  ALIGNER
  INDIRECT_BONDING
  ARCHWIRE
  MODEL
  SURGICAL
  OTHER
}

enum LabContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

enum MetricPeriodType {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// Note: MessageDirection enum already exists in schema (line 5979)

enum ShippingCarrier {
  FEDEX
  UPS
  USPS
  DHL
  LAB_COURIER
  OTHER
}

// -----------------------------------------------------------------------------
// Lab Orders Models
// -----------------------------------------------------------------------------

/// LabOrder - Lab order header
model LabOrder {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String          @db.ObjectId
  patientId         String          @db.ObjectId
  vendorId          String?         @db.ObjectId

  orderNumber       String          // Clinic-generated (e.g., "LAB-2024-0001")
  externalOrderId   String?         // From lab system

  status            LabOrderStatus  @default(DRAFT)
  priority          OrderPriority   @default(STANDARD)

  // Rush handling
  isRush            Boolean         @default(false)
  rushLevel         RushLevel?
  rushReason        String?

  // Dates
  orderDate         DateTime        @default(now())
  submittedAt       DateTime?
  neededByDate      DateTime?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?

  // Treatment links
  treatmentPlanId   String?         @db.ObjectId
  milestoneId       String?         @db.ObjectId
  appointmentId     String?         @db.ObjectId

  // Financial
  subtotal          Float           @default(0)
  rushUpcharge      Float           @default(0)
  shippingCost      Float           @default(0)
  totalCost         Float           @default(0)

  // Notes
  clinicNotes       String?
  labNotes          String?

  // Audit
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  deletedAt         DateTime?
  createdBy         String?         @db.ObjectId
  updatedBy         String?         @db.ObjectId

  // Relations
  clinic            Clinic          @relation(fields: [clinicId], references: [id])
  patient           Patient         @relation(fields: [patientId], references: [id])
  vendor            LabVendor?      @relation(fields: [vendorId], references: [id])
  treatmentPlan     TreatmentPlan?  @relation(fields: [treatmentPlanId], references: [id])
  items             LabOrderItem[]
  attachments       LabOrderAttachment[]
  statusLogs        LabOrderStatusLog[]
  shipments         LabShipment[]
  messages          LabMessage[]
  inspections       LabInspection[]
  pickupItems       PatientPickupItem[]

  @@unique([clinicId, orderNumber])
  @@index([clinicId])
  @@index([patientId])
  @@index([vendorId])
  @@index([status])
  @@index([orderDate])
  @@index([neededByDate])
  @@map("lab_orders")
}

/// LabOrderItem - Individual item on a lab order
model LabOrderItem {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String              @db.ObjectId
  productId       String              @db.ObjectId

  productName     String              // Denormalized
  quantity        Int                 @default(1)

  // Prescription details (JSON)
  prescription    Json?

  // Arch/tooth specification
  arch            Arch?
  toothNumbers    Int[]

  // Pricing
  unitPrice       Float
  totalPrice      Float

  // Item status
  status          LabOrderItemStatus  @default(PENDING)

  // Notes
  notes           String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  order           LabOrder            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         LabProduct          @relation(fields: [productId], references: [id])
  inspections     LabInspection[]
  warranties      LabWarranty[]
  remakeRequests  RemakeRequest[]

  @@index([orderId])
  @@index([productId])
  @@index([status])
  @@map("lab_order_items")
}

/// LabOrderAttachment - File attached to a lab order
model LabOrderAttachment {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String           @db.ObjectId

  fileName        String
  fileType        LabAttachmentType
  mimeType        String
  fileSize        Int              // Bytes
  storageKey      String           // Cloud storage key

  // Source tracking
  source          AttachmentSource @default(MANUAL_UPLOAD)
  patientImageId  String?          @db.ObjectId  // If from imaging

  description     String?

  createdAt       DateTime         @default(now())
  uploadedBy      String?          @db.ObjectId

  // Relations
  order           LabOrder         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  patientImage    PatientImage?    @relation(fields: [patientImageId], references: [id])

  @@index([orderId])
  @@index([patientImageId])
  @@map("lab_order_attachments")
}

/// LabOrderTemplate - Reusable order template
model LabOrderTemplate {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String   @db.ObjectId

  name            String
  description     String?

  // Scope
  isClinicWide    Boolean  @default(false)
  createdByUserId String?  @db.ObjectId

  // Template content
  vendorId        String?  @db.ObjectId
  items           Json     // Array of item templates
  defaultNotes    String?

  usageCount      Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  clinic          Clinic   @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([isClinicWide])
  @@map("lab_order_templates")
}

/// LabOrderStatusLog - Status change history for orders
model LabOrderStatusLog {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String             @db.ObjectId

  fromStatus      LabOrderStatus?
  toStatus        LabOrderStatus

  source          StatusChangeSource @default(USER)
  notes           String?

  createdAt       DateTime           @default(now())
  changedBy       String?            @db.ObjectId

  // Relations
  order           LabOrder           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("lab_order_status_logs")
}

// -----------------------------------------------------------------------------
// Lab Orders Enums
// -----------------------------------------------------------------------------

enum LabOrderStatus {
  DRAFT
  SUBMITTED
  ACKNOWLEDGED
  IN_PROGRESS
  COMPLETED
  SHIPPED
  DELIVERED
  RECEIVED
  PATIENT_PICKUP
  PICKED_UP
  CANCELLED
  REMAKE_REQUESTED
  ON_HOLD
}

enum OrderPriority {
  LOW
  STANDARD
  HIGH
  URGENT
}

enum RushLevel {
  EMERGENCY    // Same day / next day
  RUSH         // 2-3 days
  PRIORITY     // 4-5 days
}

// Note: Arch enum already exists in schema (line 7355)

enum LabOrderItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SHIPPED
  DELIVERED
  INSPECTED
  ACCEPTED
  REJECTED
}

enum LabAttachmentType {
  STL_SCAN
  PHOTO
  XRAY
  DOCUMENT
  OTHER
}

enum AttachmentSource {
  MANUAL_UPLOAD
  ITERO_SYNC
  THREESHAPE_IMPORT
  IMAGING_SYSTEM
}

enum StatusChangeSource {
  USER
  LAB
  SYSTEM
  SHIPPING
}

// -----------------------------------------------------------------------------
// Order Tracking Models
// -----------------------------------------------------------------------------

/// LabShipment - Shipment tracking for lab orders
model LabShipment {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  orderId           String          @db.ObjectId

  carrier           ShippingCarrier
  trackingNumber    String?
  trackingUrl       String?

  status            ShipmentStatus  @default(PENDING)

  shippedAt         DateTime?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?

  // Delivery details
  deliveredTo       String?
  signatureUrl      String?

  // Package info
  packageCount      Int             @default(1)
  weight            Float?
  dimensions        String?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  order             LabOrder        @relation(fields: [orderId], references: [id])
  events            ShipmentEvent[]

  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
  @@map("lab_shipments")
}

/// ShipmentEvent - Individual tracking event for a shipment
model ShipmentEvent {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  shipmentId      String              @db.ObjectId

  status          String
  description     String?
  location        String?
  timestamp       DateTime

  source          ShipmentEventSource @default(CARRIER_API)

  createdAt       DateTime            @default(now())

  // Relations
  shipment        LabShipment         @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([timestamp])
  @@map("shipment_events")
}

/// PatientPickupItem - Items awaiting patient pickup
model PatientPickupItem {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String       @db.ObjectId
  orderId         String       @db.ObjectId
  patientId       String       @db.ObjectId

  itemDescription String
  storageLocation String?

  status          PickupStatus @default(AWAITING_PICKUP)

  // Reminders
  reminderCount   Int          @default(0)
  lastReminderAt  DateTime?
  nextReminderAt  DateTime?

  // Pickup
  pickedUpAt      DateTime?
  pickedUpBy      String?      // Name of person who picked up
  verifiedBy      String?      @db.ObjectId

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  clinic          Clinic       @relation(fields: [clinicId], references: [id])
  order           LabOrder     @relation(fields: [orderId], references: [id])
  patient         Patient      @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([orderId])
  @@index([patientId])
  @@index([status])
  @@map("patient_pickup_items")
}

/// ReorderReminder - Automatic reorder reminders for patients
model ReorderReminder {
  id                String                @id @default(auto()) @map("_id") @db.ObjectId
  clinicId          String                @db.ObjectId
  patientId         String                @db.ObjectId
  originalOrderId   String?               @db.ObjectId

  productCategory   LabProductCategory
  productName       String

  reminderType      LabReminderType       @default(SCHEDULED)
  scheduledFor      DateTime
  intervalMonths    Int?

  status            ReorderReminderStatus @default(PENDING)

  // Response tracking
  respondedAt       DateTime?
  response          String?
  newOrderId        String?               @db.ObjectId

  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  // Relations
  clinic            Clinic                @relation(fields: [clinicId], references: [id])
  patient           Patient               @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([scheduledFor])
  @@map("reorder_reminders")
}

/// OrderDueDateAlert - Alerts for order due dates
model OrderDueDateAlert {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String           @db.ObjectId
  orderId         String           @db.ObjectId

  alertType       DueDateAlertType
  severity        AlertSeverity    @default(WARNING)

  message         String
  dueDate         DateTime?
  appointmentId   String?          @db.ObjectId

  isResolved      Boolean          @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?          @db.ObjectId
  resolutionNotes String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  clinic          Clinic           @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([orderId])
  @@index([isResolved])
  @@index([severity])
  @@map("order_due_date_alerts")
}

// -----------------------------------------------------------------------------
// Order Tracking Enums
// -----------------------------------------------------------------------------

enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  EXCEPTION
  RETURNED
}

enum ShipmentEventSource {
  CARRIER_API
  MANUAL
  WEBHOOK
}

enum PickupStatus {
  AWAITING_PICKUP
  NOTIFIED
  REMINDED
  PICKED_UP
  RETURNED_TO_LAB
  DISCARDED
}

enum LabReminderType {
  SCHEDULED
  WARRANTY_EXPIRING
  REPLACEMENT_DUE
}

enum ReorderReminderStatus {
  PENDING
  SENT
  RESPONDED
  ORDERED
  DECLINED
  CANCELLED
}

enum DueDateAlertType {
  APPROACHING_DUE
  DUE_TODAY
  OVERDUE
  APPOINTMENT_AT_RISK
  SHIPMENT_DELAYED
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

// -----------------------------------------------------------------------------
// Quality & Remakes Models
// -----------------------------------------------------------------------------

/// LabInspection - Receiving inspection for lab items
model LabInspection {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String           @db.ObjectId
  orderId         String           @db.ObjectId
  orderItemId     String           @db.ObjectId

  result          InspectionResult @default(PENDING)

  // Checklist (JSON array)
  checklist       Json?

  notes           String?

  inspectedAt     DateTime?
  inspectedBy     String?          @db.ObjectId

  // Link to remake if failed
  remakeRequestId String?          @db.ObjectId

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  clinic          Clinic           @relation(fields: [clinicId], references: [id])
  order           LabOrder         @relation(fields: [orderId], references: [id])
  orderItem       LabOrderItem     @relation(fields: [orderItemId], references: [id])
  photos          InspectionPhoto[]

  @@index([clinicId])
  @@index([orderId])
  @@index([orderItemId])
  @@index([result])
  @@map("lab_inspections")
}

/// InspectionPhoto - Photo documentation for inspections
model InspectionPhoto {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  inspectionId    String        @db.ObjectId

  fileName        String
  storageKey      String
  description     String?

  createdAt       DateTime      @default(now())

  // Relations
  inspection      LabInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@map("inspection_photos")
}

/// RemakeRequest - Request to remake a lab item
model RemakeRequest {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  clinicId           String             @db.ObjectId
  originalOrderId    String             @db.ObjectId
  originalItemId     String             @db.ObjectId

  requestNumber      String             // Clinic-generated

  status             RemakeStatus       @default(REQUESTED)
  reason             RemakeReason
  reasonDetails      String?

  // Warranty
  isWarrantyClaim    Boolean            @default(false)
  warrantyId         String?            @db.ObjectId

  // Cost responsibility
  costResponsibility CostResponsibility @default(LAB)
  estimatedCost      Float?
  actualCost         Float?

  // Approval
  requiresApproval   Boolean            @default(false)
  approvedAt         DateTime?
  approvedBy         String?            @db.ObjectId

  // New order created
  newOrderId         String?            @db.ObjectId

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  requestedBy        String?            @db.ObjectId

  // Relations
  clinic             Clinic             @relation(fields: [clinicId], references: [id])
  originalItem       LabOrderItem       @relation(fields: [originalItemId], references: [id])

  @@unique([clinicId, requestNumber])
  @@index([clinicId])
  @@index([originalOrderId])
  @@index([originalItemId])
  @@index([status])
  @@map("remake_requests")
}

/// LabWarranty - Warranty tracking for lab items
model LabWarranty {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  orderItemId     String         @db.ObjectId

  startDate       DateTime
  endDate         DateTime
  warrantyMonths  Int

  status          WarrantyStatus @default(ACTIVE)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])
  orderItem       LabOrderItem   @relation(fields: [orderItemId], references: [id])
  claims          WarrantyClaim[]

  @@index([clinicId])
  @@index([orderItemId])
  @@index([status])
  @@index([endDate])
  @@map("lab_warranties")
}

/// WarrantyClaim - Claim against a warranty
model WarrantyClaim {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  warrantyId      String      @db.ObjectId
  remakeRequestId String?     @db.ObjectId

  claimDate       DateTime    @default(now())
  reason          String

  status          ClaimStatus @default(PENDING)
  approvedAt      DateTime?

  claimValue      Float?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  warranty        LabWarranty @relation(fields: [warrantyId], references: [id])

  @@index([warrantyId])
  @@index([status])
  @@map("warranty_claims")
}

/// QualityIssue - Logged quality issue
model QualityIssue {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String             @db.ObjectId
  vendorId        String             @db.ObjectId
  orderId         String?            @db.ObjectId
  orderItemId     String?            @db.ObjectId

  category        QualityCategory
  severity        IssueSeverity

  description     String
  status          QualityIssueStatus @default(OPEN)

  resolution      String?
  resolvedAt      DateTime?
  resolvedBy      String?            @db.ObjectId

  // Linked feedback
  feedbackSent    Boolean            @default(false)
  feedbackId      String?            @db.ObjectId

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  reportedBy      String?            @db.ObjectId

  // Relations
  clinic          Clinic             @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([vendorId])
  @@index([orderId])
  @@index([status])
  @@index([severity])
  @@map("quality_issues")
}

/// LabFeedback - Feedback sent to labs
model LabFeedback {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  vendorId        String         @db.ObjectId
  orderId         String?        @db.ObjectId
  qualityIssueId  String?        @db.ObjectId

  feedbackType    FeedbackType
  subject         String
  content         String

  status          FeedbackStatus @default(DRAFT)

  sentAt          DateTime?
  acknowledgedAt  DateTime?

  labResponse     String?
  respondedAt     DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId

  // Relations
  clinic          Clinic         @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([vendorId])
  @@index([orderId])
  @@index([status])
  @@map("lab_feedback")
}

// -----------------------------------------------------------------------------
// Quality & Remakes Enums
// -----------------------------------------------------------------------------

enum InspectionResult {
  PASS
  PASS_WITH_NOTES
  FAIL_REMAKE
  FAIL_ADJUSTMENT
  PENDING
}

enum RemakeStatus {
  REQUESTED
  ACKNOWLEDGED
  IN_PROGRESS
  SHIPPED
  RECEIVED
  INSPECTED
  COMPLETED
  CANCELLED
}

enum RemakeReason {
  FIT_ISSUE
  DESIGN_ISSUE
  MATERIAL_DEFECT
  SHIPPING_DAMAGE
  WRONG_PATIENT
  SPECIFICATION_ERROR
  OTHER
}

enum CostResponsibility {
  LAB
  CLINIC
  PATIENT
  WARRANTY
}

enum WarrantyStatus {
  ACTIVE
  EXPIRED
  CLAIMED
  VOIDED
}

enum ClaimStatus {
  PENDING
  APPROVED
  DENIED
  PROCESSED
}

enum QualityCategory {
  FIT
  APPEARANCE
  FUNCTION
  MATERIAL
  DESIGN
  LABELING
  SHIPPING
}

enum IssueSeverity {
  CRITICAL
  MAJOR
  MINOR
  COSMETIC
}

enum QualityIssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum FeedbackType {
  ISSUE_REPORT
  POSITIVE_FEEDBACK
  SUGGESTION
  QUESTION
}

enum FeedbackStatus {
  DRAFT
  SENT
  ACKNOWLEDGED
  RESPONDED
  CLOSED
}

// -----------------------------------------------------------------------------
// Lab Integrations Models
// -----------------------------------------------------------------------------

/// LabIntegration - External system integration configuration
model LabIntegration {
  id            String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId      String               @db.ObjectId

  type          LabIntegrationType
  name          String
  enabled       Boolean              @default(false)

  // Configuration (encrypted sensitive data)
  config        Json?

  // Status
  status        IntegrationStatus    @default(NOT_CONFIGURED)
  errorMessage  String?

  // Sync tracking
  lastSyncAt    DateTime?

  // Optional vendor association
  vendorId      String?              @db.ObjectId

  // Audit fields
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  createdBy     String?              @db.ObjectId
  updatedBy     String?              @db.ObjectId
  deletedAt     DateTime?
  deletedBy     String?              @db.ObjectId

  // Relations
  clinic        Clinic               @relation(fields: [clinicId], references: [id])
  vendor        LabVendor?           @relation(fields: [vendorId], references: [id])

  @@unique([clinicId, type])
  @@index([clinicId])
  @@index([type])
  @@index([status])
  @@map("lab_integrations")
}

enum LabIntegrationType {
  ITERO_SCANNER
  THREESHAPE_SCANNER
  CARESTREAM_SCANNER
  FEDEX_SHIPPING
  UPS_SHIPPING
  USPS_SHIPPING
  LAB_PORTAL
}

enum IntegrationStatus {
  NOT_CONFIGURED
  PENDING_SETUP
  PENDING_CONNECTION
  CONNECTED
  ERROR
  INACTIVE
}

// -----------------------------------------------------------------------------
// Autoclave Integration - Connection to physical autoclave equipment
// -----------------------------------------------------------------------------

/// AutoclaveIntegration - Configuration for connecting to autoclave HTTP APIs
model AutoclaveIntegration {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  clinicId      String            @db.ObjectId
  equipmentId   String            @db.ObjectId  // Link to Equipment model

  // Connection details
  name          String            // Display name: "Autoclave 1", "Statclave G4"
  ipAddress     String            // IP address: "192.168.0.82"
  port          Int               @default(80)

  // Status
  enabled       Boolean           @default(true)
  status        IntegrationStatus @default(NOT_CONFIGURED)
  errorMessage  String?

  // Sync tracking
  lastSyncAt    DateTime?
  lastCycleNum  Int?              // Last imported cycle number for incremental sync

  // Audit fields
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  createdBy     String?           @db.ObjectId
  updatedBy     String?           @db.ObjectId
  deletedAt     DateTime?         // Soft delete
  deletedBy     String?           @db.ObjectId

  // Relations
  clinic        Clinic            @relation(fields: [clinicId], references: [id])
  equipment     Equipment         @relation(fields: [equipmentId], references: [id])
  cycles        SterilizationCycle[] @relation("AutoclaveCycles")

  @@unique([clinicId, ipAddress])
  @@index([clinicId])
  @@index([equipmentId])
  @@index([status])
  @@map("autoclave_integrations")
}
