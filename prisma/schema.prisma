generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// =============================================================================
// AUTH AREA - Core authentication and authorization models
// =============================================================================

/// Clinic - Multi-tenant isolation unit
model Clinic {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String   @unique
  address   String?
  phone     String?
  email     String?
  timezone  String   @default("America/Toronto")
  settings  Json?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  patients        Patient[]
  roleAssignments RoleAssignment[]

  @@map("clinics")
}

/// User - System user account
model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  email          String    @unique
  emailVerified  DateTime?
  passwordHash   String?
  firstName      String
  lastName       String
  avatar         String?
  phone          String?
  role           UserRole  @default(clinical_staff)
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? // Soft delete

  // Multi-clinic support
  clinicId  String   @db.ObjectId   // Primary/current clinic
  clinicIds String[] @db.ObjectId   // All assigned clinics (for multi-clinic users)
  clinic    Clinic   @relation(fields: [clinicId], references: [id])

  // NextAuth.js relations
  accounts Account[]
  sessions Session[]

  // Role assignments (for fine-grained permissions)
  roleAssignments RoleAssignment[]

  // Audit trail
  createdBy String? @db.ObjectId
  updatedBy String? @db.ObjectId

  @@index([clinicId])
  @@map("users")
}

/// Account - OAuth provider accounts (NextAuth.js)
model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

/// Session - User sessions (NextAuth.js)
model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

/// VerificationToken - Email verification tokens (NextAuth.js)
model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Role - System and custom roles with permissions
model Role {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // Display name (e.g., "Clinic Administrator")
  code        String   @unique // System code (e.g., "clinic_admin")
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  permissions String[] // Array of permission codes (e.g., ["patients:read", "patients:write"])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Hierarchy fields
  level        Int      @default(0)    // 0 = base, higher = more senior (e.g., 10=staff, 20=manager, 30=admin)
  parentRoleId String?  @db.ObjectId   // Parent role for inheritance
  parentRole   Role?    @relation("RoleHierarchy", fields: [parentRoleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childRoles   Role[]   @relation("RoleHierarchy")

  // Relations
  assignments  RoleAssignment[]
  changeHistory RoleChangeHistory[]

  @@index([level])
  @@index([parentRoleId])
  @@map("roles")
}

/// RoleChangeHistory - Track changes to roles for audit and compliance
model RoleChangeHistory {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  roleId       String   @db.ObjectId

  // Change details
  changeType   String   // CREATE, UPDATE, DELETE, PERMISSIONS_ADDED, PERMISSIONS_REMOVED
  changeData   Json     // Stores before/after state or specific changes
  description  String?  // Human-readable description of the change

  // Who made the change
  changedById  String   @db.ObjectId
  changedByName String?

  // Timestamps
  changedAt    DateTime @default(now())

  // Relations
  role         Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([roleId])
  @@index([changedAt])
  @@index([changeType])
  @@map("role_change_history")
}

/// RoleAssignment - Links users to roles within specific clinics
model RoleAssignment {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  userId     String    @db.ObjectId
  roleId     String    @db.ObjectId
  clinicId   String    @db.ObjectId // Role applies to this clinic
  assignedBy String    @db.ObjectId
  assignedAt DateTime  @default(now())
  expiresAt  DateTime? // Optional expiration

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id])
  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([userId, roleId, clinicId])
  @@index([userId])
  @@index([clinicId])
  @@map("role_assignments")
}

/// AuditLog - Security and compliance audit trail
model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String?  @db.ObjectId
  userName   String?  // Denormalized for log readability
  userRole   String?  // Denormalized for log readability
  clinicId   String?  @db.ObjectId
  action     String   // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity     String   // Patient, Appointment, Invoice, etc.
  entityId   String?
  details    Json?    // Action-specific details
  ipAddress  String?
  userAgent  String?
  occurredAt DateTime @default(now())

  @@index([clinicId])
  @@index([userId])
  @@index([entity, entityId])
  @@index([occurredAt])
  @@index([action])
  @@map("audit_logs")
}

// =============================================================================
// PATIENT AREA - Patient records (placeholder for future implementation)
// =============================================================================

/// Patient - Patient records
model Patient {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  firstName   String
  lastName    String
  email       String?
  phone       String?
  dateOfBirth DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete for HIPAA compliance

  // Multi-clinic isolation
  clinicId String @db.ObjectId
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Audit trail
  createdBy String? @db.ObjectId
  updatedBy String? @db.ObjectId

  @@index([clinicId])
  @@index([lastName, firstName])
  @@map("patients")
}

// =============================================================================
// STAFF MANAGEMENT AREA - Staff profiles, credentials, certifications
// =============================================================================

/// StaffProfile - Extended profile for clinic staff members
model StaffProfile {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  userId           String?         @unique @db.ObjectId // Links to User account (optional - staff can exist before user account)
  employeeNumber   String          // Unique within clinic

  // Personal Information
  firstName        String
  lastName         String
  middleName       String?
  preferredName    String?
  email            String
  phone            String?
  mobilePhone      String?
  dateOfBirth      DateTime?
  address          String?
  city             String?
  state            String?
  postalCode       String?
  country          String          @default("CA")

  // Employment Information
  employmentType   EmploymentType  @default(FULL_TIME)
  status           StaffStatus     @default(ACTIVE)
  hireDate         DateTime
  terminationDate  DateTime?
  department       String?
  title            String?

  // Provider-Specific Fields (for clinical staff)
  isProvider       Boolean         @default(false)
  providerType     ProviderType?
  npiNumber        String?         // National Provider Identifier (10 digits)
  deaNumber        String?         // DEA registration number
  stateLicenseNumber String?

  // Work Preferences
  defaultClinicId  String?         @db.ObjectId
  clinicIds        String[]        @db.ObjectId // Assigned clinics
  notes            String?

  // Default Schedule Template
  defaultScheduleTemplateId String?           @db.ObjectId
  defaultScheduleTemplate   ScheduleTemplate? @relation("DefaultScheduleTemplate", fields: [defaultScheduleTemplateId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  // Timestamps and Audit
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?       // Soft delete
  createdBy        String?         @db.ObjectId
  updatedBy        String?         @db.ObjectId

  // Multi-clinic isolation (primary clinic for data isolation)
  clinicId         String          @db.ObjectId

  // Supervisor relationship
  supervisorId     String?         @db.ObjectId
  supervisor       StaffProfile?   @relation("SupervisorRelation", fields: [supervisorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  directReports    StaffProfile[]  @relation("SupervisorRelation")

  // Relations
  credentials      Credential[]
  certifications   Certification[]
  emergencyContacts EmergencyContact[]
  employmentRecords EmploymentRecord[]
  documents        StaffDocument[]
  shifts           StaffShift[]
  timeOffRequests  TimeOffRequest[]
  availability     StaffAvailability[]
  overtimeLogs     OvertimeLog[]
  ptoUsage         PTOUsage[]

  // Performance & Training Relations
  goals            StaffGoal[]
  performanceReviews PerformanceReview[]
  trainingRecords  TrainingRecord[]
  ceCredits        CECredit[]
  recognitions     Recognition[]
  performanceMetrics PerformanceMetric[]

  @@unique([clinicId, employeeNumber])
  @@index([clinicId])
  @@index([status])
  @@index([lastName, firstName])
  @@map("staff_profiles")
}

/// Credential - Provider licenses, registrations, and credentials
model Credential {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String           @db.ObjectId

  type             CredentialType
  name             String           // e.g., "State Dental License", "DEA Registration"
  number           String           // License/registration number
  issuingAuthority String           // e.g., "Ontario Dental Association"
  issuingState     String?          // State/province if applicable

  issueDate        DateTime
  expirationDate   DateTime?
  status           CredentialStatus @default(ACTIVE)

  // Verification
  verifiedAt       DateTime?
  verifiedBy       String?          @db.ObjectId
  verificationNotes String?

  // Document attachment
  documentUrl      String?

  // Timestamps
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdBy        String?          @db.ObjectId
  updatedBy        String?          @db.ObjectId

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  // Relations
  staffProfile     StaffProfile     @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([expirationDate])
  @@index([status])
  @@map("credentials")
}

/// Certification - Clinical certifications and training completions
model Certification {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String              @db.ObjectId

  type             CertificationType
  name             String              // e.g., "CPR/BLS Certification", "Invisalign Certified"
  issuingOrganization String           // e.g., "American Heart Association"

  issueDate        DateTime
  expirationDate   DateTime?
  status           CertificationStatus @default(ACTIVE)

  // Achievement details
  level            String?             // e.g., "Gold", "Platinum", "Level 2"
  score            String?             // If applicable

  // Document attachment
  certificateUrl   String?

  // Timestamps
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  createdBy        String?             @db.ObjectId
  updatedBy        String?             @db.ObjectId

  // Multi-clinic isolation
  clinicId         String              @db.ObjectId

  // Relations
  staffProfile     StaffProfile        @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([expirationDate])
  @@index([status])
  @@map("certifications")
}

/// EmergencyContact - Staff emergency contacts
model EmergencyContact {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId

  name             String
  relationship     String       // e.g., "Spouse", "Parent", "Sibling"
  phone            String
  alternatePhone   String?
  email            String?
  isPrimary        Boolean      @default(false)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  // Relations
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@map("emergency_contacts")
}

/// EmploymentRecord - Employment history and changes
model EmploymentRecord {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String         @db.ObjectId

  recordType       String         // HIRE, PROMOTION, TRANSFER, TERMINATION, STATUS_CHANGE, etc.
  effectiveDate    DateTime
  endDate          DateTime?

  // Position details
  previousTitle    String?
  newTitle         String?
  previousDepartment String?
  newDepartment    String?
  previousEmploymentType EmploymentType?
  newEmploymentType EmploymentType?
  previousStatus   StaffStatus?
  newStatus        StaffStatus?

  // Compensation (restricted - requires staff:compensation permission)
  previousSalary     Float?
  newSalary          Float?
  previousHourlyRate Float?
  newHourlyRate      Float?

  // Supervisor tracking
  supervisorId     String?        @db.ObjectId

  // Document attachments (links to StaffDocument)
  documentIds      String[]       @db.ObjectId

  // Additional details
  reason           String?        // Reason for change
  notes            String?
  approvedBy       String?        @db.ObjectId

  // Timestamps
  createdAt        DateTime       @default(now())
  createdBy        String?        @db.ObjectId

  // Multi-clinic isolation
  clinicId         String         @db.ObjectId

  // Relations
  staffProfile     StaffProfile   @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([effectiveDate])
  @@map("employment_records")
}

/// StaffDocument - HR documents and files
model StaffDocument {
  id               String              @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String              @db.ObjectId

  name             String              // Document name
  description      String?
  category         DocumentCategory    // CONTRACT, ID, TAX, MEDICAL, etc.
  fileUrl          String              // Storage URL
  fileName         String              // Original filename
  fileSize         Int?                // Size in bytes
  mimeType         String?

  accessLevel      DocumentAccessLevel @default(HR_ONLY)

  // Expiration tracking
  expirationDate   DateTime?           @db.Date
  expirationStatus DocumentExpirationStatus @default(ACTIVE)
  effectiveDate    DateTime?           @db.Date

  // Version history
  version          Int                 @default(1)
  previousVersionId String?            @db.ObjectId
  isCurrentVersion Boolean             @default(true)

  // Timestamps
  uploadedAt       DateTime            @default(now())
  uploadedBy       String?             @db.ObjectId

  // Multi-clinic isolation
  clinicId         String              @db.ObjectId

  // Relations
  staffProfile     StaffProfile        @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([staffProfileId])
  @@index([clinicId])
  @@index([category])
  @@index([expirationDate])
  @@index([expirationStatus])
  @@index([isCurrentVersion])
  @@map("staff_documents")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  super_admin
  clinic_admin
  doctor
  clinical_staff
  front_desk
  billing
  read_only
}

// Staff Management Enums
enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  PRN          // Pro re nata (as needed)
  TEMP
}

enum StaffStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  SUSPENDED
  PENDING      // Pending start
}

enum ProviderType {
  ORTHODONTIST
  GENERAL_DENTIST
  ORAL_SURGEON
  PERIODONTIST
  ENDODONTIST
  HYGIENIST
  DENTAL_ASSISTANT
  EFDA          // Expanded Function Dental Auxiliary
  OTHER
}

enum CredentialType {
  STATE_LICENSE
  DEA_REGISTRATION
  NPI
  BOARD_CERTIFICATION
  SPECIALTY_CERTIFICATION
  RADIOLOGY_LICENSE
  SEDATION_PERMIT
  CONTROLLED_SUBSTANCE
  OTHER
}

enum CredentialStatus {
  ACTIVE
  EXPIRED
  PENDING
  SUSPENDED
  REVOKED
  RENEWAL_PENDING
}

enum CertificationType {
  CPR_BLS
  ACLS
  PALS
  RADIOLOGY
  NITROUS_OXIDE
  LASER_CERTIFICATION
  INVISALIGN
  SURESMILE
  INCOGNITO
  DAMON
  INFECTION_CONTROL
  HIPAA
  OSHA
  OTHER
}

enum CertificationStatus {
  ACTIVE
  EXPIRED
  PENDING
  REVOKED
}

enum DocumentAccessLevel {
  PUBLIC
  STAFF_ONLY
  HR_ONLY
  MANAGEMENT
  CONFIDENTIAL
}

enum DocumentCategory {
  CONTRACT
  ID
  TAX
  MEDICAL
  BACKGROUND
  CERTIFICATION
  PERFORMANCE
  DISCIPLINARY
  OTHER
  // HR-specific document types
  NDA
  I9
  W4
  DIRECT_DEPOSIT
  HANDBOOK_ACKNOWLEDGMENT
  EMERGENCY_CONTACT_FORM
  BENEFITS_ENROLLMENT
  PIP
  WRITTEN_WARNING
  COMMENDATION
}

enum DocumentExpirationStatus {
  ACTIVE           // No expiration or not yet approaching
  EXPIRING_SOON    // Within 30 days of expiration
  EXPIRED          // Past expiration date
}

enum BlackoutType {
  BLOCKED          // Completely blocked - no requests allowed
  RESTRICTED       // Requires approval from higher authority
  WARNING          // Allowed but shows warning
}

// =============================================================================
// STAFF SCHEDULING & TIME MANAGEMENT
// =============================================================================

/// StaffShift - Individual work shifts for staff members
model StaffShift {
  id               String      @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String      @db.ObjectId

  // Shift Details
  shiftDate        DateTime    @db.Date
  startTime        DateTime    // Full datetime for the shift start
  endTime          DateTime    // Full datetime for the shift end
  breakMinutes     Int         @default(0)
  scheduledHours   Float       // Calculated hours (endTime - startTime - break)

  // Location
  locationId       String      @db.ObjectId  // Which clinic/location

  // Shift Type & Status
  shiftType        ShiftType   @default(REGULAR)
  status           ShiftStatus @default(SCHEDULED)

  // Actual Times (for time tracking / clock in-out)
  clockIn          DateTime?
  clockOut         DateTime?
  actualBreakMinutes Int?
  actualHours      Float?

  // Notes and metadata
  notes            String?
  color            String?     // For UI display

  // Template reference (if created from template)
  templateId       String?     @db.ObjectId

  // Timestamps and Audit
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  createdBy        String?     @db.ObjectId
  updatedBy        String?     @db.ObjectId

  // Multi-clinic isolation
  clinicId         String      @db.ObjectId

  // Relations
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([shiftDate])
  @@index([locationId])
  @@index([status])
  @@index([shiftType])
  @@map("staff_shifts")
}

/// TimeOffRequest - Staff time-off/leave requests
model TimeOffRequest {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String         @db.ObjectId

  // Request Details
  requestType      TimeOffType
  startDate        DateTime       @db.Date
  endDate          DateTime       @db.Date
  totalDays        Float          // Can be fractional for partial days
  totalHours       Float?

  // Partial Day Options
  isPartialDay     Boolean        @default(false)
  partialStartTime DateTime?
  partialEndTime   DateTime?

  // Status
  status           TimeOffStatus  @default(PENDING)

  // Reason and notes
  reason           String?
  notes            String?

  // Approval tracking
  reviewedBy       String?        @db.ObjectId
  reviewedAt       DateTime?
  approvalNotes    String?
  rejectionReason  String?

  // Coverage
  coverageRequired Boolean        @default(true)
  coverageStaffId  String?        @db.ObjectId
  coverageNotes    String?

  // Timestamps
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Multi-clinic isolation
  clinicId         String         @db.ObjectId

  // Relations
  staffProfile     StaffProfile   @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@index([requestType])
  @@map("time_off_requests")
}

/// ScheduleTemplate - Reusable schedule templates
model ScheduleTemplate {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId

  // Template Details
  name             String
  description      String?
  templateType     TemplateType     @default(STANDARD)
  periodType       TemplatePeriod   @default(WEEKLY)

  // Employment Type Association (for filtering templates by staff employment type)
  employmentType   EmploymentType?  // null = applies to any employment type

  // Scope (optional filters for when template applies)
  locationId       String?          @db.ObjectId  // null = all locations
  department       String?

  // Status
  isActive         Boolean          @default(true)
  isDefault        Boolean          @default(false)

  // Effective dates
  effectiveFrom    DateTime?
  effectiveUntil   DateTime?

  // Template Data - stored as JSON array of shift definitions
  shifts           Json             // Array of TemplateShiftData

  // Timestamps and Audit
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdBy        String?          @db.ObjectId
  updatedBy        String?          @db.ObjectId

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  // Relations
  staffWithDefault StaffProfile[]   @relation("DefaultScheduleTemplate")

  @@index([clinicId])
  @@index([templateType])
  @@index([isActive])
  @@index([employmentType])
  @@map("schedule_templates")
}

/// StaffAvailability - Staff availability preferences and blocks
model StaffAvailability {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String           @db.ObjectId

  // Availability Type
  availabilityType AvailabilityType
  isRecurring      Boolean          @default(false)

  // For Recurring availability (weekly pattern)
  dayOfWeek        Int?             // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime        String?          // "HH:mm" format
  endTime          String?          // "HH:mm" format

  // For Specific Date availability
  specificDate     DateTime?        @db.Date
  allDay           Boolean          @default(false)

  // Location Preference (optional)
  locationId       String?          @db.ObjectId

  // Effective Period (for recurring)
  effectiveFrom    DateTime?
  effectiveUntil   DateTime?

  // Notes
  reason           String?
  notes            String?

  // Status
  isActive         Boolean          @default(true)

  // Timestamps
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  // Relations
  staffProfile     StaffProfile     @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([dayOfWeek])
  @@index([specificDate])
  @@index([availabilityType])
  @@map("staff_availability")
}

/// CoverageRequirement - Minimum staffing requirements
model CoverageRequirement {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Requirement Details
  name             String
  description      String?

  // Location this applies to
  locationId       String       @db.ObjectId

  // Role/Department filter (optional)
  department       String?
  providerType     ProviderType?

  // Staffing Levels
  minimumStaff     Int
  optimalStaff     Int?
  maximumStaff     Int?

  // Time Period (when this requirement applies)
  dayOfWeek        Int?         // null = all days
  startTime        String?      // "HH:mm" - null = all hours
  endTime          String?      // "HH:mm"

  // Priority and importance
  priority         Int          @default(1)  // Higher = more important
  isCritical       Boolean      @default(false)

  // Status
  isActive         Boolean      @default(true)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([locationId])
  @@index([isActive])
  @@map("coverage_requirements")
}

/// ShiftSwapRequest - Shift swap/trade requests between staff
model ShiftSwapRequest {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Original Shift being swapped
  originalShiftId  String       @db.ObjectId
  requesterId      String       @db.ObjectId  // Staff requesting the swap

  // Swap Type
  swapType         SwapType

  // Target (for SWAP type - exchanging shifts)
  targetShiftId    String?      @db.ObjectId
  targetStaffId    String?      @db.ObjectId

  // Status
  status           SwapStatus   @default(PENDING)

  // Approval tracking
  targetAcceptedAt DateTime?    // When target staff accepted
  approvedBy       String?      @db.ObjectId
  approvedAt       DateTime?

  // Notes
  reason           String?
  notes            String?

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([originalShiftId])
  @@index([requesterId])
  @@index([status])
  @@map("shift_swap_requests")
}

/// OvertimeLog - Weekly overtime tracking
model OvertimeLog {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String         @db.ObjectId

  // Period
  weekStartDate    DateTime       @db.Date  // Monday of the week
  weekEndDate      DateTime       @db.Date  // Sunday of the week

  // Hours breakdown
  regularHours     Float
  overtimeHours    Float
  totalHours       Float

  // Status
  status           OvertimeStatus @default(PENDING)
  preApproved      Boolean        @default(false)

  // Approval tracking
  approvedBy       String?        @db.ObjectId
  approvedAt       DateTime?

  // Notes
  reason           String?
  notes            String?

  // Timestamps
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Multi-clinic isolation
  clinicId         String         @db.ObjectId

  // Relations
  staffProfile     StaffProfile   @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@unique([staffProfileId, weekStartDate])
  @@index([clinicId])
  @@index([staffProfileId])
  @@index([weekStartDate])
  @@index([status])
  @@map("overtime_logs")
}

// =============================================================================
// SCHEDULING ENUMS
// =============================================================================

enum ShiftType {
  REGULAR
  OVERTIME
  ON_CALL
  TRAINING
  MEETING
  COVERAGE     // Filling in for someone
  FLOAT        // Floating/flexible assignment
}

enum ShiftStatus {
  SCHEDULED    // Scheduled but not yet confirmed
  CONFIRMED    // Staff confirmed attendance
  IN_PROGRESS  // Currently working
  COMPLETED    // Shift completed
  CANCELLED    // Shift cancelled
  NO_SHOW      // Staff didn't show
  SWAP_PENDING // Pending swap approval
}

enum TimeOffType {
  VACATION
  SICK
  PERSONAL
  BEREAVEMENT
  JURY_DUTY
  MILITARY
  MATERNITY
  PATERNITY
  FMLA
  UNPAID
  CONTINUING_EDUCATION
  HOLIDAY
  OTHER
}

enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  WITHDRAWN
}

enum TemplateType {
  STANDARD       // Regular operating hours
  EXTENDED_HOURS // Extended/overtime coverage
  HOLIDAY        // Holiday schedule
  SEASONAL       // Seasonal variation
  CUSTOM         // Custom template
}

enum TemplatePeriod {
  DAILY
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum AvailabilityType {
  AVAILABLE      // Can work
  UNAVAILABLE    // Cannot work
  PREFERRED      // Prefers to work
  IF_NEEDED      // Available if needed
  BLOCKED        // System-blocked (leave, etc.)
}

enum SwapType {
  SWAP           // Exchange shifts with another staff
  GIVEAWAY       // Give shift to another staff
  PICKUP         // Pick up an open shift
}

enum SwapStatus {
  PENDING        // Awaiting target/approval
  ACCEPTED       // Target accepted, awaiting manager
  APPROVED       // Manager approved
  REJECTED       // Rejected
  CANCELLED      // Cancelled by requester
  COMPLETED      // Swap completed
}

enum OvertimeStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

// =============================================================================
// BLACKOUT DATES & PTO TRACKING
// =============================================================================

/// BlackoutDate - Dates when time-off requests are blocked/restricted
model BlackoutDate {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Blackout Details
  name             String       // e.g., "Holiday Season", "Staff Training Week"
  description      String?
  startDate        DateTime     @db.Date
  endDate          DateTime     @db.Date

  // Scope
  restrictionType  BlackoutType @default(BLOCKED)
  affectedRoles    String[]     // Empty = all roles, otherwise specific roles
  department       String?      // Optional department filter

  // Recurrence (for annual holidays)
  isRecurring      Boolean      @default(false)
  recurrencePattern String?     // e.g., "YEARLY" for annual holidays

  // Status
  isActive         Boolean      @default(true)

  // Timestamps and Audit
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createdBy        String?      @db.ObjectId
  updatedBy        String?      @db.ObjectId

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("blackout_dates")
}

/// PTOUsage - Track PTO usage per staff member per type per year (simple tracking, no limits)
model PTOUsage {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId

  // Period tracking
  year             Int          // Calendar year

  // Usage by type (in hours for flexibility)
  usageByType      Json         // { "VACATION": 40, "SICK": 8, ... }

  // Summary
  totalHoursUsed   Float        @default(0)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  // Relations
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  @@unique([staffProfileId, year])
  @@index([clinicId])
  @@index([staffProfileId])
  @@index([year])
  @@map("pto_usage")
}

// =============================================================================
// ROLE TEMPLATES - Industry-standard role templates
// =============================================================================

/// RoleTemplate - Predefined role templates for common healthcare roles
model RoleTemplate {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId

  // Template Details
  name             String       // e.g., "Front Desk Staff", "Clinical Assistant"
  code             String       @unique // e.g., "template_front_desk"
  description      String?
  category         String       // e.g., "Administrative", "Clinical", "Management"

  // Permissions
  permissions      String[]     // Default permissions for this template

  // Industry standard indicator
  isIndustryStandard Boolean    @default(false) // True for Orca-provided templates
  sourceVersion    String?      // Version of Orca that provided this template

  // Usage tracking
  usageCount       Int          @default(0) // How many times this template was used

  // Status
  isActive         Boolean      @default(true)

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("role_templates")
}

// =============================================================================
// PERFORMANCE & TRAINING - Staff performance and training tracking
// =============================================================================

/// PerformanceMetric - Track staff performance metrics
model PerformanceMetric {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Metric Details
  metricType       String       // e.g., "patient_satisfaction", "productivity", "attendance"
  metricName       String
  value            Float
  unit             String?      // e.g., "percent", "count", "rating"

  // Period
  periodStart      DateTime     @db.Date
  periodEnd        DateTime     @db.Date

  // Target (optional)
  targetValue      Float?
  targetMet        Boolean?

  // Notes
  notes            String?
  calculatedBy     String?      // "manual", "system", "integration"

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createdBy        String?      @db.ObjectId

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([metricType])
  @@index([periodStart])
  @@map("performance_metrics")
}

/// StaffGoal - Goal setting and tracking for staff
model StaffGoal {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Goal Details
  title            String
  description      String?
  category         String?      // e.g., "professional_development", "performance", "certification"

  // Timeline
  startDate        DateTime     @db.Date
  targetDate       DateTime     @db.Date
  completedDate    DateTime?    @db.Date

  // Status and Progress
  status           GoalStatus   @default(NOT_STARTED)
  progress         Int          @default(0) // 0-100 percent
  priority         Int          @default(2) // 1=low, 2=medium, 3=high

  // Milestones (stored as JSON)
  milestones       Json?        // Array of milestone objects

  // Notes
  notes            String?
  reviewNotes      String?

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createdBy        String?      @db.ObjectId

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([status])
  @@index([targetDate])
  @@map("staff_goals")
}

/// PerformanceReview - Performance review cycles
model PerformanceReview {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String        @db.ObjectId
  staffProfile     StaffProfile  @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Review Details
  reviewType       ReviewType
  reviewPeriodStart DateTime     @db.Date
  reviewPeriodEnd  DateTime      @db.Date
  reviewDate       DateTime?     @db.Date

  // Status
  status           ReviewStatus  @default(SCHEDULED)

  // Reviewer
  reviewerId       String?       @db.ObjectId
  reviewerName     String?

  // Ratings (stored as JSON for flexibility)
  ratings          Json?         // e.g., { "quality": 4, "teamwork": 5, ... }
  overallRating    Float?        // 1-5 scale

  // Feedback
  strengthsNotes   String?
  improvementNotes String?
  employeeComments String?

  // Goals from this review
  newGoals         Json?         // Goals set during review

  // Timestamps
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  completedAt      DateTime?

  // Multi-clinic isolation
  clinicId         String        @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([status])
  @@index([reviewDate])
  @@map("performance_reviews")
}

/// TrainingRecord - Track staff training and courses
model TrainingRecord {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String          @db.ObjectId
  staffProfile     StaffProfile    @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Training Details
  name             String
  description      String?
  category         String          // e.g., "compliance", "clinical", "software", "safety"
  provider         String?         // Training provider/vendor

  // Duration
  durationHours    Float?
  credits          Float?          // CE credits if applicable

  // Timeline
  assignedDate     DateTime?       @db.Date
  dueDate          DateTime?       @db.Date
  startedDate      DateTime?       @db.Date
  completedDate    DateTime?       @db.Date
  expirationDate   DateTime?       @db.Date

  // Status
  status           TrainingStatus  @default(ASSIGNED)
  score            Float?          // Test score if applicable
  passed           Boolean?

  // Certificate/Documentation
  certificateUrl   String?

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  createdBy        String?         @db.ObjectId

  // Multi-clinic isolation
  clinicId         String          @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([status])
  @@index([dueDate])
  @@index([expirationDate])
  @@map("training_records")
}

/// CECredit - Continuing Education credit tracking
model CECredit {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String       @db.ObjectId
  staffProfile     StaffProfile @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Credit Details
  courseName       String
  provider         String
  category         String       // e.g., "general", "specialty", "ethics"
  credits          Float
  creditType       String?      // e.g., "hours", "units"

  // Dates
  completionDate   DateTime     @db.Date
  reportingPeriodStart DateTime? @db.Date
  reportingPeriodEnd   DateTime? @db.Date

  // Verification
  certificateUrl   String?
  verificationCode String?
  isVerified       Boolean      @default(false)
  verifiedAt       DateTime?
  verifiedBy       String?      @db.ObjectId

  // Notes
  notes            String?

  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Multi-clinic isolation
  clinicId         String       @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([completionDate])
  @@index([category])
  @@map("ce_credits")
}

/// Recognition - Staff recognition and awards
model Recognition {
  id               String           @id @default(auto()) @map("_id") @db.ObjectId
  staffProfileId   String           @db.ObjectId
  staffProfile     StaffProfile     @relation(fields: [staffProfileId], references: [id], onDelete: Cascade)

  // Recognition Details
  type             RecognitionType
  title            String
  description      String?

  // Who gave the recognition
  givenById        String?          @db.ObjectId
  givenByName      String?
  isAnonymous      Boolean          @default(false)

  // Award details (if applicable)
  awardValue       Float?           // Monetary value if applicable
  awardDescription String?

  // Date
  recognitionDate  DateTime         @default(now())

  // Visibility
  isPublic         Boolean          @default(true) // Show on profile

  // Timestamps
  createdAt        DateTime         @default(now())

  // Multi-clinic isolation
  clinicId         String           @db.ObjectId

  @@index([clinicId])
  @@index([staffProfileId])
  @@index([type])
  @@index([recognitionDate])
  @@map("recognitions")
}

// =============================================================================
// PERFORMANCE & TRAINING ENUMS
// =============================================================================

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ReviewType {
  ANNUAL
  SEMI_ANNUAL
  QUARTERLY
  PROBATIONARY
  PERFORMANCE_IMPROVEMENT
  PROMOTION
  SPECIAL
}

enum ReviewStatus {
  SCHEDULED
  IN_PROGRESS
  PENDING_APPROVAL
  COMPLETED
  CANCELLED
}

enum TrainingStatus {
  ASSIGNED
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  OVERDUE
  WAIVED
}

enum RecognitionType {
  KUDOS
  EMPLOYEE_OF_MONTH
  YEARS_OF_SERVICE
  ACHIEVEMENT
  PEER_RECOGNITION
  PATIENT_COMPLIMENT
  OTHER
}

// =============================================================================
// RESOURCES MANAGEMENT AREA - Equipment, Rooms, Inventory, Sterilization
// =============================================================================

// -----------------------------------------------------------------------------
// Supplier - Shared model for equipment vendors and inventory suppliers
// -----------------------------------------------------------------------------

/// Supplier - Vendor/supplier for equipment and inventory
model Supplier {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Identification
  name            String
  code            String         // Unique supplier code within clinic
  accountNumber   String?        // Account number with supplier

  // Contact Information
  contactName     String?
  email           String?
  phone           String?
  fax             String?
  website         String?

  // Address
  address         String?
  city            String?
  state           String?
  postalCode      String?
  country         String?

  // Order Settings
  minimumOrder    Float?         // Minimum order amount
  freeShippingThreshold Float?   // Order amount for free shipping
  defaultLeadTimeDays Int        @default(7)
  orderMethod     SupplierOrderMethod @default(EMAIL)

  // Payment
  paymentTerms    String?        // e.g., "Net 30", "Due on Receipt"
  taxExempt       Boolean        @default(false)

  // Performance Tracking
  rating          Int?           // 1-5 stars
  onTimeDeliveryRate Float?      // Percentage of on-time deliveries

  // Status
  status          SupplierStatus @default(ACTIVE)
  isPreferred     Boolean        @default(false)

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment[]
  maintenanceRecords MaintenanceRecord[]
  repairRecords   RepairRecord[]

  @@unique([clinicId, code])
  @@index([clinicId])
  @@index([status])
  @@index([name])
  @@map("suppliers")
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  ON_HOLD
  BLOCKED
}

enum SupplierOrderMethod {
  EMAIL
  PORTAL
  PHONE
  FAX
  EDI
}

// -----------------------------------------------------------------------------
// Equipment Management - Equipment catalog, types, maintenance, repairs
// -----------------------------------------------------------------------------

/// EquipmentType - Categories and types of equipment with default settings
model EquipmentType {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String?        @db.ObjectId  // null for system-wide types

  // Type Information
  name            String         // e.g., "Intraoral Scanner", "CBCT Machine"
  code            String         // e.g., "INTRAORAL_SCANNER", unique per clinic
  category        EquipmentCategory
  description     String?

  // Default Maintenance Settings
  defaultMaintenanceIntervalDays Int?
  maintenanceChecklist String[]  // Default checklist items

  // Default Depreciation Settings
  defaultUsefulLifeMonths Int?
  defaultDepreciationMethod DepreciationMethod?

  // Status
  isSystem        Boolean        @default(false) // System types cannot be deleted
  isActive        Boolean        @default(true)

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment[]

  @@unique([clinicId, code])
  @@index([clinicId])
  @@index([category])
  @@index([isActive])
  @@map("equipment_types")
}

/// Equipment - Main equipment records
model Equipment {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Identification
  name            String         // e.g., "iTero Element 5D Scanner"
  equipmentNumber String         // Unique equipment ID (e.g., "EQ-2024-001")
  serialNumber    String?        // Manufacturer serial number
  modelNumber     String?        // Model number
  barcode         String?        // Barcode/QR code value

  // Classification
  typeId          String         @db.ObjectId
  category        EquipmentCategory
  manufacturer    String?

  // Location
  roomId          String?        @db.ObjectId  // Assigned room (optional)
  locationNotes   String?        // Additional location details

  // Status
  status          EquipmentStatus @default(ACTIVE)
  condition       EquipmentCondition @default(GOOD)

  // Purchase Information
  purchaseDate    DateTime?
  purchasePrice   Float?
  vendorId        String?        @db.ObjectId
  purchaseOrderNumber String?

  // Warranty Information
  warrantyStartDate DateTime?
  warrantyExpiry  DateTime?
  warrantyTerms   String?        // Coverage description
  warrantyNotes   String?
  hasExtendedWarranty Boolean    @default(false)
  extendedWarrantyExpiry DateTime?

  // Depreciation Settings
  usefulLifeMonths Int?
  salvageValue    Float?
  depreciationMethod DepreciationMethod @default(STRAIGHT_LINE)
  accumulatedDepreciation Float  @default(0)
  currentBookValue Float?
  monthlyDepreciation Float?
  isFullyDepreciated Boolean     @default(false)
  fullyDepreciatedDate DateTime?

  // Maintenance Settings
  maintenanceIntervalDays Int?
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?

  // Documents & Media
  manualUrl       String?        // Link to equipment manual
  photos          String[]       // Photo URLs
  specifications  Json?          // Technical specifications

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  type            EquipmentType  @relation(fields: [typeId], references: [id])
  vendor          Supplier?      @relation(fields: [vendorId], references: [id])
  maintenanceRecords MaintenanceRecord[]
  repairRecords   RepairRecord[]

  @@unique([clinicId, equipmentNumber])
  @@index([clinicId])
  @@index([typeId])
  @@index([category])
  @@index([status])
  @@index([roomId])
  @@index([serialNumber])
  @@index([barcode])
  @@index([nextMaintenanceDate])
  @@map("equipment")
}

enum EquipmentCategory {
  DIAGNOSTIC      // Scanners, X-ray, CBCT
  TREATMENT       // Curing lights, bracket tools
  DIGITAL         // 3D printers, milling machines
  CHAIR           // Dental chairs, delivery units
  STERILIZATION   // Autoclaves, cleaners
  SAFETY          // AEDs, fire extinguishers
  OTHER
}

enum EquipmentStatus {
  ACTIVE          // In normal operation
  IN_REPAIR       // Currently being repaired
  OUT_OF_SERVICE  // Temporarily unavailable
  RETIRED         // No longer in use but retained
  DISPOSED        // Removed from inventory
}

enum EquipmentCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum DepreciationMethod {
  STRAIGHT_LINE      // (Cost - Salvage) / Useful Life
  DECLINING_BALANCE  // Double declining balance
  NONE               // No depreciation (minor items)
}

// -----------------------------------------------------------------------------
// Maintenance Records - Scheduled and completed maintenance activities
// -----------------------------------------------------------------------------

/// MaintenanceRecord - Maintenance activities for equipment
model MaintenanceRecord {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  equipmentId     String         @db.ObjectId

  // Maintenance Details
  maintenanceType MaintenanceType
  scheduledDate   DateTime?      // When maintenance was/is scheduled
  completedDate   DateTime?      // When actually completed
  status          MaintenanceStatus @default(SCHEDULED)

  // Work Performed
  description     String?        // Description of work to be done/done
  checklist       Json?          // Completed checklist items with status
  notes           String?        // Additional notes

  // Performer Information
  performedBy     String?        // Internal staff name or "Vendor"
  performedById   String?        @db.ObjectId  // Staff ID if internal
  vendorId        String?        @db.ObjectId  // Vendor if external
  technicianName  String?        // Technician name (for vendor service)

  // Costs
  laborCost       Float?
  partsCost       Float?
  totalCost       Float?

  // Next Maintenance
  nextMaintenanceDate DateTime?

  // Documents
  attachments     String[]       // URLs to attached documents

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment      @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  vendor          Supplier?      @relation(fields: [vendorId], references: [id])

  @@index([clinicId])
  @@index([equipmentId])
  @@index([status])
  @@index([scheduledDate])
  @@index([maintenanceType])
  @@map("maintenance_records")
}

enum MaintenanceType {
  PREVENTIVE      // Routine preventive maintenance
  CALIBRATION     // Equipment calibration
  INSPECTION      // Safety/compliance inspection
  CLEANING        // Deep cleaning
  CERTIFICATION   // Annual certification/validation
  OTHER
}

enum MaintenanceStatus {
  SCHEDULED       // Scheduled but not started
  IN_PROGRESS     // Currently being performed
  COMPLETED       // Successfully completed
  CANCELLED       // Cancelled
  OVERDUE         // Past scheduled date, not completed
}

// -----------------------------------------------------------------------------
// Repair Records - Equipment repairs and service calls
// -----------------------------------------------------------------------------

/// RepairRecord - Repair and service history for equipment
model RepairRecord {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  equipmentId     String         @db.ObjectId

  // Issue Details
  reportedDate    DateTime       @default(now())
  reportedById    String         @db.ObjectId  // Staff who reported
  issueDescription String        // Description of the problem
  severity        RepairSeverity @default(MEDIUM)

  // Status Tracking
  status          RepairStatus   @default(REPORTED)
  scheduledDate   DateTime?      // When repair is scheduled
  completedDate   DateTime?      // When repair was completed

  // Diagnosis & Resolution
  diagnosis       String?        // What was found to be wrong
  workPerformed   String?        // Description of repair work
  partsReplaced   String[]       // List of parts replaced
  resolutionNotes String?        // Additional resolution notes

  // Vendor/Service Information
  vendorId        String?        @db.ObjectId
  technicianName  String?
  serviceTicketNumber String?    // Vendor's ticket/case number

  // Costs
  laborCost       Float?
  partsCost       Float?
  travelCost      Float?
  totalCost       Float?

  // Warranty Coverage
  coveredByWarranty Boolean      @default(false)
  warrantyClaimNumber String?

  // Downtime Tracking
  equipmentDownStart DateTime?   // When equipment became unavailable
  equipmentDownEnd DateTime?     // When equipment returned to service

  // Documents
  attachments     String[]       // URLs to attached documents/photos

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  equipment       Equipment      @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  vendor          Supplier?      @relation(fields: [vendorId], references: [id])

  @@index([clinicId])
  @@index([equipmentId])
  @@index([status])
  @@index([reportedDate])
  @@index([severity])
  @@map("repair_records")
}

enum RepairSeverity {
  LOW             // Minor issue, can wait
  MEDIUM          // Should be addressed soon
  HIGH            // Urgent, affects operations
  CRITICAL        // Equipment unusable, immediate action
}

enum RepairStatus {
  REPORTED        // Issue reported, not yet reviewed
  DIAGNOSED       // Problem identified
  AWAITING_PARTS  // Waiting for replacement parts
  SCHEDULED       // Repair scheduled
  IN_PROGRESS     // Repair underway
  COMPLETED       // Repair finished
  CANNOT_REPAIR   // Equipment cannot be repaired
  CANCELLED       // Repair cancelled
}

// -----------------------------------------------------------------------------
// Room/Chair Management - Operatories, treatment chairs, and equipment assignments
// -----------------------------------------------------------------------------

/// Room - Treatment rooms/operatories in the clinic
model Room {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId

  // Identification
  name            String         // e.g., "Operatory 1", "Consultation Room A"
  roomNumber      String         // Unique within clinic (e.g., "OP-1", "CONSULT-A")

  // Classification
  roomType        RoomType

  // Physical details
  floor           String?        // e.g., "1st Floor", "Basement"
  wing            String?        // e.g., "East Wing", "Main"
  squareFeet      Int?
  capacity        Int            @default(1) // Max patients/occupants

  // Status
  status          RoomStatus     @default(ACTIVE)
  isAvailable     Boolean        @default(true)

  // Capabilities - what procedures can be performed here
  capabilities    String[]       // e.g., ["ORTHO", "X_RAY", "SCANNING", "CONSULTATION"]

  // Configuration notes
  setupNotes      String?        // Setup instructions for this room
  notes           String?        // General notes

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  chairs          TreatmentChair[]
  roomEquipment   RoomEquipment[]

  @@unique([clinicId, roomNumber])
  @@index([clinicId])
  @@index([roomType])
  @@index([status])
  @@map("rooms")
}

enum RoomType {
  OPERATORY       // Treatment operatory with chair
  CONSULTATION    // Consultation/exam room
  X_RAY           // X-ray/imaging room
  STERILIZATION   // Sterilization area
  LAB             // In-house lab
  STORAGE         // Storage room
  RECEPTION       // Reception/waiting area
  OFFICE          // Office/admin space
}

enum RoomStatus {
  ACTIVE          // In normal operation
  MAINTENANCE     // Under maintenance
  CLOSED          // Temporarily closed
  RENOVATION      // Under renovation
}

/// TreatmentChair - Dental/treatment chairs within rooms
model TreatmentChair {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  roomId          String         @db.ObjectId

  // Identification
  name            String         // e.g., "Chair 1", "Primary Chair"
  chairNumber     String         // Unique within clinic (e.g., "CH-001")

  // Equipment details
  manufacturer    String?
  modelNumber     String?
  serialNumber    String?

  // Status
  status          ChairStatus    @default(ACTIVE)
  condition       EquipmentCondition @default(GOOD)

  // Features and capabilities
  features        String[]       // e.g., ["PROGRAMMABLE", "HEATED", "MASSAGE"]
  hasDeliveryUnit Boolean        @default(true)
  hasSuction      Boolean        @default(true)
  hasLight        Boolean        @default(true)

  // Purchase/warranty info
  purchaseDate    DateTime?
  warrantyExpiry  DateTime?

  // Maintenance
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?      // Soft delete
  createdBy       String?        @db.ObjectId
  updatedBy       String?        @db.ObjectId

  // Relations
  room            Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([clinicId, chairNumber])
  @@index([clinicId])
  @@index([roomId])
  @@index([status])
  @@map("treatment_chairs")
}

enum ChairStatus {
  ACTIVE          // In normal operation
  IN_REPAIR       // Currently being repaired
  OUT_OF_SERVICE  // Temporarily unavailable
  RETIRED         // No longer in use
}

/// RoomEquipment - Equipment assigned to rooms (many-to-many with history)
model RoomEquipment {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String         @db.ObjectId
  roomId          String         @db.ObjectId
  equipmentId     String         @db.ObjectId

  // Assignment details
  assignedDate    DateTime       @default(now())
  unassignedDate  DateTime?      // null = currently assigned
  isPermanent     Boolean        @default(true)  // Permanent vs temporary assignment

  // Position/location within room
  position        String?        // e.g., "Left wall", "Near window"

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.ObjectId

  // Relations
  room            Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([roomId])
  @@index([equipmentId])
  @@index([unassignedDate])
  @@map("room_equipment")
}

// -----------------------------------------------------------------------------
// Sterilization & Compliance - Cycle tracking, indicators, compliance logs
// -----------------------------------------------------------------------------

/// SterilizationCycle - Individual autoclave/sterilizer run records
model SterilizationCycle {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Equipment - link to sterilization equipment (autoclave, etc.)
  equipmentId     String               @db.ObjectId

  // Cycle identification
  cycleNumber     String               // Unique cycle number (e.g., "CYC-2024-001")

  // Cycle details
  cycleType       SterilizationCycleType
  startTime       DateTime
  endTime         DateTime?

  // Process parameters
  temperature     Float?               // Temperature in Celsius
  pressure        Float?               // Pressure in PSI
  exposureTime    Int?                 // Exposure time in minutes
  dryingTime      Int?                 // Drying time in minutes

  // Results
  status          CycleStatus          @default(IN_PROGRESS)
  mechanicalPass  Boolean?             // Mechanical indicator result
  chemicalPass    Boolean?             // Chemical indicator result
  biologicalPass  Boolean?             // Biological indicator result (spore test)

  // Operator info
  operatorId      String               @db.ObjectId
  verifiedById    String?              @db.ObjectId
  verifiedAt      DateTime?

  // Notes
  notes           String?
  failureReason   String?              // If cycle failed

  // Timestamps & Audit
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  createdBy       String?              @db.ObjectId
  updatedBy       String?              @db.ObjectId

  // Relations
  loads           SterilizationLoad[]
  biologicalIndicators BiologicalIndicator[]
  chemicalIndicators   ChemicalIndicator[]

  @@unique([clinicId, cycleNumber])
  @@index([clinicId])
  @@index([equipmentId])
  @@index([status])
  @@index([startTime])
  @@index([operatorId])
  @@map("sterilization_cycles")
}

enum SterilizationCycleType {
  STEAM_GRAVITY    // Gravity steam sterilization (standard)
  STEAM_PREVACUUM  // Pre-vacuum steam sterilization
  STEAM_FLASH      // Flash/immediate use sterilization
  CHEMICAL         // Chemical sterilization (e.g., ethylene oxide)
  DRY_HEAT         // Dry heat sterilization
  VALIDATION       // Validation/test cycle
}

enum CycleStatus {
  IN_PROGRESS      // Cycle currently running
  COMPLETED        // Cycle completed successfully
  FAILED           // Cycle failed (parameters not met)
  ABORTED          // Cycle aborted by operator
  VOID             // Cycle voided (record-keeping error)
}

/// SterilizationLoad - Items processed in each cycle
model SterilizationLoad {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId
  cycleId         String               @db.ObjectId

  // Load identification
  loadNumber      Int                  // Position/number in load (1, 2, 3, etc.)

  // Item details
  itemType        LoadItemType
  itemDescription String               // Description of item(s)
  quantity        Int                  @default(1)

  // Instrument pack/set tracking (if applicable)
  instrumentSetId String?              @db.ObjectId
  packBarcode     String?              // Pack/pouch barcode

  // Position in sterilizer
  position        String?              // e.g., "Top rack", "Middle shelf"

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  cycle           SterilizationCycle   @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([cycleId])
  @@index([instrumentSetId])
  @@index([packBarcode])
  @@map("sterilization_loads")
}

enum LoadItemType {
  INSTRUMENT_PACK  // Wrapped instrument set/pack
  INSTRUMENT_SET   // Unwrapped instrument set
  HANDPIECE        // Dental handpiece
  BUR_BLOCK        // Bur block/holder
  IMPLANT_KIT      // Implant surgical kit
  ORTHODONTIC_TRAY // Orthodontic instrument tray
  LOOSE_ITEMS      // Individual loose instruments
  OTHER
}

/// BiologicalIndicator - Spore test results for cycle validation
model BiologicalIndicator {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId
  cycleId         String?              @db.ObjectId  // Can be independent test

  // Indicator identification
  lotNumber       String               // Manufacturer lot number
  brand           String?              // e.g., "3M Attest", "Mesa Labs"

  // Testing info
  testDate        DateTime             // When test was started
  readDate        DateTime?            // When result was read
  incubationHours Int?                 // Hours incubated

  // Results
  result          BiologicalTestResult @default(PENDING)
  controlPassed   Boolean?             // Control vial passed (grew)

  // Reader info (if using rapid reader)
  readerType      String?              // e.g., "3M Attest 490", "Manual incubator"
  readerId        String?              // Reader serial/ID

  // Performed by
  performedById   String               @db.ObjectId
  readById        String?              @db.ObjectId

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  cycle           SterilizationCycle?  @relation(fields: [cycleId], references: [id], onDelete: SetNull)

  @@index([clinicId])
  @@index([cycleId])
  @@index([testDate])
  @@index([result])
  @@index([lotNumber])
  @@map("biological_indicators")
}

enum BiologicalTestResult {
  PENDING          // Incubating, awaiting results
  PASSED           // Negative (no growth) - sterilization effective
  FAILED           // Positive (growth) - sterilization NOT effective
  INCONCLUSIVE     // Control failed or invalid result
}

/// ChemicalIndicator - Chemical indicator strip/tape results
model ChemicalIndicator {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId
  cycleId         String               @db.ObjectId

  // Indicator type
  indicatorClass  ChemicalIndicatorClass
  indicatorType   String?              // Brand/type description

  // Location in load
  loadPosition    String?              // Where indicator was placed

  // Results
  result          ChemicalIndicatorResult
  colorChange     String?              // Description of color change

  // Performed by
  performedById   String               @db.ObjectId

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  cycle           SterilizationCycle   @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([cycleId])
  @@index([result])
  @@map("chemical_indicators")
}

enum ChemicalIndicatorClass {
  CLASS_1          // Process indicators (autoclave tape) - exposure only
  CLASS_2          // Bowie-Dick test indicators (air removal)
  CLASS_3          // Single-parameter indicators
  CLASS_4          // Multi-parameter indicators
  CLASS_5          // Integrating indicators (simulate BI)
  CLASS_6          // Emulating indicators (specific cycle)
}

enum ChemicalIndicatorResult {
  PASSED           // Color change complete/acceptable
  FAILED           // Color change incomplete/unacceptable
  INCONCLUSIVE     // Unable to determine
}

/// InstrumentSet - Reusable instrument packs/sets for tracking
model InstrumentSet {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Identification
  name            String               // e.g., "Ortho Bonding Set A"
  setNumber       String               // Unique set ID (e.g., "SET-001")
  barcode         String?              // Barcode for scanning

  // Contents
  description     String?              // Contents description
  instrumentCount Int                  // Number of instruments in set

  // Category
  category        InstrumentSetCategory

  // Status
  status          InstrumentSetStatus  @default(AVAILABLE)
  currentLocation String?              // Current location/room

  // Tracking
  lastSterilizedAt DateTime?
  lastUsedAt      DateTime?
  useCount        Int                  @default(0)
  sterilizationCount Int               @default(0)

  // Lifecycle
  assemblyDate    DateTime?            // When set was assembled
  expirationDays  Int?                 // How many days after sterilization set expires
  maxUses         Int?                 // Maximum uses before replacement

  // Notes
  notes           String?

  // Timestamps & Audit
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?            // Soft delete
  createdBy       String?              @db.ObjectId
  updatedBy       String?              @db.ObjectId

  @@unique([clinicId, setNumber])
  @@index([clinicId])
  @@index([status])
  @@index([category])
  @@index([barcode])
  @@map("instrument_sets")
}

enum InstrumentSetCategory {
  ORTHODONTIC      // Ortho-specific instruments
  BONDING          // Bracket bonding instruments
  DEBONDING        // Bracket removal instruments
  ADJUSTMENT       // Wire adjustment tools
  IMPRESSION       // Impression instruments
  SURGICAL         // Minor surgical instruments
  GENERAL          // General dental instruments
  HYGIENE          // Hygiene instruments
  OTHER
}

enum InstrumentSetStatus {
  AVAILABLE        // Sterile and ready for use
  IN_USE           // Currently being used
  DIRTY            // Used, awaiting sterilization
  PROCESSING       // In sterilization process
  QUARANTINE       // Awaiting biological indicator results
  MAINTENANCE      // Under repair/inspection
  RETIRED          // No longer in service
}

/// ComplianceLog - Regulatory compliance documentation
model ComplianceLog {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  clinicId        String               @db.ObjectId

  // Log identification
  logType         ComplianceLogType
  logDate         DateTime             @default(now())

  // Reference (what this log is about)
  referenceType   String?              // e.g., "SterilizationCycle", "BiologicalIndicator"
  referenceId     String?              @db.ObjectId

  // Details
  title           String
  description     String?
  action          String?              // What action was taken
  outcome         String?              // Result/outcome

  // Compliance status
  isCompliant     Boolean              @default(true)
  deficiencyFound Boolean              @default(false)
  correctiveAction String?             // Corrective action taken

  // Performed by
  performedById   String               @db.ObjectId
  reviewedById    String?              @db.ObjectId
  reviewedAt      DateTime?

  // Attachments
  attachments     String[]             // URLs to attached documents

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([clinicId])
  @@index([logType])
  @@index([logDate])
  @@index([isCompliant])
  @@map("compliance_logs")
}

enum ComplianceLogType {
  WEEKLY_BI_TEST   // Weekly biological indicator test
  MONTHLY_AUDIT    // Monthly sterilization audit
  EQUIPMENT_VALIDATION // Sterilizer validation/certification
  INCIDENT_REPORT  // Sterilization failure or incident
  CORRECTIVE_ACTION // Corrective action documentation
  TRAINING_RECORD  // Staff training documentation
  INSPECTION       // External inspection record
  POLICY_REVIEW    // Policy/procedure review
  OTHER
}
